var kn=Object.defineProperty;var vn=(e,t,n)=>t in e?kn(e,t,{enumerable:!0,configurable:!0,writable:!0,value:n}):e[t]=n;var le=(e,t,n)=>vn(e,typeof t!="symbol"?t+"":t,n);(function(){const t=document.createElement("link").relList;if(t&&t.supports&&t.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();class Dt{unwrap(t,n){const i=this._chain(r=>L.ok(t?t(r):r),r=>n?L.ok(n(r)):L.err(r));if(i.isErr)throw i.error;return i.value}map(t,n){return this._chain(i=>L.ok(t(i)),i=>L.err(n?n(i):i))}chain(t,n){return this._chain(t,n||(i=>L.err(i)))}}class yn extends Dt{constructor(t){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=t}_chain(t,n){return t(this.value)}}class Cn extends Dt{constructor(t){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=t}_chain(t,n){return n(this.error)}}var L;(function(e){e.ok=function(t){return new yn(t)},e.err=function(t){return new Cn(t||new Error)},e.all=function(t){if(Array.isArray(t)){const r=[];for(let o=0;o<t.length;o++){const s=t[o];if(s.isErr)return s;r.push(s.value)}return e.ok(r)}const n={},i=Object.keys(t);for(let r=0;r<i.length;r++){const o=t[i[r]];if(o.isErr)return o;n[i[r]]=o.value}return e.ok(n)}})(L||(L={}));const ut=e=>(e=e-(e>>>1&1431655765),e=(e&858993459)+(e>>>2&858993459),Math.imul(e+(e>>>4)&252645135,16843009)>>24),ze=e=>(e=e>>>8&16711935|(e&16711935)<<8,e>>>16&65535|(e&65535)<<16),ft=e=>(e=e>>>1&1431655765|(e&1431655765)<<1,e=e>>>2&858993459|(e&858993459)<<2,e=e>>>4&252645135|(e&252645135)<<4,ze(e));class f{constructor(t,n){this.lo=t|0,this.hi=n|0}static fromSquare(t){return t>=32?new f(0,1<<t-32):new f(1<<t,0)}static fromRank(t){return new f(255,0).shl64(8*t)}static fromFile(t){return new f(16843009<<t,16843009<<t)}static empty(){return new f(0,0)}static full(){return new f(4294967295,4294967295)}static corners(){return new f(129,2164260864)}static center(){return new f(402653184,24)}static backranks(){return new f(255,4278190080)}static backrank(t){return t==="white"?new f(255,0):new f(0,4278190080)}static lightSquares(){return new f(1437226410,1437226410)}static darkSquares(){return new f(2857740885,2857740885)}complement(){return new f(~this.lo,~this.hi)}xor(t){return new f(this.lo^t.lo,this.hi^t.hi)}union(t){return new f(this.lo|t.lo,this.hi|t.hi)}intersect(t){return new f(this.lo&t.lo,this.hi&t.hi)}diff(t){return new f(this.lo&~t.lo,this.hi&~t.hi)}intersects(t){return this.intersect(t).nonEmpty()}isDisjoint(t){return this.intersect(t).isEmpty()}supersetOf(t){return t.diff(this).isEmpty()}subsetOf(t){return this.diff(t).isEmpty()}shr64(t){return t>=64?f.empty():t>=32?new f(this.hi>>>t-32,0):t>0?new f(this.lo>>>t^this.hi<<32-t,this.hi>>>t):this}shl64(t){return t>=64?f.empty():t>=32?new f(0,this.lo<<t-32):t>0?new f(this.lo<<t,this.hi<<t^this.lo>>>32-t):this}bswap64(){return new f(ze(this.hi),ze(this.lo))}rbit64(){return new f(ft(this.hi),ft(this.lo))}minus64(t){const n=this.lo-t.lo,i=(n&t.lo&1)+(t.lo>>>1)+(n>>>1)>>>31;return new f(n,this.hi-(t.hi+i))}equals(t){return this.lo===t.lo&&this.hi===t.hi}size(){return ut(this.lo)+ut(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(t){return(t>=32?this.hi&1<<t-32:this.lo&1<<t)!==0}set(t,n){return n?this.with(t):this.without(t)}with(t){return t>=32?new f(this.lo,this.hi|1<<t-32):new f(this.lo|1<<t,this.hi)}without(t){return t>=32?new f(this.lo,this.hi&~(1<<t-32)):new f(this.lo&~(1<<t),this.hi)}toggle(t){return t>=32?new f(this.lo,this.hi^1<<t-32):new f(this.lo^1<<t,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new f(this.lo&this.lo-1,this.hi):new f(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let t=this.lo,n=this.hi;for(;t!==0;){const i=31-Math.clz32(t&-t);t^=1<<i,yield i}for(;n!==0;){const i=31-Math.clz32(n&-n);n^=1<<i,yield 32+i}}*reversed(){let t=this.lo,n=this.hi;for(;n!==0;){const i=31-Math.clz32(n);n^=1<<i,yield 32+i}for(;t!==0;){const i=31-Math.clz32(t);t^=1<<i,yield i}}}const Nt=["a","b","c","d","e","f","g","h"],Pn=["1","2","3","4","5","6","7","8"],ce=["white","black"],ke=["pawn","knight","bishop","rook","queen","king"],Sn=["a","h"],Be=e=>"role"in e,R=e=>e!==void 0,N=e=>e==="white"?"black":"white",me=e=>e>>3,Z=e=>e&7,Mn=(e,t)=>0<=e&&e<8&&0<=t&&t<8?e+8*t:void 0,Lt=e=>{switch(e){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function dt(e){switch(e.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function ve(e){if(e.length===2)return Mn(e.charCodeAt(0)-97,e.charCodeAt(1)-49)}const Ie=e=>Nt[Z(e)]+Pn[me(e)],An=e=>{if(e[1]==="@"&&e.length===4){const t=dt(e[0]),n=ve(e.slice(2));if(t&&R(n))return{role:t,to:n}}else if(e.length===4||e.length===5){const t=ve(e.slice(0,2)),n=ve(e.slice(2,4));let i;if(e.length===5&&(i=dt(e[4]),!i))return;if(R(t)&&R(n))return{from:t,to:n,promotion:i}}},Je=(e,t)=>e==="white"?t==="a"?2:6:t==="a"?58:62,Ve=(e,t)=>e==="white"?t==="a"?3:5:t==="a"?59:61,Ce=(e,t)=>{let n=f.empty();for(const i of t){const r=e+i;0<=r&&r<64&&Math.abs(Z(e)-Z(r))<=2&&(n=n.with(r))}return n},X=e=>{const t=[];for(let n=0;n<64;n++)t[n]=e(n);return t},En=X(e=>Ce(e,[-9,-8,-7,-1,1,7,8,9])),xn=X(e=>Ce(e,[-17,-15,-10,-6,6,10,15,17])),Rn={white:X(e=>Ce(e,[7,9])),black:X(e=>Ce(e,[-7,-9]))},_t=e=>En[e],Kt=e=>xn[e],De=(e,t)=>Rn[e][t],He=X(e=>f.fromFile(Z(e)).without(e)),We=X(e=>f.fromRank(me(e)).without(e)),je=X(e=>{const t=new f(134480385,2151686160),n=8*(me(e)-Z(e));return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),qe=X(e=>{const t=new f(270549120,16909320),n=8*(me(e)+Z(e)-7);return(n>=0?t.shl64(n):t.shr64(-n)).without(e)}),Ge=(e,t,n)=>{let i=n.intersect(t),r=i.bswap64();return i=i.minus64(e),r=r.minus64(e.bswap64()),i.xor(r.bswap64()).intersect(t)},On=(e,t)=>Ge(f.fromSquare(e),He[e],t),Tn=(e,t)=>{const n=We[e];let i=t.intersect(n),r=i.rbit64();return i=i.minus64(f.fromSquare(e)),r=r.minus64(f.fromSquare(63-e)),i.xor(r.rbit64()).intersect(n)},Pe=(e,t)=>{const n=f.fromSquare(e);return Ge(n,je[e],t).xor(Ge(n,qe[e],t))},Se=(e,t)=>On(e,t).xor(Tn(e,t)),Dn=(e,t)=>Pe(e,t).xor(Se(e,t)),$t=(e,t)=>{const n=f.fromSquare(t);return We[e].intersects(n)?We[e].with(e):qe[e].intersects(n)?qe[e].with(e):je[e].intersects(n)?je[e].with(e):He[e].intersects(n)?He[e].with(e):f.empty()},de=(e,t)=>$t(e,t).intersect(f.full().shl64(e).xor(f.full().shl64(t))).withoutFirst();class oe{constructor(){}static default(){const t=new oe;return t.reset(),t}reset(){this.occupied=new f(65535,4294901760),this.promoted=f.empty(),this.white=new f(65535,0),this.black=new f(0,4294901760),this.pawn=new f(65280,16711680),this.knight=new f(66,1107296256),this.bishop=new f(36,603979776),this.rook=new f(129,2164260864),this.queen=new f(8,134217728),this.king=new f(16,268435456)}static empty(){const t=new oe;return t.clear(),t}clear(){this.occupied=f.empty(),this.promoted=f.empty();for(const t of ce)this[t]=f.empty();for(const t of ke)this[t]=f.empty()}clone(){const t=new oe;t.occupied=this.occupied,t.promoted=this.promoted;for(const n of ce)t[n]=this[n];for(const n of ke)t[n]=this[n];return t}getColor(t){if(this.white.has(t))return"white";if(this.black.has(t))return"black"}getRole(t){for(const n of ke)if(this[n].has(t))return n}get(t){const n=this.getColor(t);if(!n)return;const i=this.getRole(t),r=this.promoted.has(t);return{color:n,role:i,promoted:r}}take(t){const n=this.get(t);return n&&(this.occupied=this.occupied.without(t),this[n.color]=this[n.color].without(t),this[n.role]=this[n.role].without(t),n.promoted&&(this.promoted=this.promoted.without(t))),n}set(t,n){const i=this.take(t);return this.occupied=this.occupied.with(t),this[n.color]=this[n.color].with(t),this[n.role]=this[n.role].with(t),n.promoted&&(this.promoted=this.promoted.with(t)),i}has(t){return this.occupied.has(t)}*[Symbol.iterator](){for(const t of this.occupied)yield[t,this.get(t)]}pieces(t,n){return this[t].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(t){return this.pieces(t,"king").singleSquare()}}var U;(function(e){e.Empty="ERR_EMPTY",e.OppositeCheck="ERR_OPPOSITE_CHECK",e.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",e.Kings="ERR_KINGS",e.Variant="ERR_VARIANT"})(U||(U={}));class re extends Error{}const Nn=(e,t,n,i)=>n[t].intersect(Se(e,i).intersect(n.rooksAndQueens()).union(Pe(e,i).intersect(n.bishopsAndQueens())).union(Kt(e).intersect(n.knight)).union(_t(e).intersect(n.king)).union(De(N(t),e).intersect(n.pawn)));class V{constructor(){}static default(){const t=new V;return t.castlingRights=f.corners(),t.rook={white:{a:0,h:7},black:{a:56,h:63}},t.path={white:{a:new f(14,0),h:new f(96,0)},black:{a:new f(0,234881024),h:new f(0,1610612736)}},t}static empty(){const t=new V;return t.castlingRights=f.empty(),t.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},t.path={white:{a:f.empty(),h:f.empty()},black:{a:f.empty(),h:f.empty()}},t}clone(){const t=new V;return t.castlingRights=this.castlingRights,t.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},t.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},t}add(t,n,i,r){const o=Je(t,n),s=Ve(t,n);this.castlingRights=this.castlingRights.with(r),this.rook[t][n]=r,this.path[t][n]=de(r,s).with(s).union(de(i,o).with(o)).without(i).without(r)}static fromSetup(t){const n=V.empty(),i=t.castlingRights.intersect(t.board.rook);for(const r of ce){const o=f.backrank(r),s=t.board.kingOf(r);if(!R(s)||!o.has(s))continue;const c=i.intersect(t.board[r]).intersect(o),d=c.first();R(d)&&d<s&&n.add(r,"a",s,d);const a=c.last();R(a)&&s<a&&n.add(r,"h",s,a)}return n}discardRook(t){if(this.castlingRights.has(t)){this.castlingRights=this.castlingRights.without(t);for(const n of ce)for(const i of Sn)this.rook[n][i]===t&&(this.rook[n][i]=void 0)}}discardColor(t){this.castlingRights=this.castlingRights.diff(f.backrank(t)),this.rook[t].a=void 0,this.rook[t].h=void 0}}class Ln{constructor(t){this.rules=t}reset(){this.board=oe.default(),this.pockets=void 0,this.turn="white",this.castles=V.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(t){this.board=t.board.clone(),this.board.promoted=f.empty(),this.pockets=void 0,this.turn=t.turn,this.castles=V.fromSetup(t),this.epSquare=Kn(this,t.epSquare),this.remainingChecks=void 0,this.halfmoves=t.halfmoves,this.fullmoves=t.fullmoves}kingAttackers(t,n,i){return Nn(t,n,this.board,i)}playCaptureAt(t,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(t),this.pockets&&this.pockets[N(n.color)][n.promoted?"pawn":n.role]++}ctx(){const t=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!R(n))return{king:n,blockers:f.empty(),checkers:f.empty(),variantEnd:t,mustCapture:!1};const i=Se(n,f.empty()).intersect(this.board.rooksAndQueens()).union(Pe(n,f.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[N(this.turn)]);let r=f.empty();for(const s of i){const c=de(n,s).intersect(this.board.occupied);c.moreThanOne()||(r=r.union(c))}const o=this.kingAttackers(n,N(this.turn),this.board.occupied);return{king:n,blockers:r,checkers:o,variantEnd:t,mustCapture:!1}}clone(){var t,n;const i=new this.constructor;return i.board=this.board.clone(),i.pockets=(t=this.pockets)===null||t===void 0?void 0:t.clone(),i.turn=this.turn,i.castles=this.castles.clone(),i.epSquare=this.epSquare,i.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),i.halfmoves=this.halfmoves,i.fullmoves=this.fullmoves,i}validate(){if(this.board.occupied.isEmpty())return L.err(new re(U.Empty));if(this.board.king.size()!==2)return L.err(new re(U.Kings));if(!R(this.board.kingOf(this.turn)))return L.err(new re(U.Kings));const t=this.board.kingOf(N(this.turn));return R(t)?this.kingAttackers(t,this.turn,this.board.occupied).nonEmpty()?L.err(new re(U.OppositeCheck)):f.backranks().intersects(this.board.pawn)?L.err(new re(U.PawnsOnBackrank)):L.ok(void 0):L.err(new re(U.Kings))}dropDests(t){return f.empty()}dests(t,n){if(n=n||this.ctx(),n.variantEnd)return f.empty();const i=this.board.get(t);if(!i||i.color!==this.turn)return f.empty();let r,o;if(i.role==="pawn"){r=De(this.turn,t).intersect(this.board[N(this.turn)]);const s=this.turn==="white"?8:-8,c=t+s;if(0<=c&&c<64&&!this.board.occupied.has(c)){r=r.with(c);const d=this.turn==="white"?t<16:t>=48,a=c+s;d&&!this.board.occupied.has(a)&&(r=r.with(a))}R(this.epSquare)&&Fn(this,t,n)&&(o=f.fromSquare(this.epSquare))}else i.role==="bishop"?r=Pe(t,this.board.occupied):i.role==="knight"?r=Kt(t):i.role==="rook"?r=Se(t,this.board.occupied):i.role==="queen"?r=Dn(t,this.board.occupied):r=_t(t);if(r=r.diff(this.board[this.turn]),R(n.king)){if(i.role==="king"){const s=this.board.occupied.without(t);for(const c of r)this.kingAttackers(c,N(this.turn),s).nonEmpty()&&(r=r.without(c));return r.union(ht(this,"a",n)).union(ht(this,"h",n))}if(n.checkers.nonEmpty()){const s=n.checkers.singleSquare();if(!R(s))return f.empty();r=r.intersect(de(s,n.king).with(s))}n.blockers.has(t)&&(r=r.intersect($t(t,n.king)))}return o&&(r=r.union(o)),r}isVariantEnd(){return!1}variantOutcome(t){}hasInsufficientMaterial(t){return this.board[t].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[t].intersects(this.board.knight)?this.board[t].size()<=2&&this.board[N(t)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[t].intersects(this.board.bishop)?(!this.board.bishop.intersects(f.darkSquares())||!this.board.bishop.intersects(f.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var t,n;return{board:this.board.clone(),pockets:(t=this.pockets)===null||t===void 0?void 0:t.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:$n(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return ce.every(t=>this.hasInsufficientMaterial(t))}hasDests(t){t=t||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,t).nonEmpty())return!0;return this.dropDests(t).nonEmpty()}isLegal(t,n){if(Be(t))return!this.pockets||this.pockets[this.turn][t.role]<=0||t.role==="pawn"&&f.backranks().has(t.to)?!1:this.dropDests(n).has(t.to);{if(t.promotion==="pawn"||t.promotion==="king"&&this.rules!=="antichess"||!!t.promotion!==(this.board.pawn.has(t.from)&&f.backranks().has(t.to)))return!1;const i=this.dests(t.from,n);return i.has(t.to)||i.has(zn(this,t).to)}}isCheck(){const t=this.board.kingOf(this.turn);return R(t)&&this.kingAttackers(t,N(this.turn),this.board.occupied).nonEmpty()}isEnd(t){return(t?t.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(t)}isCheckmate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.nonEmpty()&&!this.hasDests(t)}isStalemate(t){return t=t||this.ctx(),!t.variantEnd&&t.checkers.isEmpty()&&!this.hasDests(t)}outcome(t){const n=this.variantOutcome(t);return n||(t=t||this.ctx(),this.isCheckmate(t)?{winner:N(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(t)?{winner:void 0}:void 0)}allDests(t){t=t||this.ctx();const n=new Map;if(t.variantEnd)return n;for(const i of this.board[this.turn])n.set(i,this.dests(i,t));return n}play(t){const n=this.turn,i=this.epSquare,r=Ft(this,t);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=N(n),Be(t))this.board.set(t.to,{role:t.role,color:n}),this.pockets&&this.pockets[n][t.role]--,t.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(t.from);if(!o)return;let s;if(o.role==="pawn"){this.halfmoves=0,t.to===i&&(s=this.board.take(t.to+(n==="white"?-8:8)));const c=t.from-t.to;Math.abs(c)===16&&8<=t.from&&t.from<=55&&(this.epSquare=t.from+t.to>>1),t.promotion&&(o.role=t.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(t.from);else if(o.role==="king"){if(r){const c=this.castles.rook[n][r];if(R(c)){const d=this.board.take(c);this.board.set(Je(n,r),o),d&&this.board.set(Ve(n,r),d)}}this.castles.discardColor(n)}if(!r){const c=this.board.set(t.to,o)||s;c&&this.playCaptureAt(t.to,c)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}}class _n extends Ln{constructor(){super("chess")}static default(){const t=new this;return t.reset(),t}static fromSetup(t){const n=new this;return n.setupUnchecked(t),n.validate().map(i=>n)}clone(){return super.clone()}}const Kn=(e,t)=>{if(!R(t))return;const n=e.turn==="white"?5:2,i=e.turn==="white"?8:-8;if(me(t)!==n||e.board.occupied.has(t+i))return;const r=t-i;if(!(!e.board.pawn.has(r)||!e.board[N(e.turn)].has(r)))return t},$n=e=>{if(!R(e.epSquare))return;const t=e.ctx(),i=e.board.pieces(e.turn,"pawn").intersect(De(N(e.turn),e.epSquare));for(const r of i)if(e.dests(r,t).has(e.epSquare))return e.epSquare},Fn=(e,t,n)=>{if(!R(e.epSquare)||!De(e.turn,t).has(e.epSquare))return!1;if(!R(n.king))return!0;const i=e.turn==="white"?8:-8,r=e.epSquare-i;return e.kingAttackers(n.king,N(e.turn),e.board.occupied.toggle(t).toggle(r).with(e.epSquare)).without(r).isEmpty()},ht=(e,t,n)=>{if(!R(n.king)||n.checkers.nonEmpty())return f.empty();const i=e.castles.rook[e.turn][t];if(!R(i)||e.castles.path[e.turn][t].intersects(e.board.occupied))return f.empty();const r=Je(e.turn,t),o=de(n.king,r),s=e.board.occupied.without(n.king);for(const a of o)if(e.kingAttackers(a,N(e.turn),s).nonEmpty())return f.empty();const c=Ve(e.turn,t),d=e.board.occupied.toggle(n.king).toggle(i).toggle(c);return e.kingAttackers(r,N(e.turn),d).nonEmpty()?f.empty():f.fromSquare(i)},Ft=(e,t)=>{if(Be(t))return;const n=t.to-t.from;if(!(Math.abs(n)!==2&&!e.board[e.turn].has(t.to))&&e.board.king.has(t.from))return n>0?"h":"a"},zn=(e,t)=>{const n=Ft(e,t);if(!n)return t;const i=e.castles.rook[e.turn][n];return{from:t.from,to:R(i)?i:t.to}},Bn=()=>({board:oe.default(),pockets:void 0,turn:"white",castlingRights:f.corners(),epSquare:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:1});var pt;(function(e){e.Fen="ERR_FEN",e.Board="ERR_BOARD",e.Pockets="ERR_POCKETS",e.Turn="ERR_TURN",e.Castling="ERR_CASTLING",e.EpSquare="ERR_EP_SQUARE",e.RemainingChecks="ERR_REMAINING_CHECKS",e.Halfmoves="ERR_HALFMOVES",e.Fullmoves="ERR_FULLMOVES"})(pt||(pt={}));const In=e=>{let t=Lt(e.role);return e.color==="white"&&(t=t.toUpperCase()),e.promoted&&(t+="~"),t},Hn=e=>{let t="",n=0;for(let i=7;i>=0;i--)for(let r=0;r<8;r++){const o=r+i*8,s=e.get(o);s?(n>0&&(t+=n,n=0),t+=In(s)):n++,r===7&&(n>0&&(t+=n,n=0),i!==0&&(t+="/"))}return t},mt=e=>ke.map(t=>Lt(t).repeat(e[t])).join(""),Wn=e=>mt(e.white).toUpperCase()+mt(e.black),jn=(e,t)=>{let n="";for(const i of ce){const r=f.backrank(i);let o=e.kingOf(i);R(o)&&!r.has(o)&&(o=void 0);const s=e.pieces(i,"rook").intersect(r);for(const c of t.intersect(r).reversed())if(c===s.first()&&R(o)&&c<o)n+=i==="white"?"Q":"q";else if(c===s.last()&&R(o)&&o<c)n+=i==="white"?"K":"k";else{const d=Nt[Z(c)];n+=i==="white"?d.toUpperCase():d}}return n||"-"},qn=e=>`${e.white}+${e.black}`,Gn=(e,t)=>[Hn(e.board)+(e.pockets?`[${Wn(e.pockets)}]`:""),e.turn[0],jn(e.board,e.castlingRights),R(e.epSquare)?Ie(e.epSquare):"-",...e.remainingChecks?[qn(e.remainingChecks)]:[],Math.max(0,Math.min(e.halfmoves,9999)),Math.max(1,Math.min(e.fullmoves,9999))].join(" "),gt=(e,t)=>{const n=new Map,i=e.ctx();for(const[r,o]of e.allDests(i))if(o.nonEmpty()){const s=Array.from(o,Ie);r===i.king&&Z(r)===4&&(o.has(0)?s.push("c1"):o.has(56)&&s.push("c8"),o.has(7)?s.push("g1"):o.has(63)&&s.push("g8")),n.set(Ie(r),s)}return n};class Un{constructor(t){le(this,"ground");le(this,"div");le(this,"pos");le(this,"promotion");this.redraw=t,this.pos=_n.fromSetup(Bn()).unwrap(),this.promotion=null}setGround(t){this.ground=t}cgState(){const t=this;return{movable:{free:!1,dests:gt(t.pos),events:{after(n,i,r){t.handleMove(n,i)}}}}}handleMove(t,n){const i=`${t}${n}`,r=An(i);if(!r)return;const o=this.ground.state.pieces.get(n);if(o){if(this.isPromotion(n,o)){this.handlePromotion(n,o,r);return}this.handleEnPassant(t,n),this.makeMove(r)}}isPromotion(t,n){return n.role=="pawn"&&(n.color=="white"&&t[1]=="8"||n.color=="black"&&t[1]=="1")}handlePromotion(t,n,i){this.promptPromotion(t,n.color).then(r=>{r!==void 0?this.applyPromotion(t,n,r,i):this.resetToPreviousPosition(),this.updateLegalMoves()})}async promptPromotion(t,n){const i=await new Promise(r=>{this.promotion={dest:t,color:n,resolve:r},this.redraw()});return this.promotion=null,this.redraw(),i}applyPromotion(t,n,i,r){"promotion"in r&&(r.promotion=i,n.role=i,n.promoted=!0,this.ground.setPieces(new Map([[t,n]])),this.pos.play(r))}resetToPreviousPosition(){this.ground.set({fen:Gn(this.pos.toSetup())})}handleEnPassant(t,n){const i=this.getEnPassantCaptureSquare(t,n,r=>this.pos.board.get(ve(r)));i&&this.ground.setPieces(new Map([[i,void 0]]))}getEnPassantCaptureSquare(t,n,i){const r=i(t);if(!r||r.role!=="pawn")return;const o=t.charCodeAt(0),s=n.charCodeAt(0);if(Math.abs(o-s)===1&&i(n)===void 0){const c=parseInt(n[1]),d=r.color==="white"?c-1:c+1;return String.fromCharCode(s)+d}}makeMove(t){this.pos.play(t),this.updateLegalMoves()}updateLegalMoves(){this.ground.set({movable:{dests:gt(this.pos)}})}}const Zn=["white","black"],Me=["a","b","c","d","e","f","g","h"],Ae=["1","2","3","4","5","6","7","8"],Xn=[...Ae].reverse(),et=Array.prototype.concat(...Me.map(e=>Ae.map(t=>e+t))),z=e=>et[8*e[0]+e[1]],O=e=>[e.charCodeAt(0)-97,e.charCodeAt(1)-49],zt=et.map(O);function Yn(e){let t;const n=()=>(t===void 0&&(t=e()),t);return n.clear=()=>{t=void 0},n}const Qn=()=>{let e;return{start(){e=performance.now()},cancel(){e=void 0},stop(){if(!e)return 0;const t=performance.now()-e;return e=void 0,t}}},tt=e=>e==="white"?"black":"white",he=(e,t)=>{const n=e[0]-t[0],i=e[1]-t[1];return n*n+i*i},Ue=(e,t)=>e.role===t.role&&e.color===t.color,ge=e=>(t,n)=>[(n?t[0]:7-t[0])*e.width/8,(n?7-t[1]:t[1])*e.height/8],H=(e,t)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px)`},Bt=(e,t,n=1)=>{e.style.transform=`translate(${t[0]}px,${t[1]}px) scale(${n})`},nt=(e,t)=>{e.style.visibility=t?"visible":"hidden"},ne=e=>{var t;if(e.clientX||e.clientX===0)return[e.clientX,e.clientY];if(!((t=e.targetTouches)===null||t===void 0)&&t[0])return[e.targetTouches[0].clientX,e.targetTouches[0].clientY]},It=e=>e.button===2,j=(e,t)=>{const n=document.createElement(e);return t&&(n.className=t),n};function Ht(e,t,n){const i=O(e);return t||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const te=(e,t)=>Math.abs(e-t),Jn=e=>(t,n,i,r)=>te(t,i)<2&&(e==="white"?r===n+1||n<=1&&r===n+2&&t===i:r===n-1||n>=6&&r===n-2&&t===i),Wt=(e,t,n,i)=>{const r=te(e,n),o=te(t,i);return r===1&&o===2||r===2&&o===1},jt=(e,t,n,i)=>te(e,n)===te(t,i),qt=(e,t,n,i)=>e===n||t===i,Gt=(e,t,n,i)=>jt(e,t,n,i)||qt(e,t,n,i),Vn=(e,t,n)=>(i,r,o,s)=>te(i,o)<2&&te(r,s)<2||n&&r===s&&r===(e==="white"?0:7)&&(i===4&&(o===2&&t.includes(0)||o===6&&t.includes(7))||t.includes(o));function ei(e,t){const n=t==="white"?"1":"8",i=[];for(const[r,o]of e)r[1]===n&&o.color===t&&o.role==="rook"&&i.push(O(r)[0]);return i}function Ut(e,t,n){const i=e.get(t);if(!i)return[];const r=O(t),o=i.role,s=o==="pawn"?Jn(i.color):o==="knight"?Wt:o==="bishop"?jt:o==="rook"?qt:o==="queen"?Gt:Vn(i.color,ei(e,i.color),n);return zt.filter(c=>(r[0]!==c[0]||r[1]!==c[1])&&s(r[0],r[1],c[0],c[1])).map(z)}function $(e,...t){e&&setTimeout(()=>e(...t),1)}function ti(e){e.orientation=tt(e.orientation),e.animation.current=e.draggable.current=e.selected=void 0}function ni(e,t){for(const[n,i]of t)i?e.pieces.set(n,i):e.pieces.delete(n)}function ii(e,t){if(e.check=void 0,t===!0&&(t=e.turnColor),t)for(const[n,i]of e.pieces)i.role==="king"&&i.color===t&&(e.check=n)}function ri(e,t,n,i){Q(e),e.premovable.current=[t,n],$(e.premovable.events.set,t,n,i)}function Y(e){e.premovable.current&&(e.premovable.current=void 0,$(e.premovable.events.unset))}function oi(e,t,n){Y(e),e.predroppable.current={role:t,key:n},$(e.predroppable.events.set,t,n)}function Q(e){const t=e.predroppable;t.current&&(t.current=void 0,$(t.events.unset))}function si(e,t,n){if(!e.autoCastle)return!1;const i=e.pieces.get(t);if(!i||i.role!=="king")return!1;const r=O(t),o=O(n);if(r[1]!==0&&r[1]!==7||r[1]!==o[1])return!1;r[0]===4&&!e.pieces.has(n)&&(o[0]===6?n=z([7,o[1]]):o[0]===2&&(n=z([0,o[1]])));const s=e.pieces.get(n);return!s||s.color!==i.color||s.role!=="rook"?!1:(e.pieces.delete(t),e.pieces.delete(n),r[0]<o[0]?(e.pieces.set(z([6,o[1]]),i),e.pieces.set(z([5,o[1]]),s)):(e.pieces.set(z([2,o[1]]),i),e.pieces.set(z([3,o[1]]),s)),!0)}function Zt(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);if(t===n||!i)return!1;const o=r&&r.color!==i.color?r:void 0;return n===e.selected&&B(e),$(e.events.move,t,n,o),si(e,t,n)||(e.pieces.set(n,i),e.pieces.delete(t)),e.lastMove=[t,n],e.check=void 0,$(e.events.change),o||!0}function it(e,t,n,i){if(e.pieces.has(n))if(i)e.pieces.delete(n);else return!1;return $(e.events.dropNewPiece,t,n),e.pieces.set(n,t),e.lastMove=[n],e.check=void 0,$(e.events.change),e.movable.dests=void 0,e.turnColor=tt(e.turnColor),!0}function Xt(e,t,n){const i=Zt(e,t,n);return i&&(e.movable.dests=void 0,e.turnColor=tt(e.turnColor),e.animation.current=void 0),i}function Yt(e,t,n){if(rt(e,t,n)){const i=Xt(e,t,n);if(i){const r=e.hold.stop();B(e);const o={premove:!1,ctrlKey:e.stats.ctrlKey,holdTime:r};return i!==!0&&(o.captured=i),$(e.movable.events.after,t,n,o),!0}}else if(li(e,t,n))return ri(e,t,n,{ctrlKey:e.stats.ctrlKey}),B(e),!0;return B(e),!1}function Qt(e,t,n,i){const r=e.pieces.get(t);r&&(ci(e,t,n)||i)?(e.pieces.delete(t),it(e,r,n,i),$(e.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&ai(e,t,n)?oi(e,r.role,n):(Y(e),Q(e)),e.pieces.delete(t),B(e)}function Ze(e,t,n){if($(e.events.select,t),e.selected){if(e.selected===t&&!e.draggable.enabled){B(e),e.hold.cancel();return}else if((e.selectable.enabled||n)&&e.selected!==t&&Yt(e,e.selected,t)){e.stats.dragged=!1;return}}(e.selectable.enabled||e.draggable.enabled)&&(Vt(e,t)||ot(e,t))&&(Jt(e,t),e.hold.start())}function Jt(e,t){e.selected=t,ot(e,t)?e.premovable.customDests||(e.premovable.dests=Ut(e.pieces,t,e.premovable.castle)):e.premovable.dests=void 0}function B(e){e.selected=void 0,e.premovable.dests=void 0,e.hold.cancel()}function Vt(e,t){const n=e.pieces.get(t);return!!n&&(e.movable.color==="both"||e.movable.color===n.color&&e.turnColor===n.color)}const rt=(e,t,n)=>{var i,r;return t!==n&&Vt(e,t)&&(e.movable.free||!!(!((r=(i=e.movable.dests)===null||i===void 0?void 0:i.get(t))===null||r===void 0)&&r.includes(n)))};function ci(e,t,n){const i=e.pieces.get(t);return!!i&&(t===n||!e.pieces.has(n))&&(e.movable.color==="both"||e.movable.color===i.color&&e.turnColor===i.color)}function ot(e,t){const n=e.pieces.get(t);return!!n&&e.premovable.enabled&&e.movable.color===n.color&&e.turnColor!==n.color}function li(e,t,n){var i,r;const o=(r=(i=e.premovable.customDests)===null||i===void 0?void 0:i.get(t))!==null&&r!==void 0?r:Ut(e.pieces,t,e.premovable.castle);return t!==n&&ot(e,t)&&o.includes(n)}function ai(e,t,n){const i=e.pieces.get(t),r=e.pieces.get(n);return!!i&&(!r||r.color!==e.movable.color)&&e.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&e.movable.color===i.color&&e.turnColor!==i.color}function ui(e,t){const n=e.pieces.get(t);return!!n&&e.draggable.enabled&&(e.movable.color==="both"||e.movable.color===n.color&&(e.turnColor===n.color||e.premovable.enabled))}function fi(e){const t=e.premovable.current;if(!t)return!1;const n=t[0],i=t[1];let r=!1;if(rt(e,n,i)){const o=Xt(e,n,i);if(o){const s={premove:!0};o!==!0&&(s.captured=o),$(e.movable.events.after,n,i,s),r=!0}}return Y(e),r}function di(e,t){const n=e.predroppable.current;let i=!1;if(!n)return!1;if(t(n)){const r={role:n.role,color:e.movable.color};it(e,r,n.key)&&($(e.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return Q(e),i}function st(e){Y(e),Q(e),B(e)}function bt(e){e.movable.color=e.movable.dests=e.animation.current=void 0,st(e)}function ie(e,t,n){let i=Math.floor(8*(e[0]-n.left)/n.width);t||(i=7-i);let r=7-Math.floor(8*(e[1]-n.top)/n.height);return t||(r=7-r),i>=0&&i<8&&r>=0&&r<8?z([i,r]):void 0}function hi(e,t,n,i){const r=O(e),o=zt.filter(a=>Gt(r[0],r[1],a[0],a[1])||Wt(r[0],r[1],a[0],a[1])),c=o.map(a=>Ht(z(a),n,i)).map(a=>he(t,a)),[,d]=c.reduce((a,b,h)=>a[0]<b?a:[b,h],[c[0],0]);return z(o[d])}const F=e=>e.orientation==="white",en="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",pi={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},mi={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function tn(e){e==="start"&&(e=en);const t=new Map;let n=7,i=0;for(const r of e)switch(r){case" ":case"[":return t;case"/":if(--n,n<0)return t;i=0;break;case"~":{const o=t.get(z([i-1,n]));o&&(o.promoted=!0);break}default:{const o=r.charCodeAt(0);if(o<57)i+=o-48;else{const s=r.toLowerCase();t.set(z([i,n]),{role:pi[s],color:r===s?"black":"white"}),++i}}}return t}function gi(e){return Xn.map(t=>Me.map(n=>{const i=e.get(n+t);if(i){let r=mi[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,t=>t.length.toString())}function nn(e,t){t.animation&&(ct(e.animation,t.animation),(e.animation.duration||0)<70&&(e.animation.enabled=!1))}function rn(e,t){var n,i,r;if(!((n=t.movable)===null||n===void 0)&&n.dests&&(e.movable.dests=void 0),!((i=t.drawable)===null||i===void 0)&&i.autoShapes&&(e.drawable.autoShapes=[]),ct(e,t),t.fen&&(e.pieces=tn(t.fen),e.drawable.shapes=((r=t.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in t&&ii(e,t.check||!1),"lastMove"in t&&!t.lastMove?e.lastMove=void 0:t.lastMove&&(e.lastMove=t.lastMove),e.selected&&Jt(e,e.selected),nn(e,t),!e.movable.rookCastle&&e.movable.dests){const o=e.movable.color==="white"?"1":"8",s="e"+o,c=e.movable.dests.get(s),d=e.pieces.get(s);if(!c||!d||d.role!=="king")return;e.movable.dests.set(s,c.filter(a=>!(a==="a"+o&&c.includes("c"+o))&&!(a==="h"+o&&c.includes("g"+o))))}}function ct(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&(Object.prototype.hasOwnProperty.call(e,n)&&wt(e[n])&&wt(t[n])?ct(e[n],t[n]):e[n]=t[n])}function wt(e){if(typeof e!="object"||e===null)return!1;const t=Object.getPrototypeOf(e);return t===Object.prototype||t===null}const J=(e,t)=>t.animation.enabled?ki(e,t):G(e,t);function G(e,t){const n=e(t);return t.dom.redraw(),n}const Ne=(e,t)=>({key:e,pos:O(e),piece:t}),bi=(e,t)=>t.sort((n,i)=>he(e.pos,n.pos)-he(e.pos,i.pos))[0];function wi(e,t){const n=new Map,i=[],r=new Map,o=[],s=[],c=new Map;let d,a,b;for(const[h,x]of e)c.set(h,Ne(h,x));for(const h of et)d=t.pieces.get(h),a=c.get(h),d?a?Ue(d,a.piece)||(o.push(a),s.push(Ne(h,d))):s.push(Ne(h,d)):a&&o.push(a);for(const h of s)a=bi(h,o.filter(x=>Ue(h.piece,x.piece))),a&&(b=[a.pos[0]-h.pos[0],a.pos[1]-h.pos[1]],n.set(h.key,b.concat(b)),i.push(a.key));for(const h of o)i.includes(h.key)||r.set(h.key,h.piece);return{anims:n,fadings:r}}function on(e,t){const n=e.animation.current;if(n===void 0){e.dom.destroyed||e.dom.redrawNow();return}const i=1-(t-n.start)*n.frequency;if(i<=0)e.animation.current=void 0,e.dom.redrawNow();else{const r=vi(i);for(const o of n.plan.anims.values())o[2]=o[0]*r,o[3]=o[1]*r;e.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>on(e,o))}}function ki(e,t){const n=new Map(t.pieces),i=e(t),r=wi(n,t);if(r.anims.size||r.fadings.size){const o=t.animation.current&&t.animation.current.start;t.animation.current={start:performance.now(),frequency:1/t.animation.duration,plan:r},o||on(t,performance.now())}else t.dom.redraw();return i}const vi=e=>e<.5?4*e*e*e:(e-1)*(2*e-2)*(2*e-2)+1,yi=["green","red","blue","yellow"];function Ci(e,t){if(t.touches&&t.touches.length>1)return;t.stopPropagation(),t.preventDefault(),t.ctrlKey?B(e):st(e);const n=ne(t),i=ie(n,F(e),e.dom.bounds());i&&(e.drawable.current={orig:i,pos:n,brush:Ai(t),snapToValidMove:e.drawable.defaultSnapToValidMove},sn(e))}function sn(e){requestAnimationFrame(()=>{const t=e.drawable.current;if(t){const n=ie(t.pos,F(e),e.dom.bounds());n||(t.snapToValidMove=!1);const i=t.snapToValidMove?hi(t.orig,t.pos,F(e),e.dom.bounds()):n;i!==t.mouseSq&&(t.mouseSq=i,t.dest=i!==t.orig?i:void 0,e.dom.redrawNow()),sn(e)}})}function Pi(e,t){e.drawable.current&&(e.drawable.current.pos=ne(t))}function Si(e){const t=e.drawable.current;t&&(t.mouseSq&&Ei(e.drawable,t),cn(e))}function cn(e){e.drawable.current&&(e.drawable.current=void 0,e.dom.redraw())}function Mi(e){e.drawable.shapes.length&&(e.drawable.shapes=[],e.dom.redraw(),ln(e.drawable))}function Ai(e){var t;const n=(e.shiftKey||e.ctrlKey)&&It(e),i=e.altKey||e.metaKey||((t=e.getModifierState)===null||t===void 0?void 0:t.call(e,"AltGraph"));return yi[(n?1:0)+(i?2:0)]}function Ei(e,t){const n=r=>r.orig===t.orig&&r.dest===t.dest,i=e.shapes.find(n);i&&(e.shapes=e.shapes.filter(r=>!n(r))),(!i||i.brush!==t.brush)&&e.shapes.push({orig:t.orig,dest:t.dest,brush:t.brush}),ln(e)}function ln(e){e.onChange&&e.onChange(e.shapes)}function xi(e,t){if(!(e.trustAllEvents||t.isTrusted)||t.buttons!==void 0&&t.buttons>1||t.touches&&t.touches.length>1)return;const n=e.dom.bounds(),i=ne(t),r=ie(i,F(e),n);if(!r)return;const o=e.pieces.get(r),s=e.selected;if(!s&&e.drawable.enabled&&(e.drawable.eraseOnClick||!o||o.color!==e.turnColor)&&Mi(e),t.cancelable!==!1&&(!t.touches||e.blockTouchScroll||o||s||Ri(e,i)))t.preventDefault();else if(t.touches)return;const c=!!e.premovable.current,d=!!e.predroppable.current;e.stats.ctrlKey=t.ctrlKey,e.selected&&rt(e,e.selected,r)?J(h=>Ze(h,r),e):Ze(e,r);const a=e.selected===r,b=un(e,r);if(o&&b&&a&&ui(e,r)){e.draggable.current={orig:r,piece:o,origPos:i,pos:i,started:e.draggable.autoDistance&&e.stats.dragged,element:b,previouslySelected:s,originTarget:t.target,keyHasChanged:!1},b.cgDragging=!0,b.classList.add("dragging");const h=e.dom.elements.ghost;h&&(h.className=`ghost ${o.color} ${o.role}`,H(h,ge(n)(O(r),F(e))),nt(h,!0)),lt(e)}else c&&Y(e),d&&Q(e);e.dom.redraw()}function Ri(e,t){const n=F(e),i=e.dom.bounds(),r=Math.pow(i.width/8,2);for(const o of e.pieces.keys()){const s=Ht(o,n,i);if(he(s,t)<=r)return!0}return!1}function Oi(e,t,n,i){const r="a0";e.pieces.set(r,t),e.dom.redraw();const o=ne(n);e.draggable.current={orig:r,piece:t,origPos:o,pos:o,started:!0,element:()=>un(e,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},lt(e)}function lt(e){requestAnimationFrame(()=>{var t;const n=e.draggable.current;if(!n)return;!((t=e.animation.current)===null||t===void 0)&&t.plan.anims.has(n.orig)&&(e.animation.current=void 0);const i=e.pieces.get(n.orig);if(!i||!Ue(i,n.piece))Ee(e);else if(!n.started&&he(n.pos,n.origPos)>=Math.pow(e.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const r=e.dom.bounds();H(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==ie(n.pos,F(e),r))}lt(e)})}function Ti(e,t){e.draggable.current&&(!t.touches||t.touches.length<2)&&(e.draggable.current.pos=ne(t))}function Di(e,t){const n=e.draggable.current;if(!n)return;if(t.type==="touchend"&&t.cancelable!==!1&&t.preventDefault(),t.type==="touchend"&&n.originTarget!==t.target&&!n.newPiece){e.draggable.current=void 0;return}Y(e),Q(e);const i=ne(t)||n.pos,r=ie(i,F(e),e.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?Qt(e,n.orig,r,n.force):(e.stats.ctrlKey=t.ctrlKey,Yt(e,n.orig,r)&&(e.stats.dragged=!0)):n.newPiece?e.pieces.delete(n.orig):e.draggable.deleteOnDropOff&&!r&&(e.pieces.delete(n.orig),$(e.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?B(e):e.selectable.enabled||B(e),an(e),e.draggable.current=void 0,e.dom.redraw()}function Ee(e){const t=e.draggable.current;t&&(t.newPiece&&e.pieces.delete(t.orig),e.draggable.current=void 0,B(e),an(e),e.dom.redraw())}function an(e){const t=e.dom.elements;t.ghost&&nt(t.ghost,!1)}function un(e,t){let n=e.dom.elements.board.firstChild;for(;n;){if(n.cgKey===t&&n.tagName==="PIECE")return n;n=n.nextSibling}}function Ni(e,t){e.exploding={stage:1,keys:t},e.dom.redraw(),setTimeout(()=>{kt(e,2),setTimeout(()=>kt(e,void 0),120)},120)}function kt(e,t){e.exploding&&(t?e.exploding.stage=t:e.exploding=void 0,e.dom.redraw())}function Li(e,t){function n(){ti(e),t()}return{set(i){i.orientation&&i.orientation!==e.orientation&&n(),nn(e,i),(i.fen?J:G)(r=>rn(r,i),e)},state:e,getFen:()=>gi(e.pieces),toggleOrientation:n,setPieces(i){J(r=>ni(r,i),e)},selectSquare(i,r){i?J(o=>Ze(o,i,r),e):e.selected&&(B(e),e.dom.redraw())},move(i,r){J(o=>Zt(o,i,r),e)},newPiece(i,r){J(o=>it(o,i,r),e)},playPremove(){if(e.premovable.current){if(J(fi,e))return!0;e.dom.redraw()}return!1},playPredrop(i){if(e.predroppable.current){const r=di(e,i);return e.dom.redraw(),r}return!1},cancelPremove(){G(Y,e)},cancelPredrop(){G(Q,e)},cancelMove(){G(i=>{st(i),Ee(i)},e)},stop(){G(i=>{bt(i),Ee(i)},e)},explode(i){Ni(e,i)},setAutoShapes(i){G(r=>r.drawable.autoShapes=i,e)},setShapes(i){G(r=>r.drawable.shapes=i,e)},getKeyAtDomPos(i){return ie(i,F(e),e.dom.bounds())},redrawAll:t,dragNewPiece(i,r,o){Oi(e,i,r,o)},destroy(){bt(e),e.dom.unbind&&e.dom.unbind(),e.dom.destroyed=!0}}}function _i(){return{pieces:tn(en),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Qn()}}const vt={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function Ki(){const e=D("defs"),t=_(D("filter"),{id:"cg-filter-blur"});return t.appendChild(_(D("feGaussianBlur"),{stdDeviation:"0.019"})),e.appendChild(t),e}function $i(e,t,n){var i;const r=e.drawable,o=r.current,s=o&&o.mouseSq?o:void 0,c=new Map,d=e.dom.bounds(),a=r.autoShapes.filter(P=>!P.piece);for(const P of r.shapes.concat(a).concat(s?[s]:[])){if(!P.dest)continue;const l=(i=c.get(P.dest))!==null&&i!==void 0?i:new Set,u=Oe(Re(O(P.orig),e.orientation),d),g=Oe(Re(O(P.dest),e.orientation),d);l.add(Ye(u,g)),c.set(P.dest,l)}const b=r.shapes.concat(a).map(P=>({shape:P,current:!1,hash:yt(P,Xe(P.dest,c),!1,d)}));s&&b.push({shape:s,current:!0,hash:yt(s,Xe(s.dest,c),!0,d)});const h=b.map(P=>P.hash).join(";");if(h===e.drawable.prevSvgHash)return;e.drawable.prevSvgHash=h;const x=t.querySelector("defs");Fi(r,b,x),zi(b,t.querySelector("g"),n.querySelector("g"),P=>Hi(e,P,r.brushes,c,d))}function Fi(e,t,n){var i;const r=new Map;let o;for(const d of t.filter(a=>a.shape.dest&&a.shape.brush))o=fn(e.brushes[d.shape.brush],d.shape.modifiers),!((i=d.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(xe(o).key,xe(o)),r.set(o.key,o);const s=new Set;let c=n.firstElementChild;for(;c;)s.add(c.getAttribute("cgKey")),c=c.nextElementSibling;for(const[d,a]of r.entries())s.has(d)||n.appendChild(qi(a))}function zi(e,t,n,i){const r=new Map;for(const o of e)r.set(o.hash,!1);for(const o of[t,n]){const s=[];let c=o.firstElementChild,d;for(;c;)d=c.getAttribute("cgHash"),r.has(d)?r.set(d,!0):s.push(c),c=c.nextElementSibling;for(const a of s)o.removeChild(a)}for(const o of e.filter(s=>!r.get(s.hash)))for(const s of i(o))s.isCustom?n.appendChild(s.el):t.appendChild(s.el)}function yt({orig:e,dest:t,brush:n,piece:i,modifiers:r,customSvg:o,label:s},c,d,a){var b,h;return[a.width,a.height,d,e,t,n,c&&"-",i&&Bi(i),r&&Ii(r),o&&`custom-${Ct(o.html)},${(h=(b=o.center)===null||b===void 0?void 0:b[0])!==null&&h!==void 0?h:"o"}`,s&&`label-${Ct(s.text)}`].filter(x=>x).join(",")}function Bi(e){return[e.color,e.role,e.scale].filter(t=>t).join(",")}function Ii(e){return[e.lineWidth,e.hilite&&"*"].filter(t=>t).join(",")}function Ct(e){let t=0;for(let n=0;n<e.length;n++)t=(t<<5)-t+e.charCodeAt(n)>>>0;return t.toString()}function Hi(e,{shape:t,current:n,hash:i},r,o,s){var c,d;const a=Oe(Re(O(t.orig),e.orientation),s),b=t.dest?Oe(Re(O(t.dest),e.orientation),s):a,h=t.brush&&fn(r[t.brush],t.modifiers),x=o.get(t.dest),P=[];if(h){const l=_(D("g"),{cgHash:i});P.push({el:l}),a[0]!==b[0]||a[1]!==b[1]?l.appendChild(ji(t,h,a,b,n,Xe(t.dest,o))):l.appendChild(Wi(r[t.brush],a,n,s))}if(t.label){const l=t.label;(c=l.fill)!==null&&c!==void 0||(l.fill=t.brush&&r[t.brush].color);const u=t.brush?void 0:"tr";P.push({el:Gi(l,i,a,b,x,u),isCustom:!0})}if(t.customSvg){const l=(d=t.customSvg.center)!==null&&d!==void 0?d:"orig",[u,g]=l==="label"?hn(a,b,x).map(w=>w-.5):l==="dest"?b:a,p=_(D("g"),{transform:`translate(${u},${g})`,cgHash:i});p.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${t.customSvg.html}</svg>`,P.push({el:p,isCustom:!0})}return P}function Wi(e,t,n,i){const r=Ui(),o=(i.width+i.height)/(4*Math.max(i.width,i.height));return _(D("circle"),{stroke:e.color,"stroke-width":r[n?0:1],fill:"none",opacity:dn(e,n),cx:t[0],cy:t[1],r:o-r[1]/2})}function xe(e){return["#ffffff","#fff","white"].includes(e.color)?vt.hilitePrimary:vt.hiliteWhite}function ji(e,t,n,i,r,o){var s;function c(b){var h;const x=Xi(o&&!r),P=i[0]-n[0],l=i[1]-n[1],u=Math.atan2(l,P),g=Math.cos(u)*x,p=Math.sin(u)*x;return _(D("line"),{stroke:b?xe(t).color:t.color,"stroke-width":Zi(t,r)+(b?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${b?xe(t).key:t.key})`,opacity:!((h=e.modifiers)===null||h===void 0)&&h.hilite?1:dn(t,r),x1:n[0],y1:n[1],x2:i[0]-g,y2:i[1]-p})}if(!(!((s=e.modifiers)===null||s===void 0)&&s.hilite))return c(!1);const d=D("g"),a=_(D("g"),{filter:"url(#cg-filter-blur)"});return a.appendChild(Yi(n,i)),a.appendChild(c(!0)),d.appendChild(a),d.appendChild(c(!1)),d}function qi(e){const t=_(D("marker"),{id:"arrowhead-"+e.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:e.key.startsWith("hilite")?1.86:2.05,refY:2});return t.appendChild(_(D("path"),{d:"M0,0 V4 L3,2 Z",fill:e.color})),t.setAttribute("cgKey",e.key),t}function Gi(e,t,n,i,r,o){var s;const d=.4*.75**e.text.length,a=hn(n,i,r),b=o==="tr"?.4:0,h=_(D("g"),{transform:`translate(${a[0]+b},${a[1]-b})`,cgHash:t});h.appendChild(_(D("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=e.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const x=_(D("text"),{"font-size":d,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**e.text.length});return x.innerHTML=e.text,h.appendChild(x),h}function Re(e,t){return t==="white"?e:[7-e[0],7-e[1]]}function Xe(e,t){return(e&&t.has(e)&&t.get(e).size>1)===!0}function D(e){return document.createElementNS("http://www.w3.org/2000/svg",e)}function _(e,t){for(const n in t)Object.prototype.hasOwnProperty.call(t,n)&&e.setAttribute(n,t[n]);return e}function fn(e,t){return t?{color:e.color,opacity:Math.round(e.opacity*10)/10,lineWidth:Math.round(t.lineWidth||e.lineWidth),key:[e.key,t.lineWidth].filter(n=>n).join("")}:e}function Ui(){return[3/64,4/64]}function Zi(e,t){return(e.lineWidth||10)*(t?.85:1)/64}function dn(e,t){return(e.opacity||1)*(t?.9:1)}function Xi(e){return(e?20:10)/64}function Oe(e,t){const n=Math.min(1,t.width/t.height),i=Math.min(1,t.height/t.width);return[(e[0]-3.5)*n,(3.5-e[1])*i]}function Yi(e,t){const n={from:[Math.floor(Math.min(e[0],t[0])),Math.floor(Math.min(e[1],t[1]))],to:[Math.ceil(Math.max(e[0],t[0])),Math.ceil(Math.max(e[1],t[1]))]};return _(D("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function Ye(e,t,n=!0){const i=Math.atan2(t[1]-e[1],t[0]-e[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function Qi(e,t){return Math.sqrt([e[0]-t[0],e[1]-t[1]].reduce((n,i)=>n+i*i,0))}function hn(e,t,n){let i=Qi(e,t);const r=Ye(e,t,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const o=Ye(e,t);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(i-=.4)}return[e[0]-Math.cos(r)*i,e[1]-Math.sin(r)*i].map(o=>o+.5)}function Ji(e,t){e.innerHTML="",e.classList.add("cg-wrap");for(const d of Zn)e.classList.toggle("orientation-"+d,t.orientation===d);e.classList.toggle("manipulable",!t.viewOnly);const n=j("cg-container");e.appendChild(n);const i=j("cg-board");n.appendChild(i);let r,o,s;if(t.drawable.visible&&(r=_(D("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(Ki()),r.appendChild(D("g")),o=_(D("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(D("g")),s=j("cg-auto-pieces"),n.appendChild(r),n.appendChild(o),n.appendChild(s)),t.coordinates){const d=t.orientation==="black"?" black":"",a=t.ranksPosition==="left"?" left":"";if(t.coordinatesOnSquares){const b=t.orientation==="white"?h=>h+1:h=>8-h;Me.forEach((h,x)=>n.appendChild(Le(Ae.map(P=>h+P),"squares rank"+b(x)+d+a)))}else n.appendChild(Le(Ae,"ranks"+d+a)),n.appendChild(Le(Me,"files"+d))}let c;return t.draggable.enabled&&t.draggable.showGhost&&(c=j("piece","ghost"),nt(c,!1),n.appendChild(c)),{board:i,container:n,wrap:e,ghost:c,svg:r,customSvg:o,autoPieces:s}}function Le(e,t){const n=j("coords",t);let i;for(const r of e)i=j("coord"),i.textContent=r,n.appendChild(i);return n}function Vi(e,t){if(!e.dropmode.active)return;Y(e),Q(e);const n=e.dropmode.piece;if(n){e.pieces.set("a0",n);const i=ne(t),r=i&&ie(i,F(e),e.dom.bounds());r&&Qt(e,"a0",r)}e.dom.redraw()}function er(e,t){const n=e.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(t).observe(e.dom.elements.wrap),(e.disableContextMenu||e.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),e.viewOnly)return;const i=nr(e);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function tr(e,t){const n=[];if("ResizeObserver"in window||n.push(ae(document.body,"chessground.resize",t)),!e.viewOnly){const i=Pt(e,Ti,Pi),r=Pt(e,Di,Si);for(const s of["touchmove","mousemove"])n.push(ae(document,s,i));for(const s of["touchend","mouseup"])n.push(ae(document,s,r));const o=()=>e.dom.bounds.clear();n.push(ae(document,"scroll",o,{capture:!0,passive:!0})),n.push(ae(window,"resize",o,{passive:!0}))}return()=>n.forEach(i=>i())}function ae(e,t,n,i){return e.addEventListener(t,n,i),()=>e.removeEventListener(t,n,i)}const nr=e=>t=>{e.draggable.current?Ee(e):e.drawable.current?cn(e):t.shiftKey||It(t)?e.drawable.enabled&&Ci(e,t):e.viewOnly||(e.dropmode.active?Vi(e,t):xi(e,t))},Pt=(e,t,n)=>i=>{e.drawable.current?e.drawable.enabled&&n(e,i):e.viewOnly||t(e,i)};function ir(e){const t=F(e),n=ge(e.dom.bounds()),i=e.dom.elements.board,r=e.pieces,o=e.animation.current,s=o?o.plan.anims:new Map,c=o?o.plan.fadings:new Map,d=e.draggable.current,a=or(e),b=new Set,h=new Set,x=new Map,P=new Map;let l,u,g,p,w,C,k,v,y,S;for(u=i.firstChild;u;){if(l=u.cgKey,pn(u))if(g=r.get(l),w=s.get(l),C=c.get(l),p=u.cgPiece,u.cgDragging&&(!d||d.orig!==l)&&(u.classList.remove("dragging"),H(u,n(O(l),t)),u.cgDragging=!1),!C&&u.cgFading&&(u.cgFading=!1,u.classList.remove("fading")),g){if(w&&u.cgAnimating&&p===ue(g)){const m=O(l);m[0]+=w[2],m[1]+=w[3],u.classList.add("anim"),H(u,n(m,t))}else u.cgAnimating&&(u.cgAnimating=!1,u.classList.remove("anim"),H(u,n(O(l),t)),e.addPieceZIndex&&(u.style.zIndex=_e(O(l),t)));p===ue(g)&&(!C||!u.cgFading)?b.add(l):C&&p===ue(C)?(u.classList.add("fading"),u.cgFading=!0):Ke(x,p,u)}else Ke(x,p,u);else if(mn(u)){const m=u.className;a.get(l)===m?h.add(l):Ke(P,m,u)}u=u.nextSibling}for(const[m,M]of a)if(!h.has(m)){y=P.get(M),S=y&&y.pop();const E=n(O(m),t);if(S)S.cgKey=m,H(S,E);else{const A=j("square",M);A.cgKey=m,H(A,E),i.insertBefore(A,i.firstChild)}}for(const[m,M]of r)if(w=s.get(m),!b.has(m))if(k=x.get(ue(M)),v=k&&k.pop(),v){v.cgKey=m,v.cgFading&&(v.classList.remove("fading"),v.cgFading=!1);const E=O(m);e.addPieceZIndex&&(v.style.zIndex=_e(E,t)),w&&(v.cgAnimating=!0,v.classList.add("anim"),E[0]+=w[2],E[1]+=w[3]),H(v,n(E,t))}else{const E=ue(M),A=j("piece",E),T=O(m);A.cgPiece=E,A.cgKey=m,w&&(A.cgAnimating=!0,T[0]+=w[2],T[1]+=w[3]),H(A,n(T,t)),e.addPieceZIndex&&(A.style.zIndex=_e(T,t)),i.appendChild(A)}for(const m of x.values())Mt(e,m);for(const m of P.values())Mt(e,m)}function rr(e){const t=F(e),n=ge(e.dom.bounds());let i=e.dom.elements.board.firstChild;for(;i;)(pn(i)&&!i.cgAnimating||mn(i))&&H(i,n(O(i.cgKey),t)),i=i.nextSibling}function St(e){var t,n;const i=e.dom.elements.wrap.getBoundingClientRect(),r=e.dom.elements.container,o=i.height/i.width,s=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,c=s*o;r.style.width=s+"px",r.style.height=c+"px",e.dom.bounds.clear(),(t=e.addDimensionsCssVarsTo)===null||t===void 0||t.style.setProperty("---cg-width",s+"px"),(n=e.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",c+"px")}const pn=e=>e.tagName==="PIECE",mn=e=>e.tagName==="SQUARE";function Mt(e,t){for(const n of t)e.dom.elements.board.removeChild(n)}function _e(e,t){const i=e[1];return`${t?10-i:3+i}`}const ue=e=>`${e.color} ${e.role}`;function or(e){var t,n,i;const r=new Map;if(e.lastMove&&e.highlight.lastMove)for(const c of e.lastMove)W(r,c,"last-move");if(e.check&&e.highlight.check&&W(r,e.check,"check"),e.selected&&(W(r,e.selected,"selected"),e.movable.showDests)){const c=(t=e.movable.dests)===null||t===void 0?void 0:t.get(e.selected);if(c)for(const a of c)W(r,a,"move-dest"+(e.pieces.has(a)?" oc":""));const d=(i=(n=e.premovable.customDests)===null||n===void 0?void 0:n.get(e.selected))!==null&&i!==void 0?i:e.premovable.dests;if(d)for(const a of d)W(r,a,"premove-dest"+(e.pieces.has(a)?" oc":""))}const o=e.premovable.current;if(o)for(const c of o)W(r,c,"current-premove");else e.predroppable.current&&W(r,e.predroppable.current.key,"current-premove");const s=e.exploding;if(s)for(const c of s.keys)W(r,c,"exploding"+s.stage);return e.highlight.custom&&e.highlight.custom.forEach((c,d)=>{W(r,d,c)}),r}function W(e,t,n){const i=e.get(t);i?e.set(t,`${i} ${n}`):e.set(t,n)}function Ke(e,t,n){const i=e.get(t);i?i.push(n):e.set(t,[n])}function sr(e,t,n){const i=new Map,r=[];for(const c of e)i.set(c.hash,!1);let o=t.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),i.has(s)?i.set(s,!0):r.push(o),o=o.nextElementSibling;for(const c of r)t.removeChild(c);for(const c of e)i.get(c.hash)||t.appendChild(n(c))}function cr(e,t){const i=e.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:ur(r),current:!1}));sr(i,t,r=>ar(e,r,e.dom.bounds()))}function lr(e){var t;const n=F(e),i=ge(e.dom.bounds());let r=(t=e.dom.elements.autoPieces)===null||t===void 0?void 0:t.firstChild;for(;r;)Bt(r,i(O(r.cgKey),n),r.cgScale),r=r.nextSibling}function ar(e,{shape:t,hash:n},i){var r,o,s;const c=t.orig,d=(r=t.piece)===null||r===void 0?void 0:r.role,a=(o=t.piece)===null||o===void 0?void 0:o.color,b=(s=t.piece)===null||s===void 0?void 0:s.scale,h=j("piece",`${d} ${a}`);return h.setAttribute("cgHash",n),h.cgKey=c,h.cgScale=b,Bt(h,ge(i)(O(c),F(e)),b),h}const ur=e=>{var t,n,i;return[e.orig,(t=e.piece)===null||t===void 0?void 0:t.role,(n=e.piece)===null||n===void 0?void 0:n.color,(i=e.piece)===null||i===void 0?void 0:i.scale].join(",")};function fr(e,t){const n=_i();rn(n,t||{});function i(){const r="dom"in n?n.dom.unbind:void 0,o=Ji(e,n),s=Yn(()=>o.board.getBoundingClientRect()),c=b=>{ir(a),o.autoPieces&&cr(a,o.autoPieces),!b&&o.svg&&$i(a,o.svg,o.customSvg)},d=()=>{St(a),rr(a),o.autoPieces&&lr(a)},a=n;return a.dom={elements:o,bounds:s,redraw:dr(c),redrawNow:c,unbind:r},a.drawable.prevSvgHash="",St(a),c(!1),er(a,d),r||(a.dom.unbind=tr(a,d)),a.events.insert&&a.events.insert(o),a}return Li(i(),i)}function dr(e){let t=!1;return()=>{t||(t=!0,requestAnimationFrame(()=>{e(),t=!1}))}}function hr(e,t){return document.createElement(e,t)}function pr(e,t,n){return document.createElementNS(e,t,n)}function mr(){return ee(document.createDocumentFragment())}function gr(e){return document.createTextNode(e)}function br(e){return document.createComment(e)}function wr(e,t,n){if(q(e)){let i=e;for(;i&&q(i);)i=ee(i).parent;e=i??e}q(t)&&(t=ee(t,e)),n&&q(n)&&(n=ee(n).firstChildNode),e.insertBefore(t,n)}function kr(e,t){e.removeChild(t)}function vr(e,t){q(t)&&(t=ee(t,e)),e.appendChild(t)}function gn(e){if(q(e)){for(;e&&q(e);)e=ee(e).parent;return e??null}return e.parentNode}function yr(e){var t;if(q(e)){const n=ee(e),i=gn(n);if(i&&n.lastChildNode){const r=Array.from(i.childNodes),o=r.indexOf(n.lastChildNode);return(t=r[o+1])!==null&&t!==void 0?t:null}return null}return e.nextSibling}function Cr(e){return e.tagName}function Pr(e,t){e.textContent=t}function Sr(e){return e.textContent}function Mr(e){return e.nodeType===1}function Ar(e){return e.nodeType===3}function Er(e){return e.nodeType===8}function q(e){return e.nodeType===11}function ee(e,t){var n,i,r;const o=e;return(n=o.parent)!==null&&n!==void 0||(o.parent=t??null),(i=o.firstChildNode)!==null&&i!==void 0||(o.firstChildNode=e.firstChild),(r=o.lastChildNode)!==null&&r!==void 0||(o.lastChildNode=e.lastChild),o}const xr={createElement:hr,createElementNS:pr,createTextNode:gr,createDocumentFragment:mr,createComment:br,insertBefore:wr,removeChild:kr,appendChild:vr,parentNode:gn,nextSibling:yr,tagName:Cr,setTextContent:Pr,getTextContent:Sr,isElement:Mr,isText:Ar,isComment:Er,isDocumentFragment:q};function pe(e,t,n,i,r){const o=t===void 0?void 0:t.key;return{sel:e,data:t,children:n,text:i,elm:r,key:o}}const Te=Array.isArray;function ye(e){return typeof e=="string"||typeof e=="number"||e instanceof String||e instanceof Number}function we(e){return e===void 0}function K(e){return e!==void 0}const $e=pe("",{},[],void 0,void 0);function fe(e,t){var n,i;const r=e.key===t.key,o=((n=e.data)===null||n===void 0?void 0:n.is)===((i=t.data)===null||i===void 0?void 0:i.is),s=e.sel===t.sel,c=!e.sel&&e.sel===t.sel?typeof e.text==typeof t.text:!0;return s&&r&&o&&c}function Rr(){throw new Error("The document fragment is not supported on this platform.")}function Or(e,t){return e.isElement(t)}function Tr(e,t){return e.isDocumentFragment(t)}function Dr(e,t,n){var i;const r={};for(let o=t;o<=n;++o){const s=(i=e[o])===null||i===void 0?void 0:i.key;s!==void 0&&(r[s]=o)}return r}const Nr=["create","update","remove","destroy","pre","post"];function Lr(e,t,n){const i={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},r=xr;for(const l of Nr)for(const u of e){const g=u[l];g!==void 0&&i[l].push(g)}function o(l){const u=l.id?"#"+l.id:"",g=l.getAttribute("class"),p=g?"."+g.split(" ").join("."):"";return pe(r.tagName(l).toLowerCase()+u+p,{},[],void 0,l)}function s(l){return pe(void 0,{},[],void 0,l)}function c(l,u){return function(){if(--u===0){const p=r.parentNode(l);p!==null&&r.removeChild(p,l)}}}function d(l,u){var g,p,w,C;let k,v=l.data;if(v!==void 0){const m=(g=v.hook)===null||g===void 0?void 0:g.init;K(m)&&(m(l),v=l.data)}const y=l.children,S=l.sel;if(S==="!")we(l.text)&&(l.text=""),l.elm=r.createComment(l.text);else if(S==="")l.elm=r.createTextNode(l.text);else if(S!==void 0){const m=S.indexOf("#"),M=S.indexOf(".",m),E=m>0?m:S.length,A=M>0?M:S.length,T=m!==-1||M!==-1?S.slice(0,Math.min(E,A)):S,I=l.elm=K(v)&&K(k=v.ns)?r.createElementNS(k,T,v):r.createElement(T,v);for(E<A&&I.setAttribute("id",S.slice(E+1,A)),M>0&&I.setAttribute("class",S.slice(A+1).replace(/\./g," ")),k=0;k<i.create.length;++k)i.create[k]($e,l);if(ye(l.text)&&(!Te(y)||y.length===0)&&r.appendChild(I,r.createTextNode(l.text)),Te(y))for(k=0;k<y.length;++k){const at=y[k];at!=null&&r.appendChild(I,d(at,u))}const be=l.data.hook;K(be)&&((p=be.create)===null||p===void 0||p.call(be,$e,l),be.insert&&u.push(l))}else if(!((w=void 0)===null||w===void 0)&&w.fragments&&l.children){for(l.elm=((C=r.createDocumentFragment)!==null&&C!==void 0?C:Rr)(),k=0;k<i.create.length;++k)i.create[k]($e,l);for(k=0;k<l.children.length;++k){const m=l.children[k];m!=null&&r.appendChild(l.elm,d(m,u))}}else l.elm=r.createTextNode(l.text);return l.elm}function a(l,u,g,p,w,C){for(;p<=w;++p){const k=g[p];k!=null&&r.insertBefore(l,d(k,C),u)}}function b(l){var u,g;const p=l.data;if(p!==void 0){(g=(u=p==null?void 0:p.hook)===null||u===void 0?void 0:u.destroy)===null||g===void 0||g.call(u,l);for(let w=0;w<i.destroy.length;++w)i.destroy[w](l);if(l.children!==void 0)for(let w=0;w<l.children.length;++w){const C=l.children[w];C!=null&&typeof C!="string"&&b(C)}}}function h(l,u,g,p){for(var w,C;g<=p;++g){let k,v;const y=u[g];if(y!=null)if(K(y.sel)){b(y),k=i.remove.length+1,v=c(y.elm,k);for(let m=0;m<i.remove.length;++m)i.remove[m](y,v);const S=(C=(w=y==null?void 0:y.data)===null||w===void 0?void 0:w.hook)===null||C===void 0?void 0:C.remove;K(S)?S(y,v):v()}else y.children?(b(y),h(l,y.children,0,y.children.length-1)):r.removeChild(l,y.elm)}}function x(l,u,g,p){let w=0,C=0,k=u.length-1,v=u[0],y=u[k],S=g.length-1,m=g[0],M=g[S],E,A,T,I;for(;w<=k&&C<=S;)v==null?v=u[++w]:y==null?y=u[--k]:m==null?m=g[++C]:M==null?M=g[--S]:fe(v,m)?(P(v,m,p),v=u[++w],m=g[++C]):fe(y,M)?(P(y,M,p),y=u[--k],M=g[--S]):fe(v,M)?(P(v,M,p),r.insertBefore(l,v.elm,r.nextSibling(y.elm)),v=u[++w],M=g[--S]):fe(y,m)?(P(y,m,p),r.insertBefore(l,y.elm,v.elm),y=u[--k],m=g[++C]):(E===void 0&&(E=Dr(u,w,k)),A=E[m.key],we(A)?(r.insertBefore(l,d(m,p),v.elm),m=g[++C]):we(E[M.key])?(r.insertBefore(l,d(M,p),r.nextSibling(y.elm)),M=g[--S]):(T=u[A],T.sel!==m.sel?r.insertBefore(l,d(m,p),v.elm):(P(T,m,p),u[A]=void 0,r.insertBefore(l,T.elm,v.elm)),m=g[++C]));C<=S&&(I=g[S+1]==null?null:g[S+1].elm,a(l,I,g,C,S,p)),w<=k&&h(l,u,w,k)}function P(l,u,g){var p,w,C,k,v,y,S,m;const M=(p=u.data)===null||p===void 0?void 0:p.hook;(w=M==null?void 0:M.prepatch)===null||w===void 0||w.call(M,l,u);const E=u.elm=l.elm;if(l===u)return;if(u.data!==void 0||K(u.text)&&u.text!==l.text){(C=u.data)!==null&&C!==void 0||(u.data={}),(k=l.data)!==null&&k!==void 0||(l.data={});for(let I=0;I<i.update.length;++I)i.update[I](l,u);(S=(y=(v=u.data)===null||v===void 0?void 0:v.hook)===null||y===void 0?void 0:y.update)===null||S===void 0||S.call(y,l,u)}const A=l.children,T=u.children;we(u.text)?K(A)&&K(T)?A!==T&&x(E,A,T,g):K(T)?(K(l.text)&&r.setTextContent(E,""),a(E,null,T,0,T.length-1,g)):K(A)?h(E,A,0,A.length-1):K(l.text)&&r.setTextContent(E,""):l.text!==u.text&&(K(A)&&h(E,A,0,A.length-1),r.setTextContent(E,u.text)),(m=M==null?void 0:M.postpatch)===null||m===void 0||m.call(M,l,u)}return function(u,g){let p,w,C;const k=[];for(p=0;p<i.pre.length;++p)i.pre[p]();for(Or(r,u)?u=o(u):Tr(r,u)&&(u=s(u)),fe(u,g)?P(u,g,k):(w=u.elm,C=r.parentNode(w),d(g,k),C!==null&&(r.insertBefore(C,g.elm,r.nextSibling(w)),h(C,[u],0,0))),p=0;p<k.length;++p)k[p].data.hook.insert(k[p]);for(p=0;p<i.post.length;++p)i.post[p]();return g}}function bn(e,t,n){if(e.ns="http://www.w3.org/2000/svg",n!=="foreignObject"&&t!==void 0)for(let i=0;i<t.length;++i){const r=t[i];if(typeof r=="string")continue;const o=r.data;o!==void 0&&bn(o,r.children,r.sel)}}function se(e,t,n){let i={},r,o,s;if(n!==void 0?(t!==null&&(i=t),Te(n)?r=n:ye(n)?o=n.toString():n&&n.sel&&(r=[n])):t!=null&&(Te(t)?r=t:ye(t)?o=t.toString():t&&t.sel?r=[t]:i=t),r!==void 0)for(s=0;s<r.length;++s)ye(r[s])&&(r[s]=pe(void 0,void 0,void 0,r[s],void 0));return e.startsWith("svg")&&(e.length===3||e[3]==="."||e[3]==="#")&&bn(i,r,e),pe(e,i,r,o,void 0)}const _r="http://www.w3.org/1999/xlink",Kr="http://www.w3.org/2000/xmlns/",$r="http://www.w3.org/XML/1998/namespace",At=58,Fr=120,zr=109;function Et(e,t){let n;const i=t.elm;let r=e.data.attrs,o=t.data.attrs;if(!(!r&&!o)&&r!==o){r=r||{},o=o||{};for(n in o){const s=o[n];r[n]!==s&&(s===!0?i.setAttribute(n,""):s===!1?i.removeAttribute(n):n.charCodeAt(0)!==Fr?i.setAttribute(n,s):n.charCodeAt(3)===At?i.setAttributeNS($r,n,s):n.charCodeAt(5)===At?n.charCodeAt(1)===zr?i.setAttributeNS(Kr,n,s):i.setAttributeNS(_r,n,s):i.setAttribute(n,s))}for(n in r)n in o||i.removeAttribute(n)}}const Br={create:Et,update:Et};function xt(e,t){let n,i;const r=t.elm;let o=e.data.class,s=t.data.class;if(!(!o&&!s)&&o!==s){o=o||{},s=s||{};for(i in o)o[i]&&!Object.prototype.hasOwnProperty.call(s,i)&&r.classList.remove(i);for(i in s)n=s[i],n!==o[i]&&r.classList[n?"add":"remove"](i)}}const Ir={create:xt,update:xt};function wn(e,t,n){if(typeof e=="function")e.call(t,n,t);else if(typeof e=="object")for(let i=0;i<e.length;i++)wn(e[i],t,n)}function Hr(e,t){const n=e.type,i=t.data.on;i&&i[n]&&wn(i[n],t,e)}function Wr(){return function e(t){Hr(t,e.vnode)}}function Fe(e,t){const n=e.data.on,i=e.listener,r=e.elm,o=t&&t.data.on,s=t&&t.elm;let c;if(n!==o){if(n&&i)if(o)for(c in n)o[c]||r.removeEventListener(c,i,!1);else for(c in n)r.removeEventListener(c,i,!1);if(o){const d=t.listener=e.listener||Wr();if(d.vnode=t,n)for(c in o)n[c]||s.addEventListener(c,d,!1);else for(c in o)s.addEventListener(c,d,!1)}}}const jr={create:Fe,update:Fe,destroy:Fe},Rt=typeof(window==null?void 0:window.requestAnimationFrame)=="function"?window.requestAnimationFrame.bind(window):setTimeout,qr=function(e){Rt(function(){Rt(e)})};let Qe=!1;function Gr(e,t,n){qr(function(){e[t]=n})}function Ot(e,t){let n,i;const r=t.elm;let o=e.data.style,s=t.data.style;if(!o&&!s||o===s)return;o=o||{},s=s||{};const c="delayed"in o;for(i in o)i in s||(i[0]==="-"&&i[1]==="-"?r.style.removeProperty(i):r.style[i]="");for(i in s)if(n=s[i],i==="delayed"&&s.delayed)for(const d in s.delayed)n=s.delayed[d],(!c||n!==o.delayed[d])&&Gr(r.style,d,n);else i!=="remove"&&n!==o[i]&&(i[0]==="-"&&i[1]==="-"?r.style.setProperty(i,n):r.style[i]=n)}function Ur(e){let t,n;const i=e.elm,r=e.data.style;if(!(!r||!(t=r.destroy)))for(n in t)i.style[n]=t[n]}function Zr(e,t){const n=e.data.style;if(!n||!n.remove){t();return}Qe||(e.elm.offsetLeft,Qe=!0);let i;const r=e.elm;let o=0;const s=n.remove;let c=0;const d=[];for(i in s)d.push(i),r.style[i]=s[i];const b=getComputedStyle(r)["transition-property"].split(", ");for(;o<b.length;++o)d.indexOf(b[o])!==-1&&c++;r.addEventListener("transitionend",function(h){h.target===r&&--c,c===0&&t()})}function Xr(){Qe=!1}const Yr={pre:Xr,create:Ot,update:Ot,destroy:Ur,remove:Zr};function Qr(e){return{insert:t=>e(t.elm)}}function Tt(e){return se("div.blue.merida",{attrs:{tabindex:0},class:{darken:e.promotion!==null},on:{click:()=>{var t;return(t=e.promotion)==null?void 0:t.resolve(void 0)}},hook:Qr(t=>{e.setGround(fr(t.querySelector(".cg-wrap"),eo(e,t)))})},[Jr(e)])}const Jr=e=>se("div.lpv__board",se("div.cg-wrap",{class:{"cg-promotion":e.promotion!==null,"cg-promotion--open":e.promotion!==null}},e.promotion?Vr(e):void 0)),Vr=e=>{const t=["queen","knight","rook","bishop"],{dest:n,color:i,resolve:r}=e.promotion,o=e.cgState().orientation;let s=n.charCodeAt(0)-97,c=i=="white"?0:7,d=i=="white"?1:-1;return o=="black"&&(s=7-s,c=7-c,d*=-1),t.map((b,h)=>se("cg-board",se("square.blue.merida",{style:{top:`${(c+h*d)*12.5}%`,left:`${s*12.5}%`},on:{click:()=>r(b)}},se(`piece.${i}.${b}`))))};function eo(e,t){return{viewOnly:!1,addDimensionsCssVarsTo:t,drawable:{enabled:!0,visible:!0},disableContextMenu:!0,movable:{free:!1},draggable:{enabled:!0},selectable:{enabled:!0},...e.cgState()}}function to(e){const t=Lr([Ir,Br,Yr,jr]),n=new Un(o),i=Tt(n);e.innerHTML="";let r=t(e,i);n.div=r.elm;function o(){r=t(r,Tt(n))}return n}to(document.getElementById("app"));
