var Yn=Object.defineProperty;var Vn=(t,e,n)=>e in t?Yn(t,e,{enumerable:!0,configurable:!0,writable:!0,value:n}):t[e]=n;var V=(t,e,n)=>Vn(t,typeof e!="symbol"?e+"":e,n);(function(){const e=document.createElement("link").relList;if(e&&e.supports&&e.supports("modulepreload"))return;for(const r of document.querySelectorAll('link[rel="modulepreload"]'))i(r);new MutationObserver(r=>{for(const o of r)if(o.type==="childList")for(const s of o.addedNodes)s.tagName==="LINK"&&s.rel==="modulepreload"&&i(s)}).observe(document,{childList:!0,subtree:!0});function n(r){const o={};return r.integrity&&(o.integrity=r.integrity),r.referrerPolicy&&(o.referrerPolicy=r.referrerPolicy),r.crossOrigin==="use-credentials"?o.credentials="include":r.crossOrigin==="anonymous"?o.credentials="omit":o.credentials="same-origin",o}function i(r){if(r.ep)return;r.ep=!0;const o=n(r);fetch(r.href,o)}})();class Jt{unwrap(e,n){const i=this._chain(r=>g.ok(e?e(r):r),r=>n?g.ok(n(r)):g.err(r));if(i.isErr)throw i.error;return i.value}map(e,n){return this._chain(i=>g.ok(e(i)),i=>g.err(n?n(i):i))}chain(e,n){return this._chain(e,n||(i=>g.err(i)))}}class Jn extends Jt{constructor(e){super(),this.value=void 0,this.isOk=!0,this.isErr=!1,this.value=e}_chain(e,n){return e(this.value)}}class ei extends Jt{constructor(e){super(),this.error=void 0,this.isOk=!1,this.isErr=!0,this.error=e}_chain(e,n){return n(this.error)}}var g;(function(t){t.ok=function(e){return new Jn(e)},t.err=function(e){return new ei(e||new Error)},t.all=function(e){if(Array.isArray(e)){const r=[];for(let o=0;o<e.length;o++){const s=e[o];if(s.isErr)return s;r.push(s.value)}return t.ok(r)}const n={},i=Object.keys(e);for(let r=0;r<i.length;r++){const o=e[i[r]];if(o.isErr)return o;n[i[r]]=o.value}return t.ok(n)}})(g||(g={}));const At=t=>(t=t-(t>>>1&1431655765),t=(t&858993459)+(t>>>2&858993459),Math.imul(t+(t>>>4)&252645135,16843009)>>24),tt=t=>(t=t>>>8&16711935|(t&16711935)<<8,t>>>16&65535|(t&65535)<<16),Ot=t=>(t=t>>>1&1431655765|(t&1431655765)<<1,t=t>>>2&858993459|(t&858993459)<<2,t=t>>>4&252645135|(t&252645135)<<4,tt(t));class a{constructor(e,n){this.lo=e|0,this.hi=n|0}static fromSquare(e){return e>=32?new a(0,1<<e-32):new a(1<<e,0)}static fromRank(e){return new a(255,0).shl64(8*e)}static fromFile(e){return new a(16843009<<e,16843009<<e)}static empty(){return new a(0,0)}static full(){return new a(4294967295,4294967295)}static corners(){return new a(129,2164260864)}static center(){return new a(402653184,24)}static backranks(){return new a(255,4278190080)}static backrank(e){return e==="white"?new a(255,0):new a(0,4278190080)}static lightSquares(){return new a(1437226410,1437226410)}static darkSquares(){return new a(2857740885,2857740885)}complement(){return new a(~this.lo,~this.hi)}xor(e){return new a(this.lo^e.lo,this.hi^e.hi)}union(e){return new a(this.lo|e.lo,this.hi|e.hi)}intersect(e){return new a(this.lo&e.lo,this.hi&e.hi)}diff(e){return new a(this.lo&~e.lo,this.hi&~e.hi)}intersects(e){return this.intersect(e).nonEmpty()}isDisjoint(e){return this.intersect(e).isEmpty()}supersetOf(e){return e.diff(this).isEmpty()}subsetOf(e){return this.diff(e).isEmpty()}shr64(e){return e>=64?a.empty():e>=32?new a(this.hi>>>e-32,0):e>0?new a(this.lo>>>e^this.hi<<32-e,this.hi>>>e):this}shl64(e){return e>=64?a.empty():e>=32?new a(0,this.lo<<e-32):e>0?new a(this.lo<<e,this.hi<<e^this.lo>>>32-e):this}bswap64(){return new a(tt(this.hi),tt(this.lo))}rbit64(){return new a(Ot(this.hi),Ot(this.lo))}minus64(e){const n=this.lo-e.lo,i=(n&e.lo&1)+(e.lo>>>1)+(n>>>1)>>>31;return new a(n,this.hi-(e.hi+i))}equals(e){return this.lo===e.lo&&this.hi===e.hi}size(){return At(this.lo)+At(this.hi)}isEmpty(){return this.lo===0&&this.hi===0}nonEmpty(){return this.lo!==0||this.hi!==0}has(e){return(e>=32?this.hi&1<<e-32:this.lo&1<<e)!==0}set(e,n){return n?this.with(e):this.without(e)}with(e){return e>=32?new a(this.lo,this.hi|1<<e-32):new a(this.lo|1<<e,this.hi)}without(e){return e>=32?new a(this.lo,this.hi&~(1<<e-32)):new a(this.lo&~(1<<e),this.hi)}toggle(e){return e>=32?new a(this.lo,this.hi^1<<e-32):new a(this.lo^1<<e,this.hi)}last(){if(this.hi!==0)return 63-Math.clz32(this.hi);if(this.lo!==0)return 31-Math.clz32(this.lo)}first(){if(this.lo!==0)return 31-Math.clz32(this.lo&-this.lo);if(this.hi!==0)return 63-Math.clz32(this.hi&-this.hi)}withoutFirst(){return this.lo!==0?new a(this.lo&this.lo-1,this.hi):new a(0,this.hi&this.hi-1)}moreThanOne(){return this.hi!==0&&this.lo!==0||(this.lo&this.lo-1)!==0||(this.hi&this.hi-1)!==0}singleSquare(){return this.moreThanOne()?void 0:this.last()}*[Symbol.iterator](){let e=this.lo,n=this.hi;for(;e!==0;){const i=31-Math.clz32(e&-e);e^=1<<i,yield i}for(;n!==0;){const i=31-Math.clz32(n&-n);n^=1<<i,yield 32+i}}*reversed(){let e=this.lo,n=this.hi;for(;n!==0;){const i=31-Math.clz32(n);n^=1<<i,yield 32+i}for(;e!==0;){const i=31-Math.clz32(e);e^=1<<i,yield i}}}const en=["a","b","c","d","e","f","g","h"],ti=["1","2","3","4","5","6","7","8"],Z=["white","black"],Q=["pawn","knight","bishop","rook","queen","king"],ni=["a","h"],De=t=>"role"in t,v=t=>t!==void 0,A=t=>t==="white"?"black":"white",Re=t=>t>>3,Y=t=>t&7,nt=(t,e)=>0<=t&&t<8&&0<=e&&e<8?t+8*e:void 0,tn=t=>{switch(t){case"pawn":return"p";case"knight":return"n";case"bishop":return"b";case"rook":return"r";case"queen":return"q";case"king":return"k"}};function ke(t){switch(t.toLowerCase()){case"p":return"pawn";case"n":return"knight";case"b":return"bishop";case"r":return"rook";case"q":return"queen";case"k":return"king";default:return}}function ie(t){if(t.length===2)return nt(t.charCodeAt(0)-97,t.charCodeAt(1)-49)}const we=t=>en[Y(t)]+ti[Re(t)],ii=t=>{if(t[1]==="@"&&t.length===4){const e=ke(t[0]),n=ie(t.slice(2));if(e&&v(n))return{role:e,to:n}}else if(t.length===4||t.length===5){const e=ie(t.slice(0,2)),n=ie(t.slice(2,4));let i;if(t.length===5&&(i=ke(t[4]),!i))return;if(v(e)&&v(n))return{from:e,to:n,promotion:i}}},pt=(t,e)=>t==="white"?e==="a"?2:6:e==="a"?58:62,mt=(t,e)=>t==="white"?e==="a"?3:5:e==="a"?59:61,Ke=(t,e)=>{let n=a.empty();for(const i of e){const r=t+i;0<=r&&r<64&&Math.abs(Y(t)-Y(r))<=2&&(n=n.with(r))}return n},se=t=>{const e=[];for(let n=0;n<64;n++)e[n]=t(n);return e},ri=se(t=>Ke(t,[-9,-8,-7,-1,1,7,8,9])),oi=se(t=>Ke(t,[-17,-15,-10,-6,6,10,15,17])),si={white:se(t=>Ke(t,[7,9])),black:se(t=>Ke(t,[-7,-9]))},ve=t=>ri[t],gt=t=>oi[t],Ce=(t,e)=>si[t][e],it=se(t=>a.fromFile(Y(t)).without(t)),rt=se(t=>a.fromRank(Re(t)).without(t)),ot=se(t=>{const e=new a(134480385,2151686160),n=8*(Re(t)-Y(t));return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),st=se(t=>{const e=new a(270549120,16909320),n=8*(Re(t)+Y(t)-7);return(n>=0?e.shl64(n):e.shr64(-n)).without(t)}),ct=(t,e,n)=>{let i=n.intersect(e),r=i.bswap64();return i=i.minus64(t),r=r.minus64(t.bswap64()),i.xor(r.bswap64()).intersect(e)},ci=(t,e)=>ct(a.fromSquare(t),it[t],e),ai=(t,e)=>{const n=rt[t];let i=e.intersect(n),r=i.rbit64();return i=i.minus64(a.fromSquare(t)),r=r.minus64(a.fromSquare(63-t)),i.xor(r.rbit64()).intersect(n)},Me=(t,e)=>{const n=a.fromSquare(t);return ct(n,ot[t],e).xor(ct(n,st[t],e))},xe=(t,e)=>ci(t,e).xor(ai(t,e)),nn=(t,e)=>Me(t,e).xor(xe(t,e)),rn=(t,e,n)=>{switch(t.role){case"pawn":return Ce(t.color,e);case"knight":return gt(e);case"bishop":return Me(e,n);case"rook":return xe(e,n);case"queen":return nn(e,n);case"king":return ve(e)}},on=(t,e)=>{const n=a.fromSquare(e);return rt[t].intersects(n)?rt[t].with(t):st[t].intersects(n)?st[t].with(t):ot[t].intersects(n)?ot[t].with(t):it[t].intersects(n)?it[t].with(t):a.empty()},ye=(t,e)=>on(t,e).intersect(a.full().shl64(t).xor(a.full().shl64(e))).withoutFirst();class re{constructor(){}static default(){const e=new re;return e.reset(),e}reset(){this.occupied=new a(65535,4294901760),this.promoted=a.empty(),this.white=new a(65535,0),this.black=new a(0,4294901760),this.pawn=new a(65280,16711680),this.knight=new a(66,1107296256),this.bishop=new a(36,603979776),this.rook=new a(129,2164260864),this.queen=new a(8,134217728),this.king=new a(16,268435456)}static empty(){const e=new re;return e.clear(),e}clear(){this.occupied=a.empty(),this.promoted=a.empty();for(const e of Z)this[e]=a.empty();for(const e of Q)this[e]=a.empty()}clone(){const e=new re;e.occupied=this.occupied,e.promoted=this.promoted;for(const n of Z)e[n]=this[n];for(const n of Q)e[n]=this[n];return e}getColor(e){if(this.white.has(e))return"white";if(this.black.has(e))return"black"}getRole(e){for(const n of Q)if(this[n].has(e))return n}get(e){const n=this.getColor(e);if(!n)return;const i=this.getRole(e),r=this.promoted.has(e);return{color:n,role:i,promoted:r}}take(e){const n=this.get(e);return n&&(this.occupied=this.occupied.without(e),this[n.color]=this[n.color].without(e),this[n.role]=this[n.role].without(e),n.promoted&&(this.promoted=this.promoted.without(e))),n}set(e,n){const i=this.take(e);return this.occupied=this.occupied.with(e),this[n.color]=this[n.color].with(e),this[n.role]=this[n.role].with(e),n.promoted&&(this.promoted=this.promoted.with(e)),i}has(e){return this.occupied.has(e)}*[Symbol.iterator](){for(const e of this.occupied)yield[e,this.get(e)]}pieces(e,n){return this[e].intersect(this[n])}rooksAndQueens(){return this.rook.union(this.queen)}bishopsAndQueens(){return this.bishop.union(this.queen)}kingOf(e){return this.pieces(e,"king").singleSquare()}}var T;(function(t){t.Empty="ERR_EMPTY",t.OppositeCheck="ERR_OPPOSITE_CHECK",t.PawnsOnBackrank="ERR_PAWNS_ON_BACKRANK",t.Kings="ERR_KINGS",t.Variant="ERR_VARIANT"})(T||(T={}));class B extends Error{}const li=(t,e,n,i)=>n[e].intersect(xe(t,i).intersect(n.rooksAndQueens()).union(Me(t,i).intersect(n.bishopsAndQueens())).union(gt(t).intersect(n.knight)).union(ve(t).intersect(n.king)).union(Ce(A(e),t).intersect(n.pawn)));class G{constructor(){}static default(){const e=new G;return e.castlingRights=a.corners(),e.rook={white:{a:0,h:7},black:{a:56,h:63}},e.path={white:{a:new a(14,0),h:new a(96,0)},black:{a:new a(0,234881024),h:new a(0,1610612736)}},e}static empty(){const e=new G;return e.castlingRights=a.empty(),e.rook={white:{a:void 0,h:void 0},black:{a:void 0,h:void 0}},e.path={white:{a:a.empty(),h:a.empty()},black:{a:a.empty(),h:a.empty()}},e}clone(){const e=new G;return e.castlingRights=this.castlingRights,e.rook={white:{a:this.rook.white.a,h:this.rook.white.h},black:{a:this.rook.black.a,h:this.rook.black.h}},e.path={white:{a:this.path.white.a,h:this.path.white.h},black:{a:this.path.black.a,h:this.path.black.h}},e}add(e,n,i,r){const o=pt(e,n),s=mt(e,n);this.castlingRights=this.castlingRights.with(r),this.rook[e][n]=r,this.path[e][n]=ye(r,s).with(s).union(ye(i,o).with(o)).without(i).without(r)}static fromSetup(e){const n=G.empty(),i=e.castlingRights.intersect(e.board.rook);for(const r of Z){const o=a.backrank(r),s=e.board.kingOf(r);if(!v(s)||!o.has(s))continue;const c=i.intersect(e.board[r]).intersect(o),u=c.first();v(u)&&u<s&&n.add(r,"a",s,u);const l=c.last();v(l)&&s<l&&n.add(r,"h",s,l)}return n}discardRook(e){if(this.castlingRights.has(e)){this.castlingRights=this.castlingRights.without(e);for(const n of Z)for(const i of ni)this.rook[n][i]===e&&(this.rook[n][i]=void 0)}}discardColor(e){this.castlingRights=this.castlingRights.diff(a.backrank(e)),this.rook[e].a=void 0,this.rook[e].h=void 0}}class ce{constructor(e){this.rules=e}reset(){this.board=re.default(),this.pockets=void 0,this.turn="white",this.castles=G.default(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){this.board=e.board.clone(),this.board.promoted=a.empty(),this.pockets=void 0,this.turn=e.turn,this.castles=G.fromSetup(e),this.epSquare=ui(this,e.epSquare),this.remainingChecks=void 0,this.halfmoves=e.halfmoves,this.fullmoves=e.fullmoves}kingAttackers(e,n,i){return li(e,n,this.board,i)}playCaptureAt(e,n){this.halfmoves=0,n.role==="rook"&&this.castles.discardRook(e),this.pockets&&this.pockets[A(n.color)][n.promoted?"pawn":n.role]++}ctx(){const e=this.isVariantEnd(),n=this.board.kingOf(this.turn);if(!v(n))return{king:n,blockers:a.empty(),checkers:a.empty(),variantEnd:e,mustCapture:!1};const i=xe(n,a.empty()).intersect(this.board.rooksAndQueens()).union(Me(n,a.empty()).intersect(this.board.bishopsAndQueens())).intersect(this.board[A(this.turn)]);let r=a.empty();for(const s of i){const c=ye(n,s).intersect(this.board.occupied);c.moreThanOne()||(r=r.union(c))}const o=this.kingAttackers(n,A(this.turn),this.board.occupied);return{king:n,blockers:r,checkers:o,variantEnd:e,mustCapture:!1}}clone(){var e,n;const i=new this.constructor;return i.board=this.board.clone(),i.pockets=(e=this.pockets)===null||e===void 0?void 0:e.clone(),i.turn=this.turn,i.castles=this.castles.clone(),i.epSquare=this.epSquare,i.remainingChecks=(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),i.halfmoves=this.halfmoves,i.fullmoves=this.fullmoves,i}validate(){if(this.board.occupied.isEmpty())return g.err(new B(T.Empty));if(this.board.king.size()!==2)return g.err(new B(T.Kings));if(!v(this.board.kingOf(this.turn)))return g.err(new B(T.Kings));const e=this.board.kingOf(A(this.turn));return v(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?g.err(new B(T.OppositeCheck)):a.backranks().intersects(this.board.pawn)?g.err(new B(T.PawnsOnBackrank)):g.ok(void 0):g.err(new B(T.Kings))}dropDests(e){return a.empty()}dests(e,n){if(n=n||this.ctx(),n.variantEnd)return a.empty();const i=this.board.get(e);if(!i||i.color!==this.turn)return a.empty();let r,o;if(i.role==="pawn"){r=Ce(this.turn,e).intersect(this.board[A(this.turn)]);const s=this.turn==="white"?8:-8,c=e+s;if(0<=c&&c<64&&!this.board.occupied.has(c)){r=r.with(c);const u=this.turn==="white"?e<16:e>=48,l=c+s;u&&!this.board.occupied.has(l)&&(r=r.with(l))}v(this.epSquare)&&di(this,e,n)&&(o=a.fromSquare(this.epSquare))}else i.role==="bishop"?r=Me(e,this.board.occupied):i.role==="knight"?r=gt(e):i.role==="rook"?r=xe(e,this.board.occupied):i.role==="queen"?r=nn(e,this.board.occupied):r=ve(e);if(r=r.diff(this.board[this.turn]),v(n.king)){if(i.role==="king"){const s=this.board.occupied.without(e);for(const c of r)this.kingAttackers(c,A(this.turn),s).nonEmpty()&&(r=r.without(c));return r.union(Le(this,"a",n)).union(Le(this,"h",n))}if(n.checkers.nonEmpty()){const s=n.checkers.singleSquare();if(!v(s))return a.empty();r=r.intersect(ye(s,n.king).with(s))}n.blockers.has(e)&&(r=r.intersect(on(e,n.king)))}return o&&(r=r.union(o)),r}isVariantEnd(){return!1}variantOutcome(e){}hasInsufficientMaterial(e){return this.board[e].intersect(this.board.pawn.union(this.board.rooksAndQueens())).nonEmpty()?!1:this.board[e].intersects(this.board.knight)?this.board[e].size()<=2&&this.board[A(e)].diff(this.board.king).diff(this.board.queen).isEmpty():this.board[e].intersects(this.board.bishop)?(!this.board.bishop.intersects(a.darkSquares())||!this.board.bishop.intersects(a.lightSquares()))&&this.board.pawn.isEmpty()&&this.board.knight.isEmpty():!0}toSetup(){var e,n;return{board:this.board.clone(),pockets:(e=this.pockets)===null||e===void 0?void 0:e.clone(),turn:this.turn,castlingRights:this.castles.castlingRights,epSquare:hi(this),remainingChecks:(n=this.remainingChecks)===null||n===void 0?void 0:n.clone(),halfmoves:Math.min(this.halfmoves,150),fullmoves:Math.min(Math.max(this.fullmoves,1),9999)}}isInsufficientMaterial(){return Z.every(e=>this.hasInsufficientMaterial(e))}hasDests(e){e=e||this.ctx();for(const n of this.board[this.turn])if(this.dests(n,e).nonEmpty())return!0;return this.dropDests(e).nonEmpty()}isLegal(e,n){if(De(e))return!this.pockets||this.pockets[this.turn][e.role]<=0||e.role==="pawn"&&a.backranks().has(e.to)?!1:this.dropDests(n).has(e.to);{if(e.promotion==="pawn"||e.promotion==="king"&&this.rules!=="antichess"||!!e.promotion!==(this.board.pawn.has(e.from)&&a.backranks().has(e.to)))return!1;const i=this.dests(e.from,n);return i.has(e.to)||i.has(fi(this,e).to)}}isCheck(){const e=this.board.kingOf(this.turn);return v(e)&&this.kingAttackers(e,A(this.turn),this.board.occupied).nonEmpty()}isEnd(e){return(e?e.variantEnd:this.isVariantEnd())?!0:this.isInsufficientMaterial()||!this.hasDests(e)}isCheckmate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.nonEmpty()&&!this.hasDests(e)}isStalemate(e){return e=e||this.ctx(),!e.variantEnd&&e.checkers.isEmpty()&&!this.hasDests(e)}outcome(e){const n=this.variantOutcome(e);return n||(e=e||this.ctx(),this.isCheckmate(e)?{winner:A(this.turn)}:this.isInsufficientMaterial()||this.isStalemate(e)?{winner:void 0}:void 0)}allDests(e){e=e||this.ctx();const n=new Map;if(e.variantEnd)return n;for(const i of this.board[this.turn])n.set(i,this.dests(i,e));return n}play(e){const n=this.turn,i=this.epSquare,r=sn(this,e);if(this.epSquare=void 0,this.halfmoves+=1,n==="black"&&(this.fullmoves+=1),this.turn=A(n),De(e))this.board.set(e.to,{role:e.role,color:n}),this.pockets&&this.pockets[n][e.role]--,e.role==="pawn"&&(this.halfmoves=0);else{const o=this.board.take(e.from);if(!o)return;let s;if(o.role==="pawn"){this.halfmoves=0,e.to===i&&(s=this.board.take(e.to+(n==="white"?-8:8)));const c=e.from-e.to;Math.abs(c)===16&&8<=e.from&&e.from<=55&&(this.epSquare=e.from+e.to>>1),e.promotion&&(o.role=e.promotion,o.promoted=!!this.pockets)}else if(o.role==="rook")this.castles.discardRook(e.from);else if(o.role==="king"){if(r){const c=this.castles.rook[n][r];if(v(c)){const u=this.board.take(c);this.board.set(pt(n,r),o),u&&this.board.set(mt(n,r),u)}}this.castles.discardColor(n)}if(!r){const c=this.board.set(e.to,o)||s;c&&this.playCaptureAt(e.to,c)}}this.remainingChecks&&this.isCheck()&&(this.remainingChecks[n]=Math.max(this.remainingChecks[n]-1,0))}}class _e extends ce{constructor(){super("chess")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}}const ui=(t,e)=>{if(!v(e))return;const n=t.turn==="white"?5:2,i=t.turn==="white"?8:-8;if(Re(e)!==n||t.board.occupied.has(e+i))return;const r=e-i;if(!(!t.board.pawn.has(r)||!t.board[A(t.turn)].has(r)))return e},hi=t=>{if(!v(t.epSquare))return;const e=t.ctx(),i=t.board.pieces(t.turn,"pawn").intersect(Ce(A(t.turn),t.epSquare));for(const r of i)if(t.dests(r,e).has(t.epSquare))return t.epSquare},di=(t,e,n)=>{if(!v(t.epSquare)||!Ce(t.turn,e).has(t.epSquare))return!1;if(!v(n.king))return!0;const i=t.turn==="white"?8:-8,r=t.epSquare-i;return t.kingAttackers(n.king,A(t.turn),t.board.occupied.toggle(e).toggle(r).with(t.epSquare)).without(r).isEmpty()},Le=(t,e,n)=>{if(!v(n.king)||n.checkers.nonEmpty())return a.empty();const i=t.castles.rook[t.turn][e];if(!v(i)||t.castles.path[t.turn][e].intersects(t.board.occupied))return a.empty();const r=pt(t.turn,e),o=ye(n.king,r),s=t.board.occupied.without(n.king);for(const l of o)if(t.kingAttackers(l,A(t.turn),s).nonEmpty())return a.empty();const c=mt(t.turn,e),u=t.board.occupied.toggle(n.king).toggle(i).toggle(c);return t.kingAttackers(r,A(t.turn),u).nonEmpty()?a.empty():a.fromSquare(i)},at=(t,e,n)=>{if(n.variantEnd)return a.empty();const i=t.board.get(e);if(!i||i.color!==t.turn)return a.empty();let r=rn(i,e,t.board.occupied);if(i.role==="pawn"){let o=t.board[A(t.turn)];v(t.epSquare)&&(o=o.with(t.epSquare)),r=r.intersect(o);const s=t.turn==="white"?8:-8,c=e+s;if(0<=c&&c<64&&!t.board.occupied.has(c)){r=r.with(c);const u=t.turn==="white"?e<16:e>=48,l=c+s;u&&!t.board.occupied.has(l)&&(r=r.with(l))}return r}else r=r.diff(t.board[t.turn]);return e===n.king?r.union(Le(t,"a",n)).union(Le(t,"h",n)):r},sn=(t,e)=>{if(De(e))return;const n=e.to-e.from;if(!(Math.abs(n)!==2&&!t.board[t.turn].has(e.to))&&t.board.king.has(e.from))return n>0?"h":"a"},fi=(t,e)=>{const n=sn(t,e);if(!n)return e;const i=t.castles.rook[t.turn][n];return{from:e.from,to:v(i)?i:e.to}};class W{constructor(){}static empty(){const e=new W;for(const n of Q)e[n]=0;return e}static fromBoard(e,n){const i=new W;for(const r of Q)i[r]=e.pieces(n,r).size();return i}clone(){const e=new W;for(const n of Q)e[n]=this[n];return e}equals(e){return Q.every(n=>this[n]===e[n])}add(e){const n=new W;for(const i of Q)n[i]=this[i]+e[i];return n}subtract(e){const n=new W;for(const i of Q)n[i]=this[i]-e[i];return n}nonEmpty(){return Q.some(e=>this[e]>0)}isEmpty(){return!this.nonEmpty()}hasPawns(){return this.pawn>0}hasNonPawns(){return this.knight>0||this.bishop>0||this.rook>0||this.queen>0||this.king>0}size(){return this.pawn+this.knight+this.bishop+this.rook+this.queen+this.king}}class ee{constructor(e,n){this.white=e,this.black=n}static empty(){return new ee(W.empty(),W.empty())}static fromBoard(e){return new ee(W.fromBoard(e,"white"),W.fromBoard(e,"black"))}clone(){return new ee(this.white.clone(),this.black.clone())}equals(e){return this.white.equals(e.white)&&this.black.equals(e.black)}add(e){return new ee(this.white.add(e.white),this.black.add(e.black))}subtract(e){return new ee(this.white.subtract(e.white),this.black.subtract(e.black))}count(e){return this.white[e]+this.black[e]}size(){return this.white.size()+this.black.size()}isEmpty(){return this.white.isEmpty()&&this.black.isEmpty()}nonEmpty(){return!this.isEmpty()}hasPawns(){return this.white.hasPawns()||this.black.hasPawns()}hasNonPawns(){return this.white.hasNonPawns()||this.black.hasNonPawns()}}class de{constructor(e,n){this.white=e,this.black=n}static default(){return new de(3,3)}clone(){return new de(this.white,this.black)}equals(e){return this.white===e.white&&this.black===e.black}}const pi=()=>({board:re.default(),pockets:void 0,turn:"white",castlingRights:a.corners(),epSquare:void 0,remainingChecks:void 0,halfmoves:0,fullmoves:1});var K;(function(t){t.Fen="ERR_FEN",t.Board="ERR_BOARD",t.Pockets="ERR_POCKETS",t.Turn="ERR_TURN",t.Castling="ERR_CASTLING",t.EpSquare="ERR_EP_SQUARE",t.RemainingChecks="ERR_REMAINING_CHECKS",t.Halfmoves="ERR_HALFMOVES",t.Fullmoves="ERR_FULLMOVES"})(K||(K={}));class L extends Error{}const mi=(t,e,n)=>{let i=t.indexOf(e);for(;n-- >0&&i!==-1;)i=t.indexOf(e,i+e.length);return i},ge=t=>/^\d{1,4}$/.test(t)?parseInt(t,10):void 0,cn=t=>{const e=ke(t);return e&&{role:e,color:t.toLowerCase()===t?"black":"white"}},Ue=t=>{const e=re.empty();let n=7,i=0;for(let r=0;r<t.length;r++){const o=t[r];if(o==="/"&&i===8)i=0,n--;else{const s=parseInt(o,10);if(s>0)i+=s;else{if(i>=8||n<0)return g.err(new L(K.Board));const c=i+n*8,u=cn(o);if(!u)return g.err(new L(K.Board));t[r+1]==="~"&&(u.promoted=!0,r++),e.set(c,u),i++}}}return n!==0||i!==8?g.err(new L(K.Board)):g.ok(e)},Rt=t=>{if(t.length>64)return g.err(new L(K.Pockets));const e=ee.empty();for(const n of t){const i=cn(n);if(!i)return g.err(new L(K.Pockets));e[i.color][i.role]++}return g.ok(e)},gi=(t,e)=>{let n=a.empty();if(e==="-")return g.ok(n);for(const i of e){const r=i.toLowerCase(),o=i===r?"black":"white",s=o==="white"?0:7;if("a"<=r&&r<="h")n=n.with(nt(r.charCodeAt(0)-97,s));else if(r==="k"||r==="q"){const c=t[o].intersect(a.backrank(o)).intersect(t.rook.union(t.king)),u=r==="k"?c.last():c.first();n=n.with(v(u)&&t.rook.has(u)?u:nt(r==="k"?7:0,s))}else return g.err(new L(K.Castling))}return Z.some(i=>a.backrank(i).intersect(n).size()>2)?g.err(new L(K.Castling)):g.ok(n)},zt=t=>{const e=t.split("+");if(e.length===3&&e[0]===""){const n=ge(e[1]),i=ge(e[2]);return!v(n)||n>3||!v(i)||i>3?g.err(new L(K.RemainingChecks)):g.ok(new de(3-n,3-i))}else if(e.length===2){const n=ge(e[0]),i=ge(e[1]);return!v(n)||n>3||!v(i)||i>3?g.err(new L(K.RemainingChecks)):g.ok(new de(n,i))}else return g.err(new L(K.RemainingChecks))},an=t=>{const e=t.split(/[\s_]+/),n=e.shift();let i,r=g.ok(void 0);if(n.endsWith("]")){const c=n.indexOf("[");if(c===-1)return g.err(new L(K.Fen));i=Ue(n.slice(0,c)),r=Rt(n.slice(c+1,-1))}else{const c=mi(n,"/",7);c===-1?i=Ue(n):(i=Ue(n.slice(0,c)),r=Rt(n.slice(c+1)))}let o;const s=e.shift();if(!v(s)||s==="w")o="white";else if(s==="b")o="black";else return g.err(new L(K.Turn));return i.chain(c=>{const u=e.shift(),l=v(u)?gi(c,u):g.ok(a.empty()),p=e.shift();let f;if(v(p)&&p!=="-"&&(f=ie(p),!v(f)))return g.err(new L(K.EpSquare));let S=e.shift(),k;v(S)&&S.includes("+")&&(k=zt(S),S=e.shift());const h=v(S)?ge(S):0;if(!v(h))return g.err(new L(K.Halfmoves));const d=e.shift(),w=v(d)?ge(d):1;if(!v(w))return g.err(new L(K.Fullmoves));const m=e.shift();let y=g.ok(void 0);if(v(m)){if(v(k))return g.err(new L(K.RemainingChecks));y=zt(m)}else v(k)&&(y=k);return e.length>0?g.err(new L(K.Fen)):r.chain(M=>l.chain(C=>y.map(P=>({board:c,pockets:M,turn:o,castlingRights:C,remainingChecks:P,epSquare:f,halfmoves:h,fullmoves:Math.max(1,w)}))))})},ki=t=>{let e=tn(t.role);return t.color==="white"&&(e=e.toUpperCase()),t.promoted&&(e+="~"),e},wi=t=>{let e="",n=0;for(let i=7;i>=0;i--)for(let r=0;r<8;r++){const o=r+i*8,s=t.get(o);s?(n>0&&(e+=n,n=0),e+=ki(s)):n++,r===7&&(n>0&&(e+=n,n=0),i!==0&&(e+="/"))}return e},Nt=t=>Q.map(e=>tn(e).repeat(t[e])).join(""),bi=t=>Nt(t.white).toUpperCase()+Nt(t.black),vi=(t,e)=>{let n="";for(const i of Z){const r=a.backrank(i);let o=t.kingOf(i);v(o)&&!r.has(o)&&(o=void 0);const s=t.pieces(i,"rook").intersect(r);for(const c of e.intersect(r).reversed())if(c===s.first()&&v(o)&&c<o)n+=i==="white"?"Q":"q";else if(c===s.last()&&v(o)&&o<c)n+=i==="white"?"K":"k";else{const u=en[Y(c)];n+=i==="white"?u.toUpperCase():u}}return n||"-"},yi=t=>`${t.white}+${t.black}`,Ci=(t,e)=>[wi(t.board)+(t.pockets?`[${bi(t.pockets)}]`:""),t.turn[0],vi(t.board,t.castlingRights),v(t.epSquare)?we(t.epSquare):"-",...t.remainingChecks?[yi(t.remainingChecks)]:[],Math.max(0,Math.min(t.halfmoves,9999)),Math.max(1,Math.min(t.fullmoves,9999))].join(" "),Tt=(t,e)=>{const n=new Map,i=t.ctx();for(const[r,o]of t.allDests(i))if(o.nonEmpty()){const s=Array.from(o,we);r===i.king&&Y(r)===4&&(o.has(0)?s.push("c1"):o.has(56)&&s.push("c8"),o.has(7)?s.push("g1"):o.has(63)&&s.push("g8")),n.set(we(r),s)}return n},Bt=t=>De(t)?[we(t.to)]:[we(t.from),we(t.to)],Pi=(t,e)=>{const n=t.ctx(),i=e.match(/^([NBRQK])?([a-h])?([1-8])?[-x]?([a-h][1-8])(?:=?([nbrqkNBRQK]))?[+#]?$/);if(!i){let p;if(e==="O-O"||e==="O-O+"||e==="O-O#"?p="h":(e==="O-O-O"||e==="O-O-O+"||e==="O-O-O#")&&(p="a"),p){const k=t.castles.rook[t.turn][p];return!v(n.king)||!v(k)||!t.dests(n.king,n).has(k)?void 0:{from:n.king,to:k}}const f=e.match(/^([pnbrqkPNBRQK])?@([a-h][1-8])[+#]?$/);if(!f)return;const S={role:f[1]?ke(f[1]):"pawn",to:ie(f[2])};return t.isLegal(S,n)?S:void 0}const r=i[1]?ke(i[1]):"pawn",o=ie(i[4]),s=i[5]?ke(i[5]):void 0;if(!!s!==(r==="pawn"&&a.backranks().has(o))||s==="king"&&t.rules!=="antichess")return;let c=t.board.pieces(t.turn,r);r==="pawn"&&!i[2]?c=c.intersect(a.fromFile(Y(o))):i[2]&&(c=c.intersect(a.fromFile(i[2].charCodeAt(0)-97))),i[3]&&(c=c.intersect(a.fromRank(i[3].charCodeAt(0)-49)));const u=r==="pawn"?a.fromFile(Y(o)):a.empty();c=c.intersect(u.union(rn({color:A(t.turn),role:r},o,t.board.occupied)));let l;for(const p of c)if(t.dests(p,n).has(o)){if(v(l))return;l=p}if(v(l))return{from:l,to:o,promotion:s}};class ln extends ce{constructor(){super("crazyhouse")}reset(){super.reset(),this.pockets=ee.empty()}setupUnchecked(e){super.setupUnchecked(e),this.board.promoted=e.board.promoted.intersect(e.board.occupied).diff(e.board.king).diff(e.board.pawn),this.pockets=e.pockets?e.pockets.clone():ee.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return super.validate().chain(e=>{var n,i;return!((n=this.pockets)===null||n===void 0)&&n.count("king")?g.err(new B(T.Kings)):(((i=this.pockets)===null||i===void 0?void 0:i.size())||0)+this.board.occupied.size()>64?g.err(new B(T.Variant)):g.ok(void 0)})}hasInsufficientMaterial(e){return this.pockets?this.board.occupied.size()+this.pockets.size()<=3&&this.board.pawn.isEmpty()&&this.board.promoted.isEmpty()&&this.board.rooksAndQueens().isEmpty()&&this.pockets.count("pawn")<=0&&this.pockets.count("rook")<=0&&this.pockets.count("queen")<=0:super.hasInsufficientMaterial(e)}dropDests(e){var n,i;const r=this.board.occupied.complement().intersect(!((n=this.pockets)===null||n===void 0)&&n[this.turn].hasNonPawns()?a.full():!((i=this.pockets)===null||i===void 0)&&i[this.turn].hasPawns()?a.backranks().complement():a.empty());if(e=e||this.ctx(),v(e.king)&&e.checkers.nonEmpty()){const o=e.checkers.singleSquare();return v(o)?r.intersect(ye(o,e.king)):a.empty()}else return r}}class un extends ce{constructor(){super("atomic")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return g.err(new B(T.Empty));if(this.board.king.size()>2)return g.err(new B(T.Kings));const e=this.board.kingOf(A(this.turn));return v(e)?this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty()?g.err(new B(T.OppositeCheck)):a.backranks().intersects(this.board.pawn)?g.err(new B(T.PawnsOnBackrank)):g.ok(void 0):g.err(new B(T.Kings))}kingAttackers(e,n,i){const r=this.board.pieces(n,"king");return r.isEmpty()||ve(e).intersects(r)?a.empty():super.kingAttackers(e,n,i)}playCaptureAt(e,n){super.playCaptureAt(e,n),this.board.take(e);for(const i of ve(e).intersect(this.board.occupied).diff(this.board.pawn)){const r=this.board.take(i);(r==null?void 0:r.role)==="rook"&&this.castles.discardRook(i),(r==null?void 0:r.role)==="king"&&this.castles.discardColor(r.color)}}hasInsufficientMaterial(e){if(this.board.pieces(A(e),"king").isEmpty())return!1;if(this.board[e].diff(this.board.king).isEmpty())return!0;if(this.board[A(e)].diff(this.board.king).nonEmpty()){if(this.board.occupied.equals(this.board.bishop.union(this.board.king))){if(!this.board.bishop.intersect(this.board.white).intersects(a.darkSquares()))return!this.board.bishop.intersect(this.board.black).intersects(a.lightSquares());if(!this.board.bishop.intersect(this.board.white).intersects(a.lightSquares()))return!this.board.bishop.intersect(this.board.black).intersects(a.darkSquares())}return!1}return this.board.queen.nonEmpty()||this.board.pawn.nonEmpty()?!1:this.board.knight.union(this.board.bishop).union(this.board.rook).size()===1?!0:this.board.occupied.equals(this.board.knight.union(this.board.king))?this.board.knight.size()<=2:!1}dests(e,n){n=n||this.ctx();let i=a.empty();for(const r of at(this,e,n)){const o=this.clone();o.play({from:e,to:r});const s=o.board.kingOf(this.turn);v(s)&&(!v(o.board.kingOf(o.turn))||o.kingAttackers(s,o.turn,o.board.occupied).isEmpty())&&(i=i.with(r))}return i}isVariantEnd(){return!!this.variantOutcome()}variantOutcome(e){for(const n of Z)if(this.board.pieces(n,"king").isEmpty())return{winner:A(n)}}}class hn extends ce{constructor(){super("antichess")}reset(){super.reset(),this.castles=G.empty()}setupUnchecked(e){super.setupUnchecked(e),this.castles=G.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.board.occupied.isEmpty()?g.err(new B(T.Empty)):a.backranks().intersects(this.board.pawn)?g.err(new B(T.PawnsOnBackrank)):g.ok(void 0)}kingAttackers(e,n,i){return a.empty()}ctx(){const e=super.ctx();if(v(this.epSquare)&&Ce(A(this.turn),this.epSquare).intersects(this.board.pieces(this.turn,"pawn")))return e.mustCapture=!0,e;const n=this.board[A(this.turn)];for(const i of this.board[this.turn])if(at(this,i,e).intersects(n))return e.mustCapture=!0,e;return e}dests(e,n){n=n||this.ctx();const i=at(this,e,n),r=this.board[A(this.turn)];return i.intersect(n.mustCapture?v(this.epSquare)&&this.board.getRole(e)==="pawn"?r.with(this.epSquare):r:a.full())}hasInsufficientMaterial(e){if(this.board[e].isEmpty())return!1;if(this.board[A(e)].isEmpty())return!0;if(this.board.occupied.equals(this.board.bishop)){const n=this.board[e].intersects(a.lightSquares()),i=this.board[e].intersects(a.darkSquares()),r=this.board[A(e)].isDisjoint(a.lightSquares()),o=this.board[A(e)].isDisjoint(a.darkSquares());return n&&r||i&&o}return this.board.occupied.equals(this.board.knight)&&this.board.occupied.size()===2?this.board.white.intersects(a.lightSquares())!==this.board.black.intersects(a.darkSquares())!=(this.turn===e):!1}isVariantEnd(){return this.board[this.turn].isEmpty()}variantOutcome(e){if(e=e||this.ctx(),e.variantEnd||this.isStalemate(e))return{winner:this.turn}}}class dn extends ce{constructor(){super("kingofthehill")}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(e){return!1}isVariantEnd(){return this.board.king.intersects(a.center())}variantOutcome(e){for(const n of Z)if(this.board.pieces(n,"king").intersects(a.center()))return{winner:n}}}class fn extends ce{constructor(){super("3check")}reset(){super.reset(),this.remainingChecks=de.default()}setupUnchecked(e){var n;super.setupUnchecked(e),this.remainingChecks=((n=e.remainingChecks)===null||n===void 0?void 0:n.clone())||de.default()}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}hasInsufficientMaterial(e){return this.board.pieces(e,"king").equals(this.board[e])}isVariantEnd(){return!!this.remainingChecks&&(this.remainingChecks.white<=0||this.remainingChecks.black<=0)}variantOutcome(e){if(this.remainingChecks){for(const n of Z)if(this.remainingChecks[n]<=0)return{winner:n}}}}const Ei=()=>{const t=re.empty();return t.occupied=new a(65535,0),t.promoted=a.empty(),t.white=new a(61680,0),t.black=new a(3855,0),t.pawn=a.empty(),t.knight=new a(6168,0),t.bishop=new a(9252,0),t.rook=new a(16962,0),t.queen=new a(129,0),t.king=new a(33024,0),t};class pn extends ce{constructor(){super("racingkings")}reset(){this.board=Ei(),this.pockets=void 0,this.turn="white",this.castles=G.empty(),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}setupUnchecked(e){super.setupUnchecked(e),this.castles=G.empty()}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}validate(){return this.isCheck()||this.board.pawn.nonEmpty()?g.err(new B(T.Variant)):super.validate()}dests(e,n){if(n=n||this.ctx(),e===n.king)return super.dests(e,n);let i=a.empty();for(const r of super.dests(e,n)){const o={from:e,to:r},s=this.clone();s.play(o),s.isCheck()||(i=i.with(r))}return i}hasInsufficientMaterial(e){return!1}isVariantEnd(){const e=a.fromRank(7),n=this.board.king.intersect(e);if(n.isEmpty())return!1;if(this.turn==="white"||n.intersects(this.board.black))return!0;const i=this.board.kingOf("black");if(v(i)){const r=this.board.occupied.without(i);for(const o of ve(i).intersect(e).diff(this.board.black))if(this.kingAttackers(o,"white",r).isEmpty())return!1}return!0}variantOutcome(e){if(e?!e.variantEnd:!this.isVariantEnd())return;const n=a.fromRank(7),i=this.board.pieces("black","king").intersects(n),r=this.board.pieces("white","king").intersects(n);return i&&!r?{winner:"black"}:r&&!i?{winner:"white"}:{winner:void 0}}}const Si=()=>{const t=re.empty();return t.occupied=new a(4294967295,4294901862),t.promoted=a.empty(),t.white=new a(4294967295,102),t.black=new a(0,4294901760),t.pawn=new a(4294967295,16711782),t.knight=new a(0,1107296256),t.bishop=new a(0,603979776),t.rook=new a(0,2164260864),t.queen=new a(0,134217728),t.king=new a(0,268435456),t};class mn extends ce{constructor(){super("horde")}reset(){this.board=Si(),this.pockets=void 0,this.turn="white",this.castles=G.default(),this.castles.discardColor("white"),this.epSquare=void 0,this.remainingChecks=void 0,this.halfmoves=0,this.fullmoves=1}static default(){const e=new this;return e.reset(),e}static fromSetup(e){const n=new this;return n.setupUnchecked(e),n.validate().map(i=>n)}clone(){return super.clone()}validate(){if(this.board.occupied.isEmpty())return g.err(new B(T.Empty));if(this.board.king.size()!==1)return g.err(new B(T.Kings));const e=this.board.kingOf(A(this.turn));if(v(e)&&this.kingAttackers(e,this.turn,this.board.occupied).nonEmpty())return g.err(new B(T.OppositeCheck));for(const n of Z){const i=this.board.pieces(n,"king").isEmpty()?a.backrank(A(n)):a.backranks();if(this.board.pieces(n,"pawn").intersects(i))return g.err(new B(T.PawnsOnBackrank))}return g.ok(void 0)}hasInsufficientMaterial(e){if(this.board.pieces(e,"king").nonEmpty())return!1;const n=k=>k==="light"?"dark":"light",i=k=>k==="light"?a.lightSquares():a.darkSquares(),r=k=>{const h=this.board.pieces(k,"bishop");return h.intersects(a.darkSquares())&&h.intersects(a.lightSquares())},o=W.fromBoard(this.board,e),s=k=>i(k).intersect(this.board.pieces(e,"bishop")).size(),c=s("light")>=1?"light":"dark",u=o.pawn+o.knight+o.rook+o.queen+Math.min(s("dark"),2)+Math.min(s("light"),2),l=W.fromBoard(this.board,A(e)),p=k=>i(k).intersect(this.board.pieces(A(e),"bishop")).size(),f=l.size(),S=k=>f-k;if(u===0)return!0;if(u>=4||(o.pawn>=1||o.queen>=1)&&u>=2||o.rook>=1&&u>=2&&!(u===2&&o.rook===1&&o.bishop===1&&S(p(c))===1))return!1;if(u===1){if(f===1)return!0;if(o.queen===1)return!(l.pawn>=1||l.rook>=1||p("light")>=2||p("dark")>=2);if(o.pawn===1){const k=this.board.pieces(e,"pawn").last(),h=this.clone();h.board.set(k,{color:e,role:"queen"});const d=this.clone();return d.board.set(k,{color:e,role:"knight"}),h.hasInsufficientMaterial(e)&&d.hasInsufficientMaterial(e)}else{if(o.rook===1)return!(l.pawn>=2||l.rook>=1&&l.pawn>=1||l.rook>=1&&l.knight>=1||l.pawn>=1&&l.knight>=1);if(o.bishop===1)return!(p(n(c))>=2||p(n(c))>=1&&l.pawn>=1||l.pawn>=2);if(o.knight===1)return!(f>=4&&(l.knight>=2||l.pawn>=2||l.rook>=1&&l.knight>=1||l.rook>=1&&l.bishop>=1||l.knight>=1&&l.bishop>=1||l.rook>=1&&l.pawn>=1||l.knight>=1&&l.pawn>=1||l.bishop>=1&&l.pawn>=1||r(A(e))&&l.pawn>=1)&&(p("dark")<2||S(p("dark"))>=3)&&(p("light")<2||S(p("light"))>=3))}}else{if(u===2)return f===1?!0:o.knight===2?l.pawn+l.bishop+l.knight<1:r(e)?!(l.pawn>=1||l.bishop>=1||l.knight>=1&&l.rook+l.queen>=1):o.bishop>=1&&o.knight>=1?!(l.pawn>=1||p(n(c))>=1||S(p(c))>=3):!(l.pawn>=1&&p(n(c))>=1||l.pawn>=1&&l.knight>=1||p(n(c))>=1&&l.knight>=1||p(n(c))>=2||l.knight>=2||l.pawn>=2);if(u===3)return o.knight===2&&o.bishop===1||o.knight===3||r(e)?!1:f===1}return!0}isVariantEnd(){return this.board.white.isEmpty()||this.board.black.isEmpty()}variantOutcome(e){if(this.board.white.isEmpty())return{winner:"black"};if(this.board.black.isEmpty())return{winner:"white"}}}const Mi=t=>{switch(t){case"chess":return _e.default();case"antichess":return hn.default();case"atomic":return un.default();case"horde":return mn.default();case"racingkings":return pn.default();case"kingofthehill":return dn.default();case"3check":return fn.default();case"crazyhouse":return ln.default()}},xi=(t,e)=>{switch(t){case"chess":return _e.fromSetup(e);case"antichess":return hn.fromSetup(e);case"atomic":return un.fromSetup(e);case"horde":return mn.fromSetup(e);case"racingkings":return pn.fromSetup(e);case"kingofthehill":return dn.fromSetup(e);case"3check":return fn.fromSetup(e);case"crazyhouse":return ln.fromSetup(e)}},Ai=(t=kt)=>({headers:t(),moves:new gn});class gn{constructor(){this.children=[]}*mainlineNodes(){let e=this;for(;e.children.length;){const n=e.children[0];yield n,e=n}}*mainline(){for(const e of this.mainlineNodes())yield e.data}end(){let e=this;for(;e.children.length;)e=e.children[0];return e}}class Oi extends gn{constructor(e){super(),this.data=e}}const Ri=t=>t?t.winner==="white"?"1-0":t.winner==="black"?"0-1":"1/2-1/2":"*",zi=t=>t==="1-0"||t==="1–0"||t==="1—0"?{winner:"white"}:t==="0-1"||t==="0–1"||t==="0—1"?{winner:"black"}:t==="1/2-1/2"||t==="1/2–1/2"||t==="1/2—1/2"?{winner:void 0}:void 0,kt=()=>new Map([["Event","?"],["Site","?"],["Date","????.??.??"],["Round","?"],["White","?"],["Black","?"],["Result","*"]]),Dt="\uFEFF",je=t=>/^\s*$/.test(t),Qe=t=>t.startsWith("%");class Ni extends Error{}class Ti{constructor(e,n=kt,i=1e6){this.emitGame=e,this.initHeaders=n,this.maxBudget=i,this.lineBuf=[],this.resetGame(),this.state=0}resetGame(){this.budget=this.maxBudget,this.found=!1,this.state=1,this.game=Ai(this.initHeaders),this.stack=[{parent:this.game.moves,root:!0}],this.commentBuf=[]}consumeBudget(e){if(this.budget-=e,this.budget<0)throw new Ni("ERR_PGN_BUDGET")}parse(e,n){if(!(this.budget<0))try{let i=0;for(;;){const r=e.indexOf(`
`,i);if(r===-1)break;const o=r>i&&e[r-1]==="\r"?r-1:r;this.consumeBudget(r-i),this.lineBuf.push(e.slice(i,o)),i=r+1,this.handleLine()}this.consumeBudget(e.length-i),this.lineBuf.push(e.slice(i)),n!=null&&n.stream||(this.handleLine(),this.emit(void 0))}catch(i){this.emit(i)}}handleLine(){let e=!0,n=this.lineBuf.join("");this.lineBuf=[];e:for(;;)switch(this.state){case 0:n.startsWith(Dt)&&(n=n.slice(Dt.length)),this.state=1;case 1:if(je(n)||Qe(n))return;this.found=!0,this.state=2;case 2:{if(Qe(n))return;let i=!0;for(;i;)i=!1,n=n.replace(/^\s*\[([A-Za-z0-9][A-Za-z0-9_+#=:-]*)\s+"((?:[^"\\]|\\"|\\\\)*)"\]/,(r,o,s)=>(this.consumeBudget(200),this.handleHeader(o,s.replace(/\\"/g,'"').replace(/\\\\/g,"\\")),i=!0,e=!1,""));if(je(n))return;this.state=3}case 3:{if(e){if(Qe(n))return;if(je(n))return this.emit(void 0)}const i=/(?:[NBKRQ]?[a-h]?[1-8]?[-x]?[a-h][1-8](?:=?[nbrqkNBRQK])?|[pnbrqkPNBRQK]?@[a-h][1-8]|[O0o][-–—][O0o](?:[-–—][O0o])?)[+#]?|--|Z0|0000|@@@@|{|;|\$\d{1,4}|[?!]{1,2}|\(|\)|\*|1[-–—]0|0[-–—]1|1\/2[-–—]1\/2/g;let r;for(;r=i.exec(n);){const o=this.stack[this.stack.length-1];let s=r[0];if(s===";")return;if(s.startsWith("$"))this.handleNag(parseInt(s.slice(1),10));else if(s==="!")this.handleNag(1);else if(s==="?")this.handleNag(2);else if(s==="!!")this.handleNag(3);else if(s==="??")this.handleNag(4);else if(s==="!?")this.handleNag(5);else if(s==="?!")this.handleNag(6);else if(s==="1-0"||s==="1–0"||s==="1—0"||s==="0-1"||s==="0–1"||s==="0—1"||s==="1/2-1/2"||s==="1/2–1/2"||s==="1/2—1/2"||s==="*")this.stack.length===1&&s!=="*"&&this.handleHeader("Result",s);else if(s==="(")this.consumeBudget(100),this.stack.push({parent:o.parent,root:!1});else if(s===")")this.stack.length>1&&this.stack.pop();else if(s==="{"){const c=i.lastIndex,u=n[c]===" "?c+1:c;n=n.slice(u),this.state=4;continue e}else this.consumeBudget(100),s.startsWith("O")||s.startsWith("0")||s.startsWith("o")?s=s.replace(/[0o]/g,"O").replace(/[–—]/g,"-"):(s==="Z0"||s==="0000"||s==="@@@@")&&(s="--"),o.node&&(o.parent=o.node),o.node=new Oi({san:s,startingComments:o.startingComments}),o.startingComments=void 0,o.root=!1,o.parent.children.push(o.node)}return}case 4:{const i=n.indexOf("}");if(i===-1){this.commentBuf.push(n);return}else{const r=i>0&&n[i-1]===" "?i-1:i;this.commentBuf.push(n.slice(0,r)),this.handleComment(),n=n.slice(i),this.state=3,e=!1}}}}handleHeader(e,n){this.game.headers.set(e,e==="Result"?Ri(zi(n)):n)}handleNag(e){var n;this.consumeBudget(50);const i=this.stack[this.stack.length-1];i.node&&((n=i.node.data).nags||(n.nags=[]),i.node.data.nags.push(e))}handleComment(){var e,n;this.consumeBudget(100);const i=this.stack[this.stack.length-1],r=this.commentBuf.join(`
`);this.commentBuf=[],i.node?((e=i.node.data).comments||(e.comments=[]),i.node.data.comments.push(r)):i.root?((n=this.game).comments||(n.comments=[]),this.game.comments.push(r)):(i.startingComments||(i.startingComments=[]),i.startingComments.push(r))}emit(e){if(this.state===4&&this.handleComment(),e)return this.emitGame(this.game,e);this.found&&this.emitGame(this.game,void 0),this.resetGame()}}const Bi=(t,e=kt)=>{const n=[];return new Ti(i=>n.push(i),e,NaN).parse(t),n},Di=t=>{switch((t||"chess").toLowerCase()){case"chess":case"chess960":case"chess 960":case"standard":case"from position":case"classical":case"normal":case"fischerandom":case"fischerrandom":case"fischer random":case"wild/0":case"wild/1":case"wild/2":case"wild/3":case"wild/4":case"wild/5":case"wild/6":case"wild/7":case"wild/8":case"wild/8a":return"chess";case"crazyhouse":case"crazy house":case"house":case"zh":return"crazyhouse";case"king of the hill":case"koth":case"kingofthehill":return"kingofthehill";case"three-check":case"three check":case"threecheck":case"three check chess":case"3-check":case"3 check":case"3check":return"3check";case"antichess":case"anti chess":case"anti":return"antichess";case"atomic":case"atom":case"atomic chess":return"atomic";case"horde":case"horde chess":return"horde";case"racing kings":case"racingkings":case"racing":case"race":return"racingkings";default:return}},Ki=t=>{const e=Di(t.get("Variant"));if(!e)return g.err(new B(T.Variant));const n=t.get("FEN");return n?an(n).chain(i=>xi(e,i)):g.ok(Mi(e))};class _i{constructor(e){V(this,"_promotion");V(this,"_isPromotionOpen",!1);this.redraw=e}get promotion(){return this._promotion}set promotion(e){this._promotion=e}isOpen(){return this._isPromotionOpen}close(){this._isPromotionOpen=!1}async open(e,n,i){const r=await new Promise(o=>{this.promotion={dest:e,orig:n,color:i,resolve:o},this._isPromotionOpen=!0,this.redraw()});return this.close(),this.promotion=void 0,this.redraw(),r}applyPromotion(e,n,i,r,o){"promotion"in r&&(r.promotion=i,n.role=i,n.promoted=!0,o.setPieces(new Map([[e,n]])))}isPromotion(e,n){return n.role==="pawn"&&(n.color==="white"&&e[1]==="8"||n.color==="black"&&e[1]==="1")}}class Li{constructor(e,n){V(this,"ground");V(this,"pos");V(this,"promotionHandler");V(this,"puzzleMainMoves");V(this,"currentPuzzleMove",0);V(this,"colorToPlay");this.redraw=n,this.promotionHandler=new _i(n);const r=Bi(e)[0],o=Ki(r.headers).unwrap();this.puzzleMainMoves=[];for(const c of r.moves.mainline()){const u=Pi(o,c.san);if(!u)throw new Error(`Invalid move in pgn: ${c.san}`);o.play(u),this.puzzleMainMoves.push(u)}const s=this.getInitialPosition(r);this.pos=s.pos,this.colorToPlay=s.color}getInitialPosition(e){const n=e.headers.get("FEN");let i;if(!n)i=_e.fromSetup(pi()).unwrap();else{const r=an(n).unwrap();i=_e.fromSetup(r).unwrap()}return{pos:i,color:i.turn}}setGround(e){this.ground=e,this.setBoardToPosition(!0)}cgState(){return{orientation:this.colorToPlay,movable:{free:!1,dests:Tt(this.pos),events:{after:(e,n,i)=>this.handleMove(e,n)}}}}isPromotionPromptOpened(){return this.promotionHandler.isOpen()}resolvePromotion(e){if(this.isPromotionPromptOpened()){const n={from:ie(this.promotionHandler.promotion.orig),to:ie(this.promotionHandler.promotion.dest),promotion:e};return this.isPuzzleMove(n)?(this.makeMove(n),this.makeOpponentMove()):this.handleBlunderMove(this.promotionHandler.promotion.dest),this.promotionHandler.promotion.resolve(e)}else throw new Error("Trying to resolve promotion when promotion prompt is not opened")}isPuzzleMove(e){const n=this.puzzleMainMoves[this.currentPuzzleMove];return e.from==n.from&&e.to==n.to&&e.promotion==n.promotion}makeOpponentMove(){this.currentPuzzleMove++,!(this.currentPuzzleMove>=this.puzzleMainMoves.length)&&setTimeout(()=>{var n;const e=Bt(this.puzzleMainMoves[this.currentPuzzleMove]);(n=this.ground)==null||n.move(e[0],e[1]),this.handleMove(e[0],e[1],!0),this.currentPuzzleMove++},200)}handleMove(e,n,i=!1){const r=`${e}${n}`,o=ii(r);if(!o)return;const s=this.ground.state.pieces.get(n);if(s){if(this.promotionHandler.isPromotion(n,s)){this.handlePromotion(n,e,s,o);return}if(this.handleEnPassant(e,n),i)this.makeMove(o,i);else{if(this.currentPuzzleMove>=this.puzzleMainMoves.length)return;this.isPuzzleMove(o)?(this.makeMove(o,i),this.makeOpponentMove()):this.handleBlunderMove(n)}}}handleBlunderMove(e){var n;(n=this.ground)==null||n.setAutoShapes([{orig:e,customSvg:{html:_t["✗"]}}]),setTimeout(()=>{this.setBoardToPosition()},300)}cancelPromotion(){if(this.isPromotionPromptOpened())return this.promotionHandler.promotion.resolve(null);throw new Error("Trying to resolve promotion when promotion prompt is not opened")}getPromotionDest(){if(this.isPromotionPromptOpened())return this.promotionHandler.promotion.dest;throw new Error("Trying to get promotion dest when promotion prompt is not opened")}getPromotionColor(){if(this.isPromotionPromptOpened())return this.promotionHandler.promotion.color;throw new Error("Trying to get promotion color when promotion prompt is not opened")}async handlePromotion(e,n,i,r){const o=await this.promotionHandler.open(e,n,i.color);o?this.promotionHandler.applyPromotion(e,i,o,r,this.ground):this.setBoardToPosition()}handleEnPassant(e,n){const i=this.getEnPassantCaptureSquare(e,n,r=>this.pos.board.get(ie(r)));i&&this.ground.setPieces(new Map([[i,void 0]]))}getEnPassantCaptureSquare(e,n,i){const r=i(e);if(!r||r.role!=="pawn")return;const o=e.charCodeAt(0),s=n.charCodeAt(0);if(Math.abs(o-s)===1&&!i(n)){const c=parseInt(n[1]),u=r.color==="white"?c-1:c+1;return String.fromCharCode(s)+u}}makeMove(e,n=!1){var i,r;this.pos.play(e),this.updateLegalMoves(),n?(r=this.ground)==null||r.setAutoShapes([]):(i=this.ground)==null||i.setAutoShapes([{orig:Bt(e)[1],customSvg:{html:_t["✓"]}}])}setBoardToPosition(e=!1){var n;e&&this.ground.set({animation:{enabled:!1}}),this.ground.set({fen:Ci(this.pos.toSetup())}),this.updateLegalMoves(),(n=this.ground)==null||n.setAutoShapes([]),e&&this.ground.set({animation:{enabled:!0}})}updateLegalMoves(){this.ground.set({movable:{dests:Tt(this.pos)}})}}const Kt=t=>`<defs><filter id="shadow"><feDropShadow dx="4" dy="7" stdDeviation="5" flood-opacity="0.5" /></filter></defs>
  <g transform="translate(60 0) scale(0.4)">${t}</g>`,_t={"✓":Kt(`
  <circle style="fill:#22ac38;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M87 32.8q0 2-1.4 3.2L51 70.6 44.6 77q-1.7 1.3-3.4 1.3-1.8 0-3.1-1.3L14.3 53.3Q13 52 13 50q0-2 1.3-3.2l6.4-6.5Q22.4 39 24 39q1.9 0 3.2 1.3l14 14L72.7 23q1.3-1.3 3.2-1.3 1.6 0 3.3 1.3l6.4 6.5q1.3 1.4 1.3 3.4z"/>
`),"✗":Kt(`
  <circle style="fill:#df5353;filter:url(#shadow)" cx="50" cy="50" r="50" />
  <path fill="#fff" d="M79.4 68q0 1.8-1.4 3.2l-6.7 6.7q-1.4 1.4-3.5 1.4-1.9 0-3.3-1.4L50 63.4 35.5 78q-1.4 1.4-3.3 1.4-2 0-3.5-1.4L22 71.2q-1.4-1.4-1.4-3.3 0-1.7 1.4-3.5L36.5 50 22 35.4Q20.6 34 20.6 32q0-1.7 1.4-3.5l6.7-6.5q1.2-1.4 3.5-1.4 2 0 3.3 1.4L50 36.6 64.5 22q1.2-1.4 3.3-1.4 2.3 0 3.5 1.4l6.7 6.5q1.4 1.8 1.4 3.5 0 2-1.4 3.3L63.5 49.9 78 64.4q1.4 1.8 1.4 3.5z"/>
`)},qi=["white","black"],qe=["a","b","c","d","e","f","g","h"],Ie=["1","2","3","4","5","6","7","8"],Ii=[...Ie].reverse(),wt=Array.prototype.concat(...qe.map(t=>Ie.map(e=>t+e))),F=t=>wt[8*t[0]+t[1]],N=t=>[t.charCodeAt(0)-97,t.charCodeAt(1)-49],kn=wt.map(N);function $i(t){let e;const n=()=>(e===void 0&&(e=t()),e);return n.clear=()=>{e=void 0},n}const Hi=()=>{let t;return{start(){t=performance.now()},cancel(){t=void 0},stop(){if(!t)return 0;const e=performance.now()-t;return t=void 0,e}}},bt=t=>t==="white"?"black":"white",Ae=(t,e)=>{const n=t[0]-e[0],i=t[1]-e[1];return n*n+i*i},lt=(t,e)=>t.role===e.role&&t.color===e.color,ze=t=>(e,n)=>[(n?e[0]:7-e[0])*t.width/8,(n?7-e[1]:e[1])*t.height/8],X=(t,e)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px)`},wn=(t,e,n=1)=>{t.style.transform=`translate(${e[0]}px,${e[1]}px) scale(${n})`},vt=(t,e)=>{t.style.visibility=e?"visible":"hidden"},pe=t=>{var e;if(t.clientX||t.clientX===0)return[t.clientX,t.clientY];if(!((e=t.targetTouches)===null||e===void 0)&&e[0])return[t.targetTouches[0].clientX,t.targetTouches[0].clientY]},bn=t=>t.button===2,te=(t,e)=>{const n=document.createElement(t);return e&&(n.className=e),n};function vn(t,e,n){const i=N(t);return e||(i[0]=7-i[0],i[1]=7-i[1]),[n.left+n.width*i[0]/8+n.width/16,n.top+n.height*(7-i[1])/8+n.height/16]}const fe=(t,e)=>Math.abs(t-e),Fi=t=>(e,n,i,r)=>fe(e,i)<2&&(t==="white"?r===n+1||n<=1&&r===n+2&&e===i:r===n-1||n>=6&&r===n-2&&e===i),yn=(t,e,n,i)=>{const r=fe(t,n),o=fe(e,i);return r===1&&o===2||r===2&&o===1},Cn=(t,e,n,i)=>fe(t,n)===fe(e,i),Pn=(t,e,n,i)=>t===n||e===i,En=(t,e,n,i)=>Cn(t,e,n,i)||Pn(t,e,n,i),Wi=(t,e,n)=>(i,r,o,s)=>fe(i,o)<2&&fe(r,s)<2||n&&r===s&&r===(t==="white"?0:7)&&(i===4&&(o===2&&e.includes(0)||o===6&&e.includes(7))||e.includes(o));function Gi(t,e){const n=e==="white"?"1":"8",i=[];for(const[r,o]of t)r[1]===n&&o.color===e&&o.role==="rook"&&i.push(N(r)[0]);return i}function Sn(t,e,n){const i=t.get(e);if(!i)return[];const r=N(e),o=i.role,s=o==="pawn"?Fi(i.color):o==="knight"?yn:o==="bishop"?Cn:o==="rook"?Pn:o==="queen"?En:Wi(i.color,Gi(t,i.color),n);return kn.filter(c=>(r[0]!==c[0]||r[1]!==c[1])&&s(r[0],r[1],c[0],c[1])).map(F)}function $(t,...e){t&&setTimeout(()=>t(...e),1)}function Ui(t){t.orientation=bt(t.orientation),t.animation.current=t.draggable.current=t.selected=void 0}function ji(t,e){for(const[n,i]of e)i?t.pieces.set(n,i):t.pieces.delete(n)}function Qi(t,e){if(t.check=void 0,e===!0&&(e=t.turnColor),e)for(const[n,i]of t.pieces)i.role==="king"&&i.color===e&&(t.check=n)}function Zi(t,e,n,i){le(t),t.premovable.current=[e,n],$(t.premovable.events.set,e,n,i)}function ae(t){t.premovable.current&&(t.premovable.current=void 0,$(t.premovable.events.unset))}function Xi(t,e,n){ae(t),t.predroppable.current={role:e,key:n},$(t.predroppable.events.set,e,n)}function le(t){const e=t.predroppable;e.current&&(e.current=void 0,$(e.events.unset))}function Yi(t,e,n){if(!t.autoCastle)return!1;const i=t.pieces.get(e);if(!i||i.role!=="king")return!1;const r=N(e),o=N(n);if(r[1]!==0&&r[1]!==7||r[1]!==o[1])return!1;r[0]===4&&!t.pieces.has(n)&&(o[0]===6?n=F([7,o[1]]):o[0]===2&&(n=F([0,o[1]])));const s=t.pieces.get(n);return!s||s.color!==i.color||s.role!=="rook"?!1:(t.pieces.delete(e),t.pieces.delete(n),r[0]<o[0]?(t.pieces.set(F([6,o[1]]),i),t.pieces.set(F([5,o[1]]),s)):(t.pieces.set(F([2,o[1]]),i),t.pieces.set(F([3,o[1]]),s)),!0)}function Mn(t,e,n){const i=t.pieces.get(e),r=t.pieces.get(n);if(e===n||!i)return!1;const o=r&&r.color!==i.color?r:void 0;return n===t.selected&&U(t),$(t.events.move,e,n,o),Yi(t,e,n)||(t.pieces.set(n,i),t.pieces.delete(e)),t.lastMove=[e,n],t.check=void 0,$(t.events.change),o||!0}function yt(t,e,n,i){if(t.pieces.has(n))if(i)t.pieces.delete(n);else return!1;return $(t.events.dropNewPiece,e,n),t.pieces.set(n,e),t.lastMove=[n],t.check=void 0,$(t.events.change),t.movable.dests=void 0,t.turnColor=bt(t.turnColor),!0}function xn(t,e,n){const i=Mn(t,e,n);return i&&(t.movable.dests=void 0,t.turnColor=bt(t.turnColor),t.animation.current=void 0),i}function An(t,e,n){if(Ct(t,e,n)){const i=xn(t,e,n);if(i){const r=t.hold.stop();U(t);const o={premove:!1,ctrlKey:t.stats.ctrlKey,holdTime:r};return i!==!0&&(o.captured=i),$(t.movable.events.after,e,n,o),!0}}else if(Ji(t,e,n))return Zi(t,e,n,{ctrlKey:t.stats.ctrlKey}),U(t),!0;return U(t),!1}function On(t,e,n,i){const r=t.pieces.get(e);r&&(Vi(t,e,n)||i)?(t.pieces.delete(e),yt(t,r,n,i),$(t.movable.events.afterNewPiece,r.role,n,{premove:!1,predrop:!1})):r&&er(t,e,n)?Xi(t,r.role,n):(ae(t),le(t)),t.pieces.delete(e),U(t)}function ut(t,e,n){if($(t.events.select,e),t.selected){if(t.selected===e&&!t.draggable.enabled){U(t),t.hold.cancel();return}else if((t.selectable.enabled||n)&&t.selected!==e&&An(t,t.selected,e)){t.stats.dragged=!1;return}}(t.selectable.enabled||t.draggable.enabled)&&(zn(t,e)||Pt(t,e))&&(Rn(t,e),t.hold.start())}function Rn(t,e){t.selected=e,Pt(t,e)?t.premovable.customDests||(t.premovable.dests=Sn(t.pieces,e,t.premovable.castle)):t.premovable.dests=void 0}function U(t){t.selected=void 0,t.premovable.dests=void 0,t.hold.cancel()}function zn(t,e){const n=t.pieces.get(e);return!!n&&(t.movable.color==="both"||t.movable.color===n.color&&t.turnColor===n.color)}const Ct=(t,e,n)=>{var i,r;return e!==n&&zn(t,e)&&(t.movable.free||!!(!((r=(i=t.movable.dests)===null||i===void 0?void 0:i.get(e))===null||r===void 0)&&r.includes(n)))};function Vi(t,e,n){const i=t.pieces.get(e);return!!i&&(e===n||!t.pieces.has(n))&&(t.movable.color==="both"||t.movable.color===i.color&&t.turnColor===i.color)}function Pt(t,e){const n=t.pieces.get(e);return!!n&&t.premovable.enabled&&t.movable.color===n.color&&t.turnColor!==n.color}function Ji(t,e,n){var i,r;const o=(r=(i=t.premovable.customDests)===null||i===void 0?void 0:i.get(e))!==null&&r!==void 0?r:Sn(t.pieces,e,t.premovable.castle);return e!==n&&Pt(t,e)&&o.includes(n)}function er(t,e,n){const i=t.pieces.get(e),r=t.pieces.get(n);return!!i&&(!r||r.color!==t.movable.color)&&t.predroppable.enabled&&(i.role!=="pawn"||n[1]!=="1"&&n[1]!=="8")&&t.movable.color===i.color&&t.turnColor!==i.color}function tr(t,e){const n=t.pieces.get(e);return!!n&&t.draggable.enabled&&(t.movable.color==="both"||t.movable.color===n.color&&(t.turnColor===n.color||t.premovable.enabled))}function nr(t){const e=t.premovable.current;if(!e)return!1;const n=e[0],i=e[1];let r=!1;if(Ct(t,n,i)){const o=xn(t,n,i);if(o){const s={premove:!0};o!==!0&&(s.captured=o),$(t.movable.events.after,n,i,s),r=!0}}return ae(t),r}function ir(t,e){const n=t.predroppable.current;let i=!1;if(!n)return!1;if(e(n)){const r={role:n.role,color:t.movable.color};yt(t,r,n.key)&&($(t.movable.events.afterNewPiece,n.role,n.key,{premove:!1,predrop:!0}),i=!0)}return le(t),i}function Et(t){ae(t),le(t),U(t)}function Lt(t){t.movable.color=t.movable.dests=t.animation.current=void 0,Et(t)}function me(t,e,n){let i=Math.floor(8*(t[0]-n.left)/n.width);e||(i=7-i);let r=7-Math.floor(8*(t[1]-n.top)/n.height);return e||(r=7-r),i>=0&&i<8&&r>=0&&r<8?F([i,r]):void 0}function rr(t,e,n,i){const r=N(t),o=kn.filter(l=>En(r[0],r[1],l[0],l[1])||yn(r[0],r[1],l[0],l[1])),c=o.map(l=>vn(F(l),n,i)).map(l=>Ae(e,l)),[,u]=c.reduce((l,p,f)=>l[0]<p?l:[p,f],[c[0],0]);return F(o[u])}const H=t=>t.orientation==="white",Nn="rnbqkbnr/pppppppp/8/8/8/8/PPPPPPPP/RNBQKBNR",or={p:"pawn",r:"rook",n:"knight",b:"bishop",q:"queen",k:"king"},sr={pawn:"p",rook:"r",knight:"n",bishop:"b",queen:"q",king:"k"};function Tn(t){t==="start"&&(t=Nn);const e=new Map;let n=7,i=0;for(const r of t)switch(r){case" ":case"[":return e;case"/":if(--n,n<0)return e;i=0;break;case"~":{const o=e.get(F([i-1,n]));o&&(o.promoted=!0);break}default:{const o=r.charCodeAt(0);if(o<57)i+=o-48;else{const s=r.toLowerCase();e.set(F([i,n]),{role:or[s],color:r===s?"black":"white"}),++i}}}return e}function cr(t){return Ii.map(e=>qe.map(n=>{const i=t.get(n+e);if(i){let r=sr[i.role];return i.color==="white"&&(r=r.toUpperCase()),i.promoted&&(r+="~"),r}else return"1"}).join("")).join("/").replace(/1{2,}/g,e=>e.length.toString())}function Bn(t,e){e.animation&&(St(t.animation,e.animation),(t.animation.duration||0)<70&&(t.animation.enabled=!1))}function Dn(t,e){var n,i,r;if(!((n=e.movable)===null||n===void 0)&&n.dests&&(t.movable.dests=void 0),!((i=e.drawable)===null||i===void 0)&&i.autoShapes&&(t.drawable.autoShapes=[]),St(t,e),e.fen&&(t.pieces=Tn(e.fen),t.drawable.shapes=((r=e.drawable)===null||r===void 0?void 0:r.shapes)||[]),"check"in e&&Qi(t,e.check||!1),"lastMove"in e&&!e.lastMove?t.lastMove=void 0:e.lastMove&&(t.lastMove=e.lastMove),t.selected&&Rn(t,t.selected),Bn(t,e),!t.movable.rookCastle&&t.movable.dests){const o=t.movable.color==="white"?"1":"8",s="e"+o,c=t.movable.dests.get(s),u=t.pieces.get(s);if(!c||!u||u.role!=="king")return;t.movable.dests.set(s,c.filter(l=>!(l==="a"+o&&c.includes("c"+o))&&!(l==="h"+o&&c.includes("g"+o))))}}function St(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&(Object.prototype.hasOwnProperty.call(t,n)&&qt(t[n])&&qt(e[n])?St(t[n],e[n]):t[n]=e[n])}function qt(t){if(typeof t!="object"||t===null)return!1;const e=Object.getPrototypeOf(t);return e===Object.prototype||e===null}const ue=(t,e)=>e.animation.enabled?ur(t,e):oe(t,e);function oe(t,e){const n=t(e);return e.dom.redraw(),n}const Ze=(t,e)=>({key:t,pos:N(t),piece:e}),ar=(t,e)=>e.sort((n,i)=>Ae(t.pos,n.pos)-Ae(t.pos,i.pos))[0];function lr(t,e){const n=new Map,i=[],r=new Map,o=[],s=[],c=new Map;let u,l,p;for(const[f,S]of t)c.set(f,Ze(f,S));for(const f of wt)u=e.pieces.get(f),l=c.get(f),u?l?lt(u,l.piece)||(o.push(l),s.push(Ze(f,u))):s.push(Ze(f,u)):l&&o.push(l);for(const f of s)l=ar(f,o.filter(S=>lt(f.piece,S.piece))),l&&(p=[l.pos[0]-f.pos[0],l.pos[1]-f.pos[1]],n.set(f.key,p.concat(p)),i.push(l.key));for(const f of o)i.includes(f.key)||r.set(f.key,f.piece);return{anims:n,fadings:r}}function Kn(t,e){const n=t.animation.current;if(n===void 0){t.dom.destroyed||t.dom.redrawNow();return}const i=1-(e-n.start)*n.frequency;if(i<=0)t.animation.current=void 0,t.dom.redrawNow();else{const r=hr(i);for(const o of n.plan.anims.values())o[2]=o[0]*r,o[3]=o[1]*r;t.dom.redrawNow(!0),requestAnimationFrame((o=performance.now())=>Kn(t,o))}}function ur(t,e){const n=new Map(e.pieces),i=t(e),r=lr(n,e);if(r.anims.size||r.fadings.size){const o=e.animation.current&&e.animation.current.start;e.animation.current={start:performance.now(),frequency:1/e.animation.duration,plan:r},o||Kn(e,performance.now())}else e.dom.redraw();return i}const hr=t=>t<.5?4*t*t*t:(t-1)*(2*t-2)*(2*t-2)+1,dr=["green","red","blue","yellow"];function fr(t,e){if(e.touches&&e.touches.length>1)return;e.stopPropagation(),e.preventDefault(),e.ctrlKey?U(t):Et(t);const n=pe(e),i=me(n,H(t),t.dom.bounds());i&&(t.drawable.current={orig:i,pos:n,brush:kr(e),snapToValidMove:t.drawable.defaultSnapToValidMove},_n(t))}function _n(t){requestAnimationFrame(()=>{const e=t.drawable.current;if(e){const n=me(e.pos,H(t),t.dom.bounds());n||(e.snapToValidMove=!1);const i=e.snapToValidMove?rr(e.orig,e.pos,H(t),t.dom.bounds()):n;i!==e.mouseSq&&(e.mouseSq=i,e.dest=i!==e.orig?i:void 0,t.dom.redrawNow()),_n(t)}})}function pr(t,e){t.drawable.current&&(t.drawable.current.pos=pe(e))}function mr(t){const e=t.drawable.current;e&&(e.mouseSq&&wr(t.drawable,e),Ln(t))}function Ln(t){t.drawable.current&&(t.drawable.current=void 0,t.dom.redraw())}function gr(t){t.drawable.shapes.length&&(t.drawable.shapes=[],t.dom.redraw(),qn(t.drawable))}function kr(t){var e;const n=(t.shiftKey||t.ctrlKey)&&bn(t),i=t.altKey||t.metaKey||((e=t.getModifierState)===null||e===void 0?void 0:e.call(t,"AltGraph"));return dr[(n?1:0)+(i?2:0)]}function wr(t,e){const n=r=>r.orig===e.orig&&r.dest===e.dest,i=t.shapes.find(n);i&&(t.shapes=t.shapes.filter(r=>!n(r))),(!i||i.brush!==e.brush)&&t.shapes.push({orig:e.orig,dest:e.dest,brush:e.brush}),qn(t)}function qn(t){t.onChange&&t.onChange(t.shapes)}function br(t,e){if(!(t.trustAllEvents||e.isTrusted)||e.buttons!==void 0&&e.buttons>1||e.touches&&e.touches.length>1)return;const n=t.dom.bounds(),i=pe(e),r=me(i,H(t),n);if(!r)return;const o=t.pieces.get(r),s=t.selected;if(!s&&t.drawable.enabled&&(t.drawable.eraseOnClick||!o||o.color!==t.turnColor)&&gr(t),e.cancelable!==!1&&(!e.touches||t.blockTouchScroll||o||s||vr(t,i)))e.preventDefault();else if(e.touches)return;const c=!!t.premovable.current,u=!!t.predroppable.current;t.stats.ctrlKey=e.ctrlKey,t.selected&&Ct(t,t.selected,r)?ue(f=>ut(f,r),t):ut(t,r);const l=t.selected===r,p=$n(t,r);if(o&&p&&l&&tr(t,r)){t.draggable.current={orig:r,piece:o,origPos:i,pos:i,started:t.draggable.autoDistance&&t.stats.dragged,element:p,previouslySelected:s,originTarget:e.target,keyHasChanged:!1},p.cgDragging=!0,p.classList.add("dragging");const f=t.dom.elements.ghost;f&&(f.className=`ghost ${o.color} ${o.role}`,X(f,ze(n)(N(r),H(t))),vt(f,!0)),Mt(t)}else c&&ae(t),u&&le(t);t.dom.redraw()}function vr(t,e){const n=H(t),i=t.dom.bounds(),r=Math.pow(i.width/8,2);for(const o of t.pieces.keys()){const s=vn(o,n,i);if(Ae(s,e)<=r)return!0}return!1}function yr(t,e,n,i){const r="a0";t.pieces.set(r,e),t.dom.redraw();const o=pe(n);t.draggable.current={orig:r,piece:e,origPos:o,pos:o,started:!0,element:()=>$n(t,r),originTarget:n.target,newPiece:!0,force:!!i,keyHasChanged:!1},Mt(t)}function Mt(t){requestAnimationFrame(()=>{var e;const n=t.draggable.current;if(!n)return;!((e=t.animation.current)===null||e===void 0)&&e.plan.anims.has(n.orig)&&(t.animation.current=void 0);const i=t.pieces.get(n.orig);if(!i||!lt(i,n.piece))$e(t);else if(!n.started&&Ae(n.pos,n.origPos)>=Math.pow(t.draggable.distance,2)&&(n.started=!0),n.started){if(typeof n.element=="function"){const o=n.element();if(!o)return;o.cgDragging=!0,o.classList.add("dragging"),n.element=o}const r=t.dom.bounds();X(n.element,[n.pos[0]-r.left-r.width/16,n.pos[1]-r.top-r.height/16]),n.keyHasChanged||(n.keyHasChanged=n.orig!==me(n.pos,H(t),r))}Mt(t)})}function Cr(t,e){t.draggable.current&&(!e.touches||e.touches.length<2)&&(t.draggable.current.pos=pe(e))}function Pr(t,e){const n=t.draggable.current;if(!n)return;if(e.type==="touchend"&&e.cancelable!==!1&&e.preventDefault(),e.type==="touchend"&&n.originTarget!==e.target&&!n.newPiece){t.draggable.current=void 0;return}ae(t),le(t);const i=pe(e)||n.pos,r=me(i,H(t),t.dom.bounds());r&&n.started&&n.orig!==r?n.newPiece?On(t,n.orig,r,n.force):(t.stats.ctrlKey=e.ctrlKey,An(t,n.orig,r)&&(t.stats.dragged=!0)):n.newPiece?t.pieces.delete(n.orig):t.draggable.deleteOnDropOff&&!r&&(t.pieces.delete(n.orig),$(t.events.change)),(n.orig===n.previouslySelected||n.keyHasChanged)&&(n.orig===r||!r)?U(t):t.selectable.enabled||U(t),In(t),t.draggable.current=void 0,t.dom.redraw()}function $e(t){const e=t.draggable.current;e&&(e.newPiece&&t.pieces.delete(e.orig),t.draggable.current=void 0,U(t),In(t),t.dom.redraw())}function In(t){const e=t.dom.elements;e.ghost&&vt(e.ghost,!1)}function $n(t,e){let n=t.dom.elements.board.firstChild;for(;n;){if(n.cgKey===e&&n.tagName==="PIECE")return n;n=n.nextSibling}}function Er(t,e){t.exploding={stage:1,keys:e},t.dom.redraw(),setTimeout(()=>{It(t,2),setTimeout(()=>It(t,void 0),120)},120)}function It(t,e){t.exploding&&(e?t.exploding.stage=e:t.exploding=void 0,t.dom.redraw())}function Sr(t,e){function n(){Ui(t),e()}return{set(i){i.orientation&&i.orientation!==t.orientation&&n(),Bn(t,i),(i.fen?ue:oe)(r=>Dn(r,i),t)},state:t,getFen:()=>cr(t.pieces),toggleOrientation:n,setPieces(i){ue(r=>ji(r,i),t)},selectSquare(i,r){i?ue(o=>ut(o,i,r),t):t.selected&&(U(t),t.dom.redraw())},move(i,r){ue(o=>Mn(o,i,r),t)},newPiece(i,r){ue(o=>yt(o,i,r),t)},playPremove(){if(t.premovable.current){if(ue(nr,t))return!0;t.dom.redraw()}return!1},playPredrop(i){if(t.predroppable.current){const r=ir(t,i);return t.dom.redraw(),r}return!1},cancelPremove(){oe(ae,t)},cancelPredrop(){oe(le,t)},cancelMove(){oe(i=>{Et(i),$e(i)},t)},stop(){oe(i=>{Lt(i),$e(i)},t)},explode(i){Er(t,i)},setAutoShapes(i){oe(r=>r.drawable.autoShapes=i,t)},setShapes(i){oe(r=>r.drawable.shapes=i,t)},getKeyAtDomPos(i){return me(i,H(t),t.dom.bounds())},redrawAll:e,dragNewPiece(i,r,o){yr(t,i,r,o)},destroy(){Lt(t),t.dom.unbind&&t.dom.unbind(),t.dom.destroyed=!0}}}function Mr(){return{pieces:Tn(Nn),orientation:"white",turnColor:"white",coordinates:!0,coordinatesOnSquares:!1,ranksPosition:"right",autoCastle:!0,viewOnly:!1,disableContextMenu:!1,addPieceZIndex:!1,blockTouchScroll:!1,pieceKey:!1,trustAllEvents:!1,highlight:{lastMove:!0,check:!0},animation:{enabled:!0,duration:200},movable:{free:!0,color:"both",showDests:!0,events:{},rookCastle:!0},premovable:{enabled:!0,showDests:!0,castle:!0,events:{}},predroppable:{enabled:!1,events:{}},draggable:{enabled:!0,distance:3,autoDistance:!0,showGhost:!0,deleteOnDropOff:!1},dropmode:{active:!1},selectable:{enabled:!0},stats:{dragged:!("ontouchstart"in window)},events:{},drawable:{enabled:!0,visible:!0,defaultSnapToValidMove:!0,eraseOnClick:!0,shapes:[],autoShapes:[],brushes:{green:{key:"g",color:"#15781B",opacity:1,lineWidth:10},red:{key:"r",color:"#882020",opacity:1,lineWidth:10},blue:{key:"b",color:"#003088",opacity:1,lineWidth:10},yellow:{key:"y",color:"#e68f00",opacity:1,lineWidth:10},paleBlue:{key:"pb",color:"#003088",opacity:.4,lineWidth:15},paleGreen:{key:"pg",color:"#15781B",opacity:.4,lineWidth:15},paleRed:{key:"pr",color:"#882020",opacity:.4,lineWidth:15},paleGrey:{key:"pgr",color:"#4a4a4a",opacity:.35,lineWidth:15},purple:{key:"purple",color:"#68217a",opacity:.65,lineWidth:10},pink:{key:"pink",color:"#ee2080",opacity:.5,lineWidth:10},white:{key:"white",color:"white",opacity:1,lineWidth:10}},prevSvgHash:""},hold:Hi()}}const $t={hilitePrimary:{key:"hilitePrimary",color:"#3291ff",opacity:1,lineWidth:1},hiliteWhite:{key:"hiliteWhite",color:"#ffffff",opacity:1,lineWidth:1}};function xr(){const t=_("defs"),e=q(_("filter"),{id:"cg-filter-blur"});return e.appendChild(q(_("feGaussianBlur"),{stdDeviation:"0.019"})),t.appendChild(e),t}function Ar(t,e,n){var i;const r=t.drawable,o=r.current,s=o&&o.mouseSq?o:void 0,c=new Map,u=t.dom.bounds(),l=r.autoShapes.filter(k=>!k.piece);for(const k of r.shapes.concat(l).concat(s?[s]:[])){if(!k.dest)continue;const h=(i=c.get(k.dest))!==null&&i!==void 0?i:new Set,d=We(Fe(N(k.orig),t.orientation),u),w=We(Fe(N(k.dest),t.orientation),u);h.add(dt(d,w)),c.set(k.dest,h)}const p=r.shapes.concat(l).map(k=>({shape:k,current:!1,hash:Ht(k,ht(k.dest,c),!1,u)}));s&&p.push({shape:s,current:!0,hash:Ht(s,ht(s.dest,c),!0,u)});const f=p.map(k=>k.hash).join(";");if(f===t.drawable.prevSvgHash)return;t.drawable.prevSvgHash=f;const S=e.querySelector("defs");Or(r,p,S),Rr(p,e.querySelector("g"),n.querySelector("g"),k=>Tr(t,k,r.brushes,c,u))}function Or(t,e,n){var i;const r=new Map;let o;for(const u of e.filter(l=>l.shape.dest&&l.shape.brush))o=Hn(t.brushes[u.shape.brush],u.shape.modifiers),!((i=u.shape.modifiers)===null||i===void 0)&&i.hilite&&r.set(He(o).key,He(o)),r.set(o.key,o);const s=new Set;let c=n.firstElementChild;for(;c;)s.add(c.getAttribute("cgKey")),c=c.nextElementSibling;for(const[u,l]of r.entries())s.has(u)||n.appendChild(Kr(l))}function Rr(t,e,n,i){const r=new Map;for(const o of t)r.set(o.hash,!1);for(const o of[e,n]){const s=[];let c=o.firstElementChild,u;for(;c;)u=c.getAttribute("cgHash"),r.has(u)?r.set(u,!0):s.push(c),c=c.nextElementSibling;for(const l of s)o.removeChild(l)}for(const o of t.filter(s=>!r.get(s.hash)))for(const s of i(o))s.isCustom?n.appendChild(s.el):e.appendChild(s.el)}function Ht({orig:t,dest:e,brush:n,piece:i,modifiers:r,customSvg:o,label:s},c,u,l){var p,f;return[l.width,l.height,u,t,e,n,c&&"-",i&&zr(i),r&&Nr(r),o&&`custom-${Ft(o.html)},${(f=(p=o.center)===null||p===void 0?void 0:p[0])!==null&&f!==void 0?f:"o"}`,s&&`label-${Ft(s.text)}`].filter(S=>S).join(",")}function zr(t){return[t.color,t.role,t.scale].filter(e=>e).join(",")}function Nr(t){return[t.lineWidth,t.hilite&&"*"].filter(e=>e).join(",")}function Ft(t){let e=0;for(let n=0;n<t.length;n++)e=(e<<5)-e+t.charCodeAt(n)>>>0;return e.toString()}function Tr(t,{shape:e,current:n,hash:i},r,o,s){var c,u;const l=We(Fe(N(e.orig),t.orientation),s),p=e.dest?We(Fe(N(e.dest),t.orientation),s):l,f=e.brush&&Hn(r[e.brush],e.modifiers),S=o.get(e.dest),k=[];if(f){const h=q(_("g"),{cgHash:i});k.push({el:h}),l[0]!==p[0]||l[1]!==p[1]?h.appendChild(Dr(e,f,l,p,n,ht(e.dest,o))):h.appendChild(Br(r[e.brush],l,n,s))}if(e.label){const h=e.label;(c=h.fill)!==null&&c!==void 0||(h.fill=e.brush&&r[e.brush].color);const d=e.brush?void 0:"tr";k.push({el:_r(h,i,l,p,S,d),isCustom:!0})}if(e.customSvg){const h=(u=e.customSvg.center)!==null&&u!==void 0?u:"orig",[d,w]=h==="label"?Wn(l,p,S).map(y=>y-.5):h==="dest"?p:l,m=q(_("g"),{transform:`translate(${d},${w})`,cgHash:i});m.innerHTML=`<svg width="1" height="1" viewBox="0 0 100 100">${e.customSvg.html}</svg>`,k.push({el:m,isCustom:!0})}return k}function Br(t,e,n,i){const r=Lr(),o=(i.width+i.height)/(4*Math.max(i.width,i.height));return q(_("circle"),{stroke:t.color,"stroke-width":r[n?0:1],fill:"none",opacity:Fn(t,n),cx:e[0],cy:e[1],r:o-r[1]/2})}function He(t){return["#ffffff","#fff","white"].includes(t.color)?$t.hilitePrimary:$t.hiliteWhite}function Dr(t,e,n,i,r,o){var s;function c(p){var f;const S=Ir(o&&!r),k=i[0]-n[0],h=i[1]-n[1],d=Math.atan2(h,k),w=Math.cos(d)*S,m=Math.sin(d)*S;return q(_("line"),{stroke:p?He(e).color:e.color,"stroke-width":qr(e,r)+(p?.04:0),"stroke-linecap":"round","marker-end":`url(#arrowhead-${p?He(e).key:e.key})`,opacity:!((f=t.modifiers)===null||f===void 0)&&f.hilite?1:Fn(e,r),x1:n[0],y1:n[1],x2:i[0]-w,y2:i[1]-m})}if(!(!((s=t.modifiers)===null||s===void 0)&&s.hilite))return c(!1);const u=_("g"),l=q(_("g"),{filter:"url(#cg-filter-blur)"});return l.appendChild($r(n,i)),l.appendChild(c(!0)),u.appendChild(l),u.appendChild(c(!1)),u}function Kr(t){const e=q(_("marker"),{id:"arrowhead-"+t.key,orient:"auto",overflow:"visible",markerWidth:4,markerHeight:4,refX:t.key.startsWith("hilite")?1.86:2.05,refY:2});return e.appendChild(q(_("path"),{d:"M0,0 V4 L3,2 Z",fill:t.color})),e.setAttribute("cgKey",t.key),e}function _r(t,e,n,i,r,o){var s;const u=.4*.75**t.text.length,l=Wn(n,i,r),p=o==="tr"?.4:0,f=q(_("g"),{transform:`translate(${l[0]+p},${l[1]-p})`,cgHash:e});f.appendChild(q(_("circle"),{r:.4/2,"fill-opacity":o?1:.8,"stroke-opacity":o?1:.7,"stroke-width":.03,fill:(s=t.fill)!==null&&s!==void 0?s:"#666",stroke:"white"}));const S=q(_("text"),{"font-size":u,"font-family":"Noto Sans","text-anchor":"middle",fill:"white",y:.13*.75**t.text.length});return S.innerHTML=t.text,f.appendChild(S),f}function Fe(t,e){return e==="white"?t:[7-t[0],7-t[1]]}function ht(t,e){return(t&&e.has(t)&&e.get(t).size>1)===!0}function _(t){return document.createElementNS("http://www.w3.org/2000/svg",t)}function q(t,e){for(const n in e)Object.prototype.hasOwnProperty.call(e,n)&&t.setAttribute(n,e[n]);return t}function Hn(t,e){return e?{color:t.color,opacity:Math.round(t.opacity*10)/10,lineWidth:Math.round(e.lineWidth||t.lineWidth),key:[t.key,e.lineWidth].filter(n=>n).join("")}:t}function Lr(){return[3/64,4/64]}function qr(t,e){return(t.lineWidth||10)*(e?.85:1)/64}function Fn(t,e){return(t.opacity||1)*(e?.9:1)}function Ir(t){return(t?20:10)/64}function We(t,e){const n=Math.min(1,e.width/e.height),i=Math.min(1,e.height/e.width);return[(t[0]-3.5)*n,(3.5-t[1])*i]}function $r(t,e){const n={from:[Math.floor(Math.min(t[0],e[0])),Math.floor(Math.min(t[1],e[1]))],to:[Math.ceil(Math.max(t[0],e[0])),Math.ceil(Math.max(t[1],e[1]))]};return q(_("rect"),{x:n.from[0],y:n.from[1],width:n.to[0]-n.from[0],height:n.to[1]-n.from[1],fill:"none",stroke:"none"})}function dt(t,e,n=!0){const i=Math.atan2(e[1]-t[1],e[0]-t[0])+Math.PI;return n?(Math.round(i*8/Math.PI)+16)%16:i}function Hr(t,e){return Math.sqrt([t[0]-e[0],t[1]-e[1]].reduce((n,i)=>n+i*i,0))}function Wn(t,e,n){let i=Hr(t,e);const r=dt(t,e,!1);if(n&&(i-=33/64,n.size>1)){i-=10/64;const o=dt(t,e);(n.has((o+1)%16)||n.has((o+15)%16))&&o&1&&(i-=.4)}return[t[0]-Math.cos(r)*i,t[1]-Math.sin(r)*i].map(o=>o+.5)}function Fr(t,e){t.innerHTML="",t.classList.add("cg-wrap");for(const u of qi)t.classList.toggle("orientation-"+u,e.orientation===u);t.classList.toggle("manipulable",!e.viewOnly);const n=te("cg-container");t.appendChild(n);const i=te("cg-board");n.appendChild(i);let r,o,s;if(e.drawable.visible&&(r=q(_("svg"),{class:"cg-shapes",viewBox:"-4 -4 8 8",preserveAspectRatio:"xMidYMid slice"}),r.appendChild(xr()),r.appendChild(_("g")),o=q(_("svg"),{class:"cg-custom-svgs",viewBox:"-3.5 -3.5 8 8",preserveAspectRatio:"xMidYMid slice"}),o.appendChild(_("g")),s=te("cg-auto-pieces"),n.appendChild(r),n.appendChild(o),n.appendChild(s)),e.coordinates){const u=e.orientation==="black"?" black":"",l=e.ranksPosition==="left"?" left":"";if(e.coordinatesOnSquares){const p=e.orientation==="white"?f=>f+1:f=>8-f;qe.forEach((f,S)=>n.appendChild(Xe(Ie.map(k=>f+k),"squares rank"+p(S)+u+l)))}else n.appendChild(Xe(Ie,"ranks"+u+l)),n.appendChild(Xe(qe,"files"+u))}let c;return e.draggable.enabled&&e.draggable.showGhost&&(c=te("piece","ghost"),vt(c,!1),n.appendChild(c)),{board:i,container:n,wrap:t,ghost:c,svg:r,customSvg:o,autoPieces:s}}function Xe(t,e){const n=te("coords",e);let i;for(const r of t)i=te("coord"),i.textContent=r,n.appendChild(i);return n}function Wr(t,e){if(!t.dropmode.active)return;ae(t),le(t);const n=t.dropmode.piece;if(n){t.pieces.set("a0",n);const i=pe(e),r=i&&me(i,H(t),t.dom.bounds());r&&On(t,"a0",r)}t.dom.redraw()}function Gr(t,e){const n=t.dom.elements.board;if("ResizeObserver"in window&&new ResizeObserver(e).observe(t.dom.elements.wrap),(t.disableContextMenu||t.drawable.enabled)&&n.addEventListener("contextmenu",r=>r.preventDefault()),t.viewOnly)return;const i=jr(t);n.addEventListener("touchstart",i,{passive:!1}),n.addEventListener("mousedown",i,{passive:!1})}function Ur(t,e){const n=[];if("ResizeObserver"in window||n.push(Pe(document.body,"chessground.resize",e)),!t.viewOnly){const i=Wt(t,Cr,pr),r=Wt(t,Pr,mr);for(const s of["touchmove","mousemove"])n.push(Pe(document,s,i));for(const s of["touchend","mouseup"])n.push(Pe(document,s,r));const o=()=>t.dom.bounds.clear();n.push(Pe(document,"scroll",o,{capture:!0,passive:!0})),n.push(Pe(window,"resize",o,{passive:!0}))}return()=>n.forEach(i=>i())}function Pe(t,e,n,i){return t.addEventListener(e,n,i),()=>t.removeEventListener(e,n,i)}const jr=t=>e=>{t.draggable.current?$e(t):t.drawable.current?Ln(t):e.shiftKey||bn(e)?t.drawable.enabled&&fr(t,e):t.viewOnly||(t.dropmode.active?Wr(t,e):br(t,e))},Wt=(t,e,n)=>i=>{t.drawable.current?t.drawable.enabled&&n(t,i):t.viewOnly||e(t,i)};function Qr(t){const e=H(t),n=ze(t.dom.bounds()),i=t.dom.elements.board,r=t.pieces,o=t.animation.current,s=o?o.plan.anims:new Map,c=o?o.plan.fadings:new Map,u=t.draggable.current,l=Xr(t),p=new Set,f=new Set,S=new Map,k=new Map;let h,d,w,m,y,M,C,P,E,x;for(d=i.firstChild;d;){if(h=d.cgKey,Gn(d))if(w=r.get(h),y=s.get(h),M=c.get(h),m=d.cgPiece,d.cgDragging&&(!u||u.orig!==h)&&(d.classList.remove("dragging"),X(d,n(N(h),e)),d.cgDragging=!1),!M&&d.cgFading&&(d.cgFading=!1,d.classList.remove("fading")),w){if(y&&d.cgAnimating&&m===Ee(w)){const b=N(h);b[0]+=y[2],b[1]+=y[3],d.classList.add("anim"),X(d,n(b,e))}else d.cgAnimating&&(d.cgAnimating=!1,d.classList.remove("anim"),X(d,n(N(h),e)),t.addPieceZIndex&&(d.style.zIndex=Ye(N(h),e)));m===Ee(w)&&(!M||!d.cgFading)?p.add(h):M&&m===Ee(M)?(d.classList.add("fading"),d.cgFading=!0):Ve(S,m,d)}else Ve(S,m,d);else if(Un(d)){const b=d.className;l.get(h)===b?f.add(h):Ve(k,b,d)}d=d.nextSibling}for(const[b,O]of l)if(!f.has(b)){E=k.get(O),x=E&&E.pop();const z=n(N(b),e);if(x)x.cgKey=b,X(x,z);else{const R=te("square",O);R.cgKey=b,X(R,z),i.insertBefore(R,i.firstChild)}}for(const[b,O]of r)if(y=s.get(b),!p.has(b))if(C=S.get(Ee(O)),P=C&&C.pop(),P){P.cgKey=b,P.cgFading&&(P.classList.remove("fading"),P.cgFading=!1);const z=N(b);t.addPieceZIndex&&(P.style.zIndex=Ye(z,e)),y&&(P.cgAnimating=!0,P.classList.add("anim"),z[0]+=y[2],z[1]+=y[3]),X(P,n(z,e))}else{const z=Ee(O),R=te("piece",z),D=N(b);R.cgPiece=z,R.cgKey=b,y&&(R.cgAnimating=!0,D[0]+=y[2],D[1]+=y[3]),X(R,n(D,e)),t.addPieceZIndex&&(R.style.zIndex=Ye(D,e)),i.appendChild(R)}for(const b of S.values())Ut(t,b);for(const b of k.values())Ut(t,b)}function Zr(t){const e=H(t),n=ze(t.dom.bounds());let i=t.dom.elements.board.firstChild;for(;i;)(Gn(i)&&!i.cgAnimating||Un(i))&&X(i,n(N(i.cgKey),e)),i=i.nextSibling}function Gt(t){var e,n;const i=t.dom.elements.wrap.getBoundingClientRect(),r=t.dom.elements.container,o=i.height/i.width,s=Math.floor(i.width*window.devicePixelRatio/8)*8/window.devicePixelRatio,c=s*o;r.style.width=s+"px",r.style.height=c+"px",t.dom.bounds.clear(),(e=t.addDimensionsCssVarsTo)===null||e===void 0||e.style.setProperty("---cg-width",s+"px"),(n=t.addDimensionsCssVarsTo)===null||n===void 0||n.style.setProperty("---cg-height",c+"px")}const Gn=t=>t.tagName==="PIECE",Un=t=>t.tagName==="SQUARE";function Ut(t,e){for(const n of e)t.dom.elements.board.removeChild(n)}function Ye(t,e){const i=t[1];return`${e?10-i:3+i}`}const Ee=t=>`${t.color} ${t.role}`;function Xr(t){var e,n,i;const r=new Map;if(t.lastMove&&t.highlight.lastMove)for(const c of t.lastMove)J(r,c,"last-move");if(t.check&&t.highlight.check&&J(r,t.check,"check"),t.selected&&(J(r,t.selected,"selected"),t.movable.showDests)){const c=(e=t.movable.dests)===null||e===void 0?void 0:e.get(t.selected);if(c)for(const l of c)J(r,l,"move-dest"+(t.pieces.has(l)?" oc":""));const u=(i=(n=t.premovable.customDests)===null||n===void 0?void 0:n.get(t.selected))!==null&&i!==void 0?i:t.premovable.dests;if(u)for(const l of u)J(r,l,"premove-dest"+(t.pieces.has(l)?" oc":""))}const o=t.premovable.current;if(o)for(const c of o)J(r,c,"current-premove");else t.predroppable.current&&J(r,t.predroppable.current.key,"current-premove");const s=t.exploding;if(s)for(const c of s.keys)J(r,c,"exploding"+s.stage);return t.highlight.custom&&t.highlight.custom.forEach((c,u)=>{J(r,u,c)}),r}function J(t,e,n){const i=t.get(e);i?t.set(e,`${i} ${n}`):t.set(e,n)}function Ve(t,e,n){const i=t.get(e);i?i.push(n):t.set(e,[n])}function Yr(t,e,n){const i=new Map,r=[];for(const c of t)i.set(c.hash,!1);let o=e.firstElementChild,s;for(;o;)s=o.getAttribute("cgHash"),i.has(s)?i.set(s,!0):r.push(o),o=o.nextElementSibling;for(const c of r)e.removeChild(c);for(const c of t)i.get(c.hash)||e.appendChild(n(c))}function Vr(t,e){const i=t.drawable.autoShapes.filter(r=>r.piece).map(r=>({shape:r,hash:to(r),current:!1}));Yr(i,e,r=>eo(t,r,t.dom.bounds()))}function Jr(t){var e;const n=H(t),i=ze(t.dom.bounds());let r=(e=t.dom.elements.autoPieces)===null||e===void 0?void 0:e.firstChild;for(;r;)wn(r,i(N(r.cgKey),n),r.cgScale),r=r.nextSibling}function eo(t,{shape:e,hash:n},i){var r,o,s;const c=e.orig,u=(r=e.piece)===null||r===void 0?void 0:r.role,l=(o=e.piece)===null||o===void 0?void 0:o.color,p=(s=e.piece)===null||s===void 0?void 0:s.scale,f=te("piece",`${u} ${l}`);return f.setAttribute("cgHash",n),f.cgKey=c,f.cgScale=p,wn(f,ze(i)(N(c),H(t)),p),f}const to=t=>{var e,n,i;return[t.orig,(e=t.piece)===null||e===void 0?void 0:e.role,(n=t.piece)===null||n===void 0?void 0:n.color,(i=t.piece)===null||i===void 0?void 0:i.scale].join(",")};function no(t,e){const n=Mr();Dn(n,e||{});function i(){const r="dom"in n?n.dom.unbind:void 0,o=Fr(t,n),s=$i(()=>o.board.getBoundingClientRect()),c=p=>{Qr(l),o.autoPieces&&Vr(l,o.autoPieces),!p&&o.svg&&Ar(l,o.svg,o.customSvg)},u=()=>{Gt(l),Zr(l),o.autoPieces&&Jr(l)},l=n;return l.dom={elements:o,bounds:s,redraw:io(c),redrawNow:c,unbind:r},l.drawable.prevSvgHash="",Gt(l),c(!1),Gr(l,u),r||(l.dom.unbind=Ur(l,u)),l.events.insert&&l.events.insert(o),l}return Sr(i(),i)}function io(t){let e=!1;return()=>{e||(e=!0,requestAnimationFrame(()=>{t(),e=!1}))}}function ro(t,e){return document.createElement(t,e)}function oo(t,e,n){return document.createElementNS(t,e,n)}function so(){return he(document.createDocumentFragment())}function co(t){return document.createTextNode(t)}function ao(t){return document.createComment(t)}function lo(t,e,n){if(ne(t)){let i=t;for(;i&&ne(i);)i=he(i).parent;t=i??t}ne(e)&&(e=he(e,t)),n&&ne(n)&&(n=he(n).firstChildNode),t.insertBefore(e,n)}function uo(t,e){t.removeChild(e)}function ho(t,e){ne(e)&&(e=he(e,t)),t.appendChild(e)}function jn(t){if(ne(t)){for(;t&&ne(t);)t=he(t).parent;return t??null}return t.parentNode}function fo(t){var e;if(ne(t)){const n=he(t),i=jn(n);if(i&&n.lastChildNode){const r=Array.from(i.childNodes),o=r.indexOf(n.lastChildNode);return(e=r[o+1])!==null&&e!==void 0?e:null}return null}return t.nextSibling}function po(t){return t.tagName}function mo(t,e){t.textContent=e}function go(t){return t.textContent}function ko(t){return t.nodeType===1}function wo(t){return t.nodeType===3}function bo(t){return t.nodeType===8}function ne(t){return t.nodeType===11}function he(t,e){var n,i,r;const o=t;return(n=o.parent)!==null&&n!==void 0||(o.parent=e??null),(i=o.firstChildNode)!==null&&i!==void 0||(o.firstChildNode=t.firstChild),(r=o.lastChildNode)!==null&&r!==void 0||(o.lastChildNode=t.lastChild),o}const vo={createElement:ro,createElementNS:oo,createTextNode:co,createDocumentFragment:so,createComment:ao,insertBefore:lo,removeChild:uo,appendChild:ho,parentNode:jn,nextSibling:fo,tagName:po,setTextContent:mo,getTextContent:go,isElement:ko,isText:wo,isComment:bo,isDocumentFragment:ne};function Oe(t,e,n,i,r){const o=e===void 0?void 0:e.key;return{sel:t,data:e,children:n,text:i,elm:r,key:o}}const Ge=Array.isArray;function Be(t){return typeof t=="string"||typeof t=="number"||t instanceof String||t instanceof Number}function Te(t){return t===void 0}function I(t){return t!==void 0}const Je=Oe("",{},[],void 0,void 0);function Se(t,e){var n,i;const r=t.key===e.key,o=((n=t.data)===null||n===void 0?void 0:n.is)===((i=e.data)===null||i===void 0?void 0:i.is),s=t.sel===e.sel,c=!t.sel&&t.sel===e.sel?typeof t.text==typeof e.text:!0;return s&&r&&o&&c}function yo(){throw new Error("The document fragment is not supported on this platform.")}function Co(t,e){return t.isElement(e)}function Po(t,e){return t.isDocumentFragment(e)}function Eo(t,e,n){var i;const r={};for(let o=e;o<=n;++o){const s=(i=t[o])===null||i===void 0?void 0:i.key;s!==void 0&&(r[s]=o)}return r}const So=["create","update","remove","destroy","pre","post"];function Mo(t,e,n){const i={create:[],update:[],remove:[],destroy:[],pre:[],post:[]},r=vo;for(const h of So)for(const d of t){const w=d[h];w!==void 0&&i[h].push(w)}function o(h){const d=h.id?"#"+h.id:"",w=h.getAttribute("class"),m=w?"."+w.split(" ").join("."):"";return Oe(r.tagName(h).toLowerCase()+d+m,{},[],void 0,h)}function s(h){return Oe(void 0,{},[],void 0,h)}function c(h,d){return function(){if(--d===0){const m=r.parentNode(h);m!==null&&r.removeChild(m,h)}}}function u(h,d){var w,m,y,M;let C,P=h.data;if(P!==void 0){const b=(w=P.hook)===null||w===void 0?void 0:w.init;I(b)&&(b(h),P=h.data)}const E=h.children,x=h.sel;if(x==="!")Te(h.text)&&(h.text=""),h.elm=r.createComment(h.text);else if(x==="")h.elm=r.createTextNode(h.text);else if(x!==void 0){const b=x.indexOf("#"),O=x.indexOf(".",b),z=b>0?b:x.length,R=O>0?O:x.length,D=b!==-1||O!==-1?x.slice(0,Math.min(z,R)):x,j=h.elm=I(P)&&I(C=P.ns)?r.createElementNS(C,D,P):r.createElement(D,P);for(z<R&&j.setAttribute("id",x.slice(z+1,R)),O>0&&j.setAttribute("class",x.slice(R+1).replace(/\./g," ")),C=0;C<i.create.length;++C)i.create[C](Je,h);if(Be(h.text)&&(!Ge(E)||E.length===0)&&r.appendChild(j,r.createTextNode(h.text)),Ge(E))for(C=0;C<E.length;++C){const xt=E[C];xt!=null&&r.appendChild(j,u(xt,d))}const Ne=h.data.hook;I(Ne)&&((m=Ne.create)===null||m===void 0||m.call(Ne,Je,h),Ne.insert&&d.push(h))}else if(!((y=void 0)===null||y===void 0)&&y.fragments&&h.children){for(h.elm=((M=r.createDocumentFragment)!==null&&M!==void 0?M:yo)(),C=0;C<i.create.length;++C)i.create[C](Je,h);for(C=0;C<h.children.length;++C){const b=h.children[C];b!=null&&r.appendChild(h.elm,u(b,d))}}else h.elm=r.createTextNode(h.text);return h.elm}function l(h,d,w,m,y,M){for(;m<=y;++m){const C=w[m];C!=null&&r.insertBefore(h,u(C,M),d)}}function p(h){var d,w;const m=h.data;if(m!==void 0){(w=(d=m==null?void 0:m.hook)===null||d===void 0?void 0:d.destroy)===null||w===void 0||w.call(d,h);for(let y=0;y<i.destroy.length;++y)i.destroy[y](h);if(h.children!==void 0)for(let y=0;y<h.children.length;++y){const M=h.children[y];M!=null&&typeof M!="string"&&p(M)}}}function f(h,d,w,m){for(var y,M;w<=m;++w){let C,P;const E=d[w];if(E!=null)if(I(E.sel)){p(E),C=i.remove.length+1,P=c(E.elm,C);for(let b=0;b<i.remove.length;++b)i.remove[b](E,P);const x=(M=(y=E==null?void 0:E.data)===null||y===void 0?void 0:y.hook)===null||M===void 0?void 0:M.remove;I(x)?x(E,P):P()}else E.children?(p(E),f(h,E.children,0,E.children.length-1)):r.removeChild(h,E.elm)}}function S(h,d,w,m){let y=0,M=0,C=d.length-1,P=d[0],E=d[C],x=w.length-1,b=w[0],O=w[x],z,R,D,j;for(;y<=C&&M<=x;)P==null?P=d[++y]:E==null?E=d[--C]:b==null?b=w[++M]:O==null?O=w[--x]:Se(P,b)?(k(P,b,m),P=d[++y],b=w[++M]):Se(E,O)?(k(E,O,m),E=d[--C],O=w[--x]):Se(P,O)?(k(P,O,m),r.insertBefore(h,P.elm,r.nextSibling(E.elm)),P=d[++y],O=w[--x]):Se(E,b)?(k(E,b,m),r.insertBefore(h,E.elm,P.elm),E=d[--C],b=w[++M]):(z===void 0&&(z=Eo(d,y,C)),R=z[b.key],Te(R)?(r.insertBefore(h,u(b,m),P.elm),b=w[++M]):Te(z[O.key])?(r.insertBefore(h,u(O,m),r.nextSibling(E.elm)),O=w[--x]):(D=d[R],D.sel!==b.sel?r.insertBefore(h,u(b,m),P.elm):(k(D,b,m),d[R]=void 0,r.insertBefore(h,D.elm,P.elm)),b=w[++M]));M<=x&&(j=w[x+1]==null?null:w[x+1].elm,l(h,j,w,M,x,m)),y<=C&&f(h,d,y,C)}function k(h,d,w){var m,y,M,C,P,E,x,b;const O=(m=d.data)===null||m===void 0?void 0:m.hook;(y=O==null?void 0:O.prepatch)===null||y===void 0||y.call(O,h,d);const z=d.elm=h.elm;if(h===d)return;if(d.data!==void 0||I(d.text)&&d.text!==h.text){(M=d.data)!==null&&M!==void 0||(d.data={}),(C=h.data)!==null&&C!==void 0||(h.data={});for(let j=0;j<i.update.length;++j)i.update[j](h,d);(x=(E=(P=d.data)===null||P===void 0?void 0:P.hook)===null||E===void 0?void 0:E.update)===null||x===void 0||x.call(E,h,d)}const R=h.children,D=d.children;Te(d.text)?I(R)&&I(D)?R!==D&&S(z,R,D,w):I(D)?(I(h.text)&&r.setTextContent(z,""),l(z,null,D,0,D.length-1,w)):I(R)?f(z,R,0,R.length-1):I(h.text)&&r.setTextContent(z,""):h.text!==d.text&&(I(R)&&f(z,R,0,R.length-1),r.setTextContent(z,d.text)),(b=O==null?void 0:O.postpatch)===null||b===void 0||b.call(O,h,d)}return function(d,w){let m,y,M;const C=[];for(m=0;m<i.pre.length;++m)i.pre[m]();for(Co(r,d)?d=o(d):Po(r,d)&&(d=s(d)),Se(d,w)?k(d,w,C):(y=d.elm,M=r.parentNode(y),u(w,C),M!==null&&(r.insertBefore(M,w.elm,r.nextSibling(y)),f(M,[d],0,0))),m=0;m<C.length;++m)C[m].data.hook.insert(C[m]);for(m=0;m<i.post.length;++m)i.post[m]();return w}}function Qn(t,e,n){if(t.ns="http://www.w3.org/2000/svg",n!=="foreignObject"&&e!==void 0)for(let i=0;i<e.length;++i){const r=e[i];if(typeof r=="string")continue;const o=r.data;o!==void 0&&Qn(o,r.children,r.sel)}}function be(t,e,n){let i={},r,o,s;if(n!==void 0?(e!==null&&(i=e),Ge(n)?r=n:Be(n)?o=n.toString():n&&n.sel&&(r=[n])):e!=null&&(Ge(e)?r=e:Be(e)?o=e.toString():e&&e.sel?r=[e]:i=e),r!==void 0)for(s=0;s<r.length;++s)Be(r[s])&&(r[s]=Oe(void 0,void 0,void 0,r[s],void 0));return t.startsWith("svg")&&(t.length===3||t[3]==="."||t[3]==="#")&&Qn(i,r,t),Oe(t,i,r,o,void 0)}const xo="http://www.w3.org/1999/xlink",Ao="http://www.w3.org/2000/xmlns/",Oo="http://www.w3.org/XML/1998/namespace",jt=58,Ro=120,zo=109;function Qt(t,e){let n;const i=e.elm;let r=t.data.attrs,o=e.data.attrs;if(!(!r&&!o)&&r!==o){r=r||{},o=o||{};for(n in o){const s=o[n];r[n]!==s&&(s===!0?i.setAttribute(n,""):s===!1?i.removeAttribute(n):n.charCodeAt(0)!==Ro?i.setAttribute(n,s):n.charCodeAt(3)===jt?i.setAttributeNS(Oo,n,s):n.charCodeAt(5)===jt?n.charCodeAt(1)===zo?i.setAttributeNS(Ao,n,s):i.setAttributeNS(xo,n,s):i.setAttribute(n,s))}for(n in r)n in o||i.removeAttribute(n)}}const No={create:Qt,update:Qt};function Zt(t,e){let n,i;const r=e.elm;let o=t.data.class,s=e.data.class;if(!(!o&&!s)&&o!==s){o=o||{},s=s||{};for(i in o)o[i]&&!Object.prototype.hasOwnProperty.call(s,i)&&r.classList.remove(i);for(i in s)n=s[i],n!==o[i]&&r.classList[n?"add":"remove"](i)}}const To={create:Zt,update:Zt};function Zn(t,e,n){if(typeof t=="function")t.call(e,n,e);else if(typeof t=="object")for(let i=0;i<t.length;i++)Zn(t[i],e,n)}function Bo(t,e){const n=t.type,i=e.data.on;i&&i[n]&&Zn(i[n],e,t)}function Do(){return function t(e){Bo(e,t.vnode)}}function et(t,e){const n=t.data.on,i=t.listener,r=t.elm,o=e&&e.data.on,s=e&&e.elm;let c;if(n!==o){if(n&&i)if(o)for(c in n)o[c]||r.removeEventListener(c,i,!1);else for(c in n)r.removeEventListener(c,i,!1);if(o){const u=e.listener=t.listener||Do();if(u.vnode=e,n)for(c in o)n[c]||s.addEventListener(c,u,!1);else for(c in o)s.addEventListener(c,u,!1)}}}const Ko={create:et,update:et,destroy:et},Xt=typeof(window==null?void 0:window.requestAnimationFrame)=="function"?window.requestAnimationFrame.bind(window):setTimeout,_o=function(t){Xt(function(){Xt(t)})};let ft=!1;function Lo(t,e,n){_o(function(){t[e]=n})}function Yt(t,e){let n,i;const r=e.elm;let o=t.data.style,s=e.data.style;if(!o&&!s||o===s)return;o=o||{},s=s||{};const c="delayed"in o;for(i in o)i in s||(i[0]==="-"&&i[1]==="-"?r.style.removeProperty(i):r.style[i]="");for(i in s)if(n=s[i],i==="delayed"&&s.delayed)for(const u in s.delayed)n=s.delayed[u],(!c||n!==o.delayed[u])&&Lo(r.style,u,n);else i!=="remove"&&n!==o[i]&&(i[0]==="-"&&i[1]==="-"?r.style.setProperty(i,n):r.style[i]=n)}function qo(t){let e,n;const i=t.elm,r=t.data.style;if(!(!r||!(e=r.destroy)))for(n in e)i.style[n]=e[n]}function Io(t,e){const n=t.data.style;if(!n||!n.remove){e();return}ft||(t.elm.offsetLeft,ft=!0);let i;const r=t.elm;let o=0;const s=n.remove;let c=0;const u=[];for(i in s)u.push(i),r.style[i]=s[i];const p=getComputedStyle(r)["transition-property"].split(", ");for(;o<p.length;++o)u.indexOf(p[o])!==-1&&c++;r.addEventListener("transitionend",function(f){f.target===r&&--c,c===0&&e()})}function $o(){ft=!1}const Ho={pre:$o,create:Yt,update:Yt,destroy:qo,remove:Io};function Fo(t){return{insert:e=>t(e.elm)}}function Vt(t){return be("div.blue.merida",{attrs:{tabindex:0},class:{darken:t.isPromotionPromptOpened()},hook:Fo(e=>{t.setGround(no(e.querySelector(".cg-wrap"),Uo(t,e)))})},[Wo(t)])}const Wo=t=>be("div.lpv__board",be("div.cg-wrap",{class:{"cg-promotion":t.isPromotionPromptOpened(),"cg-promotion--open":t.isPromotionPromptOpened()},on:{click:()=>{t.isPromotionPromptOpened()&&t.cancelPromotion()}}},t.isPromotionPromptOpened()?Go(t):void 0)),Go=t=>{const e=["queen","knight","rook","bishop"],n=t.getPromotionDest(),i=t.getPromotionColor(),r=t.cgState().orientation;let o=n.charCodeAt(0)-97,s=i=="white"?0:7,c=i=="white"?1:-1;return r=="black"&&(o=7-o,s=7-s,c*=-1),e.map((l,p)=>be("cg-board",be("square.blue.merida",{style:{top:`${(s+p*c)*12.5}%`,left:`${o*12.5}%`},on:{click:()=>t.resolvePromotion(l)}},be(`piece.${i}.${l}`))))};function Uo(t,e){return{viewOnly:!1,addDimensionsCssVarsTo:e,animation:{enabled:!0,duration:300},drawable:{enabled:!0,visible:!0},disableContextMenu:!0,movable:{free:!1},draggable:{enabled:!0},selectable:{enabled:!0},...t.cgState()}}function Xn(t,e){const n=Mo([To,No,Ho,Ko]),i=new Li(e,s),r=Vt(i);t.innerHTML="";let o=n(t,r);function s(){o=n(o,Vt(i))}return i}Xn(document.getElementById("puzzle1"),`[FEN "5r2/2R2P1k/7p/4q3/7K/8/6Q1/8 w - - 0 1"]

1. Qg8+ Rxg8 2. f8=N+ Kh8 3. Rh7#`);Xn(document.getElementById("puzzle2"),`[FEN "8/8/2pqp3/2Q2pkp/3P2p1/4P1P1/4KPP1/8 b - - 3 43"]

 Qxc5 dxc5 Kf6 f4 gxf3+ Kxf3 Ke5`);
